---
title: 'AJAE appendix B for: Agricultural Insurance Loss and Relationships to Climate across the Inland Pacific Northwest Region of the United States'
author: "Erich Seamon, Paul E. Gessler, John T. Abatzoglou, Philip W. Mote, Stephen S. Lee"
date: "September 2019"
subtitle: 'The material contained herein is supplementary to the article named in the title and published in the American Journal of Agricultural Economics (AJAE).'
always_allow_html: yes
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
output:
  pdf_document: default
  html_document:
    css: custom.css
    code_folding: hide
    highlight: textmate
    theme: united
    toc: true
    toc_float: true
params: null
mainfont: serif
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, fig.align = "center", out.width='400px', out.height='700px', dpi=400, dev = "cairo_pdf")

#rmarkdown::render(input = "/dmine/code/git/seamon_dissertation/appendices/seamon_PHD_appendix_B.Rmd", output_file = paste("/dmine/code/git/seamon_dissertation/appendices/seamon_PHD_appendix_B.html", sep=""))

usePackage <- function(p) {
    if (!is.element(p, installed.packages()[,1]))
        install.packages(p, dep = TRUE, repos = "http://cran.us.r-project.org")
    require(p, character.only = TRUE)
}

usePackage("extrafont")
usePackage("ggplot2")
usePackage("webshot")
#webshot::install_phantomjs()
loadfonts()

```


Appendix B documents supplemental Principle Components Analyses (PCA) for the Pacific Northwest (PNW) and the inland Pacific Northwest (iPNW), to better understand the combined effects of differing damage causes, commodities, counties, and years on overall loss. 

**1. Supplemental Pacific Northwest (PNW) Exploratory Data Analysis**  In this section we outline a multitude of PCA outputs for the entire three state Pacific Norwest region (Oregon, Idaho, and Washington).
<br></br>

**2. Supplemental Inland Pacific Northwest(iPNW) Exploratory Data Analysis**  Here we outline a multitude of PCA outputs for the 24 county iPNW Pacific Norwest region.
<br></br>

**3. Supplemental Pacific Northwest (PNW) Principle Components Analysis**  In this section we outline a multitude of PCA outputs for the entire three state Pacific Norwest region (Oregon, Idaho, and Washington).
<br></br>

**4. Supplemental Inland Pacific Northwest(iPNW) Principle Components Analysis**  Here we outline a multitude of PCA outputs for the 24 county iPNW Pacific Norwest region.

\newpage

## Supplemental Tables List

Table 1. USDA RMA insurance loss records that were acquired from the USDA Risk Management Agency (RMA).  Each record represents an individual insurance claim.
<br></br>

Table 2. USDA RMA aggregated dataset derived from the original insurance loss files. Here we have summarized claims by year, county, commodity, and damage cause.  Each unique combination is summarized, which echos the total summarized loss, the number of claims, the total summarized acreage, loss per acre, loss per claim, and acres per claim.  This dataset was the basis for our data examination.
<br></br>


\newpage

## Supplemental Figures List


Figure 1. Pacific Northwest (PNW) three state study area
<br></br>

Figure 2. Pacific Northwest agricultural insurance loss by year, 1989 to 2015.
<br></br>

Figure 3. Pacific Northwest agricultural insurance loss by damage cause: 1989 to 2015
<br></br>

Figure 4. Pacific Northwest agricultural insurance loss by damage cause: 2001 to 2015
<br></br>

Figure 5. Pacific Northwest agricultural insurance loss by commodity: 2001 to 2015
<br></br>

Figure 6. Pacific Northwest agricultural insurance loss by year: 2001 to 2015
<br></br>

Figure 7. Pacific Northwest agricultural insurance loss claim frequency by commodity: 2001 to 2015.  Each point represents a Pacific Northwest county.
<br></br>

Figure 8. Pacific Northwest agricultural  total insurance loss by year: 2001 to 2015
<br></br>

Figure 2. Principle Components: PNW insurance loss, by county with commodity loadings: 2001 to 2015
<br></br>

Figure 3. Principle Components: PNW insurance loss, by year with damage cause loadings: 2001 to 2015
<br></br>

Figure 4. Principle Components: PNW insurance loss, by month with damage cause loadings: 2001 to 2015
<br></br>

Figure 5. Principle Components: PNW wheat insurance loss, by year with damage cause loadings: 2001 to 2015
<br></br>

Figure 6. Principle Components: PNW wheat insurance loss, by county with damage cause loadings: 2001 to 2015
<br></br>

Figure 7. Principle Components: PNW apples insurance loss, by county with damage cause loadings: 2001 to 2015
<br></br>

Figure 8. Principle Components: PNW barley insurance loss, by county with damage cause loadings: 2001 to 2015

Figure 9. 24-county inland Pacific Northwest (iPNW) study area.
<br></br>

Figure 10. Principle Components: iPNW insurance loss by county with damage cause loadings: 2001 to 2015: all commodities
<br></br>

Figure 11. Principle Components: iPNW wheat insurance loss, by county with damage cause loadings: 2001 to 2015: kmeans clustering
<br></br>

Figure 12. Principle Components: iPNW wheat insurance loss by county with damage cause loadings: PC1 and PC2 table
<br></br>

Figure 13. Principle Components: iPNW wheat loss by county with damage cause loadings: Spatial Mapping of PC1 and PC2
<br></br>

Figure 14. Principle Components: iPNW wheat insurance loss, by year with damage cause loadings: 2001 to 2015: kmeans clustering
<br></br>

Figure 15. Principle Components: iPNW wheat insurance loss, by year with damage cause loadings: 2001 to 2015: PC1 vs PC2 barplot
<br></br>

Figure 16. Principle Components: iPNW wheat insurance loss by year with damage cause loadings: PC1 and PC2 table
<br></br>

Figure 17. Principle Components: experimental PCA + kmeans: IPNW wheat insurance loss by county with damage cause loadings: 2001 TO 2015
<br></br>


```{r message=FALSE, warning=FALSE, echo = FALSE}

dir.create("/tmp/seamon")

download.file("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/seamon_dissertation_dataload.R", destfile = "/tmp/seamon/dataload.R")

usePackage("RCurl")
source("/tmp/seamon/dataload.R", local=FALSE)

```

```{r message=FALSE, warning=FALSE, echo=FALSE}

usePackage("knitr")
usePackage("tab")
usePackage("car")
usePackage("RCurl")
usePackage("lme4")
usePackage("ez")
usePackage("lattice")
usePackage("ggplot2")
usePackage("coefplot2")
usePackage("broom")
usePackage("htmlTable")
usePackage("gridExtra")
usePackage("kableExtra")
usePackage("repmis")



#options(scipen=999)


#------add crop insurance data

#URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/RMA_originaldata_txt.zip"
#destfile <- "/tmp/seamon/RMA_originaldata_txt.zip"
#download.file(URL, destfile)
#outDir<-"/tmp/seamon/RMA_originaldata/"
#unzip(destfile,exdir=outDir)


rma1989 <- read.csv("/tmp/seamon/RMA_originaldata/1989.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma1990 <- read.csv("/tmp/seamon/RMA_originaldata/1990.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma1991 <- read.csv("/tmp/seamon/RMA_originaldata/1991.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma1992 <- read.csv("/tmp/seamon/RMA_originaldata/1992.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma1993 <- read.csv("/tmp/seamon/RMA_originaldata/1993.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma1994 <- read.csv("/tmp/seamon/RMA_originaldata/1994.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma1995 <- read.csv("/tmp/seamon/RMA_originaldata/1995.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma1996 <- read.csv("/tmp/seamon/RMA_originaldata/1996.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma1997 <- read.csv("/tmp/seamon/RMA_originaldata/1997.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma1998 <- read.csv("/tmp/seamon/RMA_originaldata/1998.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma1999 <- read.csv("/tmp/seamon/RMA_originaldata/1999.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2000 <- read.csv("/tmp/seamon/RMA_originaldata/2000.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2001 <- read.csv("/tmp/seamon/RMA_originaldata/2001.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2002 <- read.csv("/tmp/seamon/RMA_originaldata/2002.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2003 <- read.csv("/tmp/seamon/RMA_originaldata/2003.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2004 <- read.csv("/tmp/seamon/RMA_originaldata/2004.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2005 <- read.csv("/tmp/seamon/RMA_originaldata/2005.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2006 <- read.csv("/tmp/seamon/RMA_originaldata/2006.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2007 <- read.csv("/tmp/seamon/RMA_originaldata/2007.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2008 <- read.csv("/tmp/seamon/RMA_originaldata/2008.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2009 <- read.csv("/tmp/seamon/RMA_originaldata/2009.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2010 <- read.csv("/tmp/seamon/RMA_originaldata/2010.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2011 <- read.csv("/tmp/seamon/RMA_originaldata/2011.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2012 <- read.csv("/tmp/seamon/RMA_originaldata/2012.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2013 <- read.csv("/tmp/seamon/RMA_originaldata/2013.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2014 <- read.csv("/tmp/seamon/RMA_originaldata/2014.txt", sep = "|", header = FALSE, strip.white = TRUE)
rma2015 <- read.csv("/tmp/seamon/RMA_originaldata/2015.txt", sep = "|", header = FALSE, strip.white = TRUE)


#load individual files from 1989 to 2000
RMA_1989 <- rbind(rma1989, rma1990, rma1991, rma1992, rma1993, rma1994, rma1995, rma1996, rma1997, rma1998, rma1999, rma2000)

#filter columns
RMA_1989 <- data.frame(RMA_1989[,1], RMA_1989[,3], RMA_1989[,5], RMA_1989[,7], RMA_1989[,12], RMA_1989[,13], RMA_1989[,14], RMA_1989[,15])

#set column names
colnames(RMA_1989) <- c("year", "state", "county", "commodity", "damagecause", "monthcode", "month", "loss")

#load individual files from 2001 to 2015
RMA <- rbind(rma2001, rma2002, rma2003, rma2004, rma2005, rma2006, rma2007, rma2008, rma2009, rma2010, rma2011, rma2012, rma2013, rma2014, rma2015)

#filter columns
RMA <- data.frame(RMA[,1], RMA[,3], RMA[,5], RMA[,7], RMA[,12], RMA[,13], RMA[,14], RMA[,15], RMA[,16])

#set column names
colnames(RMA) <- c("year", "state", "county", "commodity", "damagecause", "monthcode", "month", "acres", "loss")

#subset 2001 to 2015 for ID, WA, and OR
RMA_PNW <- subset(RMA, state == "WA" | state == "OR" | state == "ID" )

#subset 1989 to 2000 for ID, WA, and OR
RMA_PNW_1989 <- subset(RMA_1989, state == "WA" | state == "OR" | state == "ID" )

#calculate loss per acre
RMA_PNW$lossperacre <- RMA_PNW$loss / RMA_PNW$acres

#remove records with missing months
RMA_PNW <- subset(RMA_PNW, month != "")

#set a crop year column (i.e. water year)
RMA_PNW$cropyear <- RMA_PNW$year

#make oct/nov/dec part of the crop year
RMA_PNW$cropyear[RMA_PNW$monthcode >= 10] <- RMA_PNW$year + 1

#remove 2016
RMA_PNW <- subset(RMA_PNW, year != 2016)


#aggregate by year/state/county/commodity, for total loss in $
RMA_commodity_loss <- aggregate(RMA$loss, by = list(RMA$year, RMA$state, RMA$county, RMA$commodity), FUN = sum)
colnames(RMA_commodity_loss) <- c("year", "state", "county", "commodity", "loss")
RMA_commodity_loss <- subset(RMA_commodity_loss, commodity != "ADJUSTED GROSS REVENUE")

#aggregate by year/state/county/commodity for total number of claims
RMA_commodity_count <- aggregate(RMA$loss, by = list(RMA$year, RMA$state, RMA$county, RMA$commodity), FUN = length)
colnames(RMA_commodity_count) <- c("year", "state", "county", "commodity", "count")
RMA_commodity_count <- subset(RMA_commodity_count, commodity != "ADJUSTED GROSS REVENUE")

#aggregate for year/state/county/commodity for acreage
RMA_commodity_acres <- aggregate(RMA$acres, by = list(RMA$year, RMA$state, RMA$county, RMA$commodity), FUN = sum)
colnames(RMA_commodity_acres) <- c("year", "state", "county", "commodity", "acres")
RMA_commodity_acres <- subset(RMA_commodity_acres, commodity != "ADJUSTED GROSS REVENUE")

#aggregate for year/state/county/damage cause for total loss in $
RMA_damage_loss <- aggregate(RMA$loss, by = list(RMA$year, RMA$state, RMA$county, RMA$commodity, RMA$damagecause), FUN = sum)
colnames(RMA_damage_loss) <- c("year", "state", "county", "commodity", "damagecause", "loss")

#aggregate for year/state/county/commodity/damage cause by total loss in $
RMA_damage_count <- aggregate(RMA$loss, by = list(RMA$year, RMA$state, RMA$county, RMA$commodity, RMA$damagecause), FUN = length)
colnames(RMA_damage_count) <- c("year", "state", "county", "commodity", "damagecause", "count")

#aggregate by year/state/county/commodity/damage cause by acres
RMA_damage_acres <- aggregate(RMA$acres, by = list(RMA$year, RMA$state, RMA$county, RMA$commodity, RMA$damagecause), FUN = sum)
colnames(RMA_damage_acres) <- c("year", "state", "county", "commodity", "damaecause", "acres")

#combine all the aggregated commodity values (loss, count, acreage)
RMA_commodity_combined <- cbind(RMA_commodity_loss, RMA_commodity_count$count, RMA_commodity_acres$acres)
colnames(RMA_commodity_combined) <- c("year", "state", "county", "commodity", "loss", "count", "acres")

#calculate lossperacre for aggregated commodity
RMA_commodity_combined$lossperacre <- RMA_commodity_combined$loss / RMA_commodity_combined$acres

#calculate loss per claim for aggregated commodity
RMA_commodity_combined$lossperclaim <- RMA_commodity_combined$loss / RMA_commodity_combined$count

#calculate acres per claim for aggregated commodity
RMA_commodity_combined$acresperclaim <- RMA_commodity_combined$acres / RMA_commodity_combined$count

#combine all aggregated damage cause values (loss, count, acreage) 
RMA_damage_combined <- cbind(RMA_damage_loss, RMA_damage_count$count, RMA_damage_acres$acres)
colnames(RMA_damage_combined) <- c("year", "state", "county", "commodity", "damagecause", "loss", "count", "acres")

#calculate lossperacre for aggregated damage cause
RMA_damage_combined$lossperacre <- RMA_damage_combined$loss / RMA_damage_combined$acres

#calculate loss per claim for aggregated damage cause
RMA_damage_combined$lossperclaim <- RMA_damage_combined$loss / RMA_damage_combined$count

#calculate acres per claim for aggregated damage cause
RMA_damage_combined$acresperclaim <- RMA_damage_combined$acres / RMA_damage_combined$count

#set NAs for loss per acre for damage cause combo to zero.  
RMA_damage_combined$lossperacre[!is.finite(RMA_damage_combined$lossperacre)] <- 0

#subset for PNW - 2001 - 2015
RMA_damage_PNW <- subset(RMA_damage_combined, state == "WA" | state == "OR" | state == "ID")

#remove all other counties values
RMA_damage_PNW <- subset(RMA_damage_PNW, county != "All Other Counties")

#subset just for Idaho
RMA_Idaho <- subset(RMA_damage_PNW, state == "ID")

#subset just for Oregon
RMA_Oregon <- subset(RMA_damage_PNW, state == "OR")

#subset just for Washington
RMA_Washington <- subset(RMA_damage_PNW, state == "WA")

#subset just for iPNW counties for Idaho
RMA_Idaho_IPNW <- subset(RMA_Idaho, county == "Idaho" | county == "Lewis" | county ==  "Nez Perce" | county ==  "Latah" | county ==  "Benewah")

#subset just for iPNW counties for Oregon
RMA_Oregon_IPNW <- subset(RMA_Oregon, county == "Wasco" | county ==  "Sherman" | county ==  "Gilliam" | county ==  "Morrow" | county ==  "Umatilla" | county ==  "Union" | county ==  "Wallowa")

#subset just for iPNW counties for Washington
RMA_Washington_IPNW <- subset(RMA_Washington, county ==  "Douglas" | county ==  "Grant" | county ==  "Benton" | county ==  "Franklin" | county ==  "Walla Walla" | county ==  "Adams" | county ==  "Lincoln" | county ==  "Spokane" | county ==  "Whitman" | county ==  "Columbia" | county ==  "Garfield" | county ==  "Asotin")


#combine all iPNW counties
RMA_damage_IPNW <- rbind(RMA_Idaho_IPNW,RMA_Oregon_IPNW,RMA_Washington_IPNW)

 palousecounties    <-  c("Idaho", "Lewis", "Nez Perce", "Clearwater", "Latah", "Benewah", "Kootenai","Douglas", "Grant", "Benton", "Franklin", "Walla Walla", "Adams", "Lincoln", "Spokane", "Whitman", "Columbia", "Garfield", "Asotin","Wasco", "Sherman", "Gilliam", "Morrow", "Umatilla", "Union", "Wallowa")
 
sumloss_palouse <- RMA_damage_PNW[RMA_damage_PNW$county %in% palousecounties, ] 
sumloss_nonpalouse <- RMA_damage_PNW[!RMA_damage_PNW$county %in% palousecounties, ]

#----


```


```{r functions, message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, include=FALSE}

# A function for captioning and referencing images

fig <- local({
    i <- 0
    ref <- list()
    list(
        cap=function(refName, text) {
            i <<- i + 1
            ref[[refName]] <<- i
            paste("Figure ", i, ": ", text, sep="")
        },
        ref=function(refName) {
            ref[[refName]]
        })
})
``` 

\newpage
\blandscape

```{r message=FALSE, warning=FALSE, echo=FALSE}

#```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap=paste("Example of the original data that was acquired from the USDA Risk Management Agency (RMA).  Each record represents an individual insurance claim.")}

RMA_PNW_table <- RMA_PNW[-6]

knitr::kable(RMA_PNW_table[1:9,], row.names = FALSE, booktabs = T, format="latex", caption = "USDA RMA insurance loss records that were acquired from the USDA Risk Management Agency (RMA).  Each record represents an individual insurance claim.") %>%
   kable_styling(latex_options = c("striped", "hold_position"),
                full_width = F)

```


```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap=paste("Example of an aggregated dataset derived from the original files.  Here we have summarized claims by year, county, commodity, and damage cause.  Each unique combination is summarized, which echos the total summarized loss, the number of claims, the total summarized acreage, loss per acre, loss per claim, and acres per claim.  This dataset was the basis for our data examination.")}

knitr::kable(RMA_damage_PNW[1:10,], row.names = FALSE, booktabs = T, format="latex", caption = "USDA RMA aggregated dataset derived from the original insurance loss files. Here we have summarized claims by year, county, commodity, and damage cause.  Each unique combination is summarized, which echos the total summarized loss, the number of claims, the total summarized acreage, loss per acre, loss per claim, and acres per claim.  This dataset was the basis for our data examination.") %>%
   kable_styling(latex_options = c("striped", "hold_position"),
                full_width = F)
```
\elandscape
\newpage



```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 7, fig.cap=paste("Pacific Northwest study area, which includes agricultural regions for the inland Pacific Northwest, the southern Idaho valley, and the Willamette valley.")}

usePackage("data.table")
usePackage("maptools")
usePackage("classInt")
usePackage("leaflet")
usePackage("dplyr")
usePackage("raster")
usePackage("htmltools")

#URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/states/states_conus.zip"
#destfile <- "/tmp/seamon/states_conus.zip"
#download.file(URL, destfile)
#outDir<-"/tmp/seamon"
#unzip(destfile,exdir=outDir)

states <- readShapePoly('/tmp/seamon/states_conus/states_conus.shp',
                        proj4string=CRS
                        ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")


#URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/states/threestate_boundary.zip"
#destfile <- "/tmp/seamon/threestate_boundary.zip"
#download.file(URL, destfile)
#outDir<-"/tmp/seamon"
#unzip(destfile,exdir=outDir)
    
threestates <- readShapePoly('/tmp/seamon/threestate_boundary/threestate_boundary.shp', 
                                  proj4string=CRS
                                  ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
        projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")


#setwd("/dmine/data/counties/")
        
#URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/counties/threestate_willamette.zip"
#destfile <- "/tmp/seamon/threestate_willamette.zip"
#download.file(URL, destfile)
#outDir<-"/tmp/seamon"
#unzip(destfile,exdir=outDir)

counties_willamette <- readShapePoly('/tmp/seamon/threestate_willamette/threestate_willamette.shp',
                     proj4string=CRS
                     ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

#URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/counties/threestate_southernID.zip"
#destfile <- "/tmp/seamon/threestate_southernID.zip"
#download.file(URL, destfile)
#outDir<-"/tmp/seamon"
#unzip(destfile,exdir=outDir)

counties_ID <- readShapePoly('/tmp/seamon/threestate_southernID/threestate_southernID.shp',
                     proj4string=CRS
                     ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

#URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/counties/threestate_palouse.zip"
#destfile <- "/tmp/seamon/threestate_palouse.zip"
#download.file(URL, destfile)
#outDir<-"/tmp/seamon"
#unzip(destfile,exdir=outDir)

counties_palouse <- readShapePoly('/tmp/seamon/threestate_palouse/threestate_palouse.shp',
                     proj4string=CRS
                     ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

#pal <- colorNumeric(palette = c("white", "orange", "darkorange", "red", "darkred"),
#                    domain = counties$NAME)



exte <- as.vector(extent(threestates))

#label <- paste(sep = "<br/>", counties$NAME, round(counties$NAME, 0))
#markers <- data.frame(label)
#labs <- as.list(counties$NAME)

counties_palouse <- counties_palouse[counties_palouse$NAME != "Kootenai",]
counties_palouse <- counties_palouse[counties_palouse$NAME != "Clearwater",]

#--

par(mar=c(5, 8.1, 7, 0), family = 'serif', mgp=c(1, 1, 0), las=0)


usePackage("RgoogleMaps")
usePackage("sp")
usePackage("ggplot2")
usePackage("ggmap")
usePackage("maps")
usePackage("mapdata")


usePackage("mapproj")

map("worldHires","Canada", xlim=c(-130,-110),ylim=c(40,50), col="gray90", fill=TRUE)  #plot the region of Canada I want

map("worldHires","usa", xlim=c(-130,-110),ylim=c(40,50), col="gray95", fill=TRUE, add=TRUE)  #add the adjacent parts of the US; can't forget my homeland

plot(counties_palouse, add=TRUE, col=alpha("darkgreen", 0.6), border=FALSE)  
lines(counties_palouse)
lines(states)
box(lty = 1, col = 'black')


plot(counties_willamette, add=TRUE, col=alpha("red", 0.6), border=FALSE)  
lines(counties_willamette)


plot(counties_ID, add=TRUE, col=alpha("yellow", 0.6), border=FALSE)  
lines(counties_ID)

map.scale(x=-120.5, y=41, ratio=FALSE, relwidth=0.17) 
#north.arrow(xb = -121, yb=41, len = 0.22, lab="N")

# Inmap
par(usr=c(-129, 110, 22, 144))
rect(xleft =-126.2,ybottom = 23.8,xright = -65.5,ytop = 50.6,col = "white")
map("usa", xlim=c(-126.2,-65.5), ylim=c(23.8,50.6),add=T)
map("state", xlim=c(-126.2,-65.5), ylim=c(23.8,50.6),add=T, boundary = F, interior = T, lty=2)
#map("state", region="california", fill=T, add=T)
#points(-121.6945, 39.36708, bg = "white", pch = 21)
map("state", region=c("washington", "Idaho", "Oregon"), fill=T, add=T) 

#mapz <- leaflet(options = leafletOptions(zoomSnap = .4, zoomDelta = .4)) %>%  
#  addProviderTiles(providers$Hydda.Base) %>%
 #  addProviderTiles(providers$Stamen.TonerLines) %>% 
 
#  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(data = counties_palouse, color = "lightyellow",  fillOpacity = .8, weight = 1) %>% addPolygons(data = counties_palouse, color = "gray",  fillOpacity = 0, weight = 1) %>% addPolygons(data = counties_ID, color = "gray", fillOpacity = 0,  weight = 1) %>% addPolygons(data = counties_ID, color = "red",  weight = 1) %>% addPolygons(data = counties_willamette, color = "green",  weight = 1)  %>% addPolygons(data = counties_willamette, color = "gray", fillOpacity = 0, weight = 1)  %>% addPolygons(data = states, stroke = TRUE, color = "black",  weight = 3, fillOpacity = 0) 

#addScaleBar(mapz, position = c("bottomright"), options = scaleBarOptions())

```
\newpage

```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap=paste("Pacific Northwest agricultural insurance loss by year, 1989 to 2015")}

usePackage("htmlTable")
usePackage("gridExtra")

#palouse_sumloss_aggregate <- subset(palouse_sumloss_aggregate, year >= 2001 & year <= 2015)

#palouse_sumloss_1989_2015 <- subset(palouse_sumloss_aggregate, commodity == "WHEAT")
RMA_PNW2 <- RMA_PNW[-8]
RMA_PNW2 <- RMA_PNW2[-9]
RMA_PNW2 <- RMA_PNW2[-9]

RMA_all <- rbind(RMA_PNW_1989, RMA_PNW2)


#barplot of 1989 to 2015

RMA_PNW_aggregates <- aggregate(RMA_PNW$loss, by=list(RMA_PNW$year), FUN = "sum")
RMA_PNW_1989_aggregates <- aggregate(RMA_PNW_1989$loss, by=list(RMA_PNW_1989$year), FUN = "sum")
RMA_allyear <- rbind(RMA_PNW_1989_aggregates, RMA_PNW_aggregates)
colnames(RMA_allyear) <- c("Year", "Loss")

#barplot of 1989 to 2015 for damage causes

RMA_PNW_aggregates_d <- aggregate(RMA_PNW$loss, by=list(RMA_PNW$damagecause), FUN = "sum")
RMA_PNW_1989_aggregates_d <- aggregate(RMA_PNW_1989$loss, by=list(RMA_PNW_1989$damagecause), FUN = "sum")
RMA_allyear_d <- rbind(RMA_PNW_1989_aggregates_d, RMA_PNW_aggregates_d)
colnames(RMA_allyear_d) <- c("Damagecause", "Loss")

RMA_allyear_d <- aggregate(RMA_allyear_d$Loss, list(RMA_allyear_d$Damagecause), FUN = "sum")
colnames(RMA_allyear_d) <- c("Damagecause", "Loss")
RMA_allyear_d <- RMA_allyear_d[order(-RMA_allyear_d$Loss),] 

par(mar=c(5, 8.1, 7, 0), family = 'serif', mgp=c(1, 1, 0), las=0)
#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(RMA_allyear$Loss, names.arg = RMA_allyear$Year, las = 3, main = "", yaxt="n", col = "lightblue", xlab = "", cex.main = 1, cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1) 
graphics::title(main = "PNW total insurance loss by year: 1989 to 2015", line = 1, adj = 0, cex.main = 1)
pts <- pretty(RMA_allyear$Loss / 1000000)
pts2 <- pretty(RMA_allyear$Loss)
axis(2, las = 1, cex.axis = 1, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")

mtext("Year", cex = 1, side=1, line=4)
mtext("Insurance Claim Loss ($)", cex = 1, side=2, line=6.5)


```

\newpage

```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap=paste("PNW total insurance loss by year: 2001 to 2015")}

palouse_sumloss_1989_2015 <- aggregate(RMA_PNW$loss, list(RMA_PNW$year), FUN = "sum")

X <- palouse_sumloss_1989_2015
colnames(X) <- c("year", "loss")
#X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")

XX <- X
#XX <- subset(X, loss > 50000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

#YYY1<- YYY1[seq(dim(YYY1)[1],1),]
YYY1$loss <- round(YYY1$loss, 0)
#grid.table(YYY1, theme = tt3, rows = NULL)

YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

dd2 <- cbind(YYY2[1:15, ])
colnames(dd2) <- c("year", "loss")
dd2[is.na(dd2)] <- ""

par(mar=c(8, 8.1, 7, 0), family = 'serif', mgp=c(2, 1, 0), las=0)
#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$year, las = 3, yaxt="n", col = "lightblue", cex.lab = 1, cex.main = 1, cex.names = 1, font.lab = 1, font.axis = 1) 
graphics::title(main = "PNW total insurance loss by year: 2001 to 2015", line = 1, adj = 0, cex.main = 1)

pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, cex.axis = 1, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")

mtext("Insurance Claim Loss ($)", cex = 1, side=2, line=6)
mtext("Year", cex = 1, side=1, line=6)


#htmlTable(dd2,
#          cgroup = c("2001-2015"),
#          n.cgroup = c(2),
#          caption = "PNW total insurance loss by year, 2001-2015",
#          align = "c",
#          rnames = FALSE,
#          css.cell = "padding-left: .5em; padding-right: .5em;")
```


\newpage
```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap=paste("PNW total insurance loss by damage cause: 2001 to 2015.")}
#Figure 4

#--barplot of damage causes from 2001 to 2015

levels(YYY1$damagecause)[10] <- "Excessive Moisture"
par(mar=c(8, 8.1, 7, 0), family = 'serif', mgp=c(2, 1, 0), las=0)
#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$damagecause, las = 3, main = "", yaxt="n", col = "lightblue", xlab = "", cex.main = 1, cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1) 
graphics::title(main = "PNW total insurance loss by damage cause: 2001 to 2015", line = 1, adj = 0, cex.main = 1)
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, cex.axis = 1, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")

mtext("Damage Cause", cex = 1, side=1, line=8)
mtext("Insurance Claim Loss ($)", cex = 1, side=2, line=6.5)


#htmlTable(dd2,
#          cgroup = c("2001-2015"),
#          n.cgroup = c(2),
#          caption = "PNW total insurance loss by year, 2001-2015",
#          align = "c",
#          rnames = FALSE,
#          css.cell = "padding-left: .5em; padding-right: .5em;")

```

\newpage
```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap=paste("PNW total insurance loss by commodity: 2001 to 2015.")}
#Figure 5

X <- c2

#X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")

XX <- X
XX <- subset(X, loss > 50000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

#YYY1<- YYY1[seq(dim(YYY1)[1],1),]
YYY1$loss <- round(YYY1$loss, 0)
#grid.table(YYY1, theme = tt3, rows = NULL)

YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

dd2 <- cbind(YYY2[1:14, ])
colnames(dd2) <- c("commodity", "loss")
dd2[is.na(dd2)] <- ""

YYY1$commodity <- tolower(YYY1$commodity)
YYY1$commodity <- stri_trans_general(YYY1$commodity, id = "Title")
YYY1$commodity <- factor(YYY1$commodity)


par(mar=c(8, 8.1, 7, 0), family = 'serif', mgp=c(2, 1, 0), las=0)
levels(YYY1$commodity)[1] <- "Gross Revenue"
barplot(YYY1$loss, names.arg = YYY1$commodity, las = 3, yaxt="n", col = "lightblue", cex.main = 1.5, cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1) 
graphics::title(main = "PNW total insurance loss by commodity: 2001 to 2015", line = 1, adj = 0, cex.main = 1)
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, cex.axis = 1, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")

mtext("Insurance Claim Loss ($)", cex = 1, side=2, line=6)
mtext("Commodity", cex = 1, side=1, line=15)


#htmlTable(dd2,
#          cgroup = c("2001-2015"),
#          n.cgroup = c(2),
#          caption = "PNW total insurance loss by year, 2001-2015",
#          align = "c",
#          rnames = FALSE,
#          css.cell = "padding-left: .5em; padding-right: .5em;")


```


\newpage

```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8.5, fig.height = 8, fig.cap=paste("PNW total insurance loss by year: 2001 to 2015")}

usePackage("plotly")
usePackage("gridExtra")
usePackage("knitr")
usePackage("kableExtra")
usePackage("htmlTable")
usePackage("stringi")
usePackage("extrafont")


#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}


palouse_sumloss_1989_2015_lossperacres <- aggregate(RMA_PNW$lossperacre, list( RMA_PNW$year, RMA_PNW$state, RMA_PNW$commodity), FUN = "mean")

colnames(palouse_sumloss_1989_2015_lossperacres) <- c("year", "state", "commodity",  "lossperacres")

palouse_sumloss_1989_2015_lossperacres2 <- aggregate(RMA_PNW$lossperacre, list( RMA_PNW$year, RMA_PNW$damagecause), FUN = "mean")

colnames(palouse_sumloss_1989_2015_lossperacres2) <- c("year", "damagecause", "lossperacres")

#palouse_sumloss_1989_2015_lossperacres <- subset(palouse_sumloss_1989_2015_lossperacres, lossperacres > 200)
#palouse_sumloss_1989_2015_lossperacres2 <- subset(palouse_sumloss_1989_2015_lossperacres2, lossperacres > 200)

#palouse_sumloss_1989_2015_lossperacres <- subset(palouse_sumloss_1989_2015_lossperacres, commodity != "ADJUSTED GROSS REVENUE")
#palouse_sumloss_1989_2015_lossperacres <- subset(palouse_sumloss_1989_2015_lossperacres, commodity != "Other (Snow/Lightning-Etc.)")

palouse_sumloss_1989_2015_lossperacres2$damagecause <- factor(palouse_sumloss_1989_2015_lossperacres2$damagecause)

palouse_sumloss_1989_2015_lossperacres$commodity <- factor(palouse_sumloss_1989_2015_lossperacres$commodity)


levels(palouse_sumloss_1989_2015_lossperacres$commodity)[14] <- "FORAGE"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[15] <- "APRICOTS"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[16] <- "FREESTONE PEACHES"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[17] <- "NECTARINES"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[24] <- "PASTURE, RANGELAND"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[30] <- "BLACKBERRIES"

levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[8] <- "Excessive Moisture"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[25] <- "Snow/Lightning"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[21] <- "Hurricane"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[24] <- "Mycotoxin"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[22] <- "Lack Irrig Prep"


palouse_sumloss_1989_2015_loss <- aggregate(RMA_PNW$loss, by = list( RMA_PNW$year, RMA_PNW$commodity), FUN = "sum")

colnames(palouse_sumloss_1989_2015_loss) <- c("year", "commodity",  "loss")

palouse_sumloss_1989_2015_loss2 <- aggregate(RMA_PNW$loss, list( RMA_PNW$year, RMA_PNW$damagecause), FUN = "sum")

colnames(palouse_sumloss_1989_2015_loss2) <- c("year", "damagecause", "loss")

psloss <- palouse_sumloss_1989_2015_loss

palouse_sumloss_1989_2015_loss <- subset(palouse_sumloss_1989_2015_loss, loss > 20000000)
palouse_sumloss_1989_2015_loss2 <- subset(palouse_sumloss_1989_2015_loss2, loss > 20000000)

palouse_sumloss_1989_2015_loss <- subset(palouse_sumloss_1989_2015_loss, commodity != "ADJUSTED GROSS REVENUE")

palouse_sumloss_1989_2015_loss2$damagecause <- factor(palouse_sumloss_1989_2015_loss2$damagecause)

palouse_sumloss_1989_2015_loss$commodity <- factor(palouse_sumloss_1989_2015_loss$commodity)


levels(palouse_sumloss_1989_2015_loss2$damagecause)[4] <- "Excessive Moisture"






palouse_sumloss_1989_2015_count <- aggregate(RMA_PNW$loss, list( RMA_PNW$year, RMA_PNW$state, RMA_PNW$commodity), FUN = "length")

colnames(palouse_sumloss_1989_2015_count) <- c("year", "state", "commodity",  "loss")

palouse_sumloss_1989_2015_count2<- aggregate(RMA_PNW$loss, list( RMA_PNW$year, RMA_PNW$damagecause, RMA_PNW$state), FUN = "length")

colnames(palouse_sumloss_1989_2015_count2) <- c("year", "damagecause", "state", "loss")


palouse_sumloss_1989_2015_loss3<- aggregate(RMA_PNW$loss, list( RMA_PNW$year, RMA_PNW$commodity, RMA_PNW$state), FUN = "sum")

colnames(palouse_sumloss_1989_2015_loss3) <- c("year", "commodity", "state", "loss")

#-boxplots of count data for all commodities and all damage causes- 1989-2015

palouse_sumloss_1989_2015_count <- subset(palouse_sumloss_1989_2015_count, loss > 50)
palouse_sumloss_1989_2015_count2 <- subset(palouse_sumloss_1989_2015_count2, loss > 50)

palouse_sumloss_1989_2015_count <- subset(palouse_sumloss_1989_2015_count, commodity != "ADJUSTED GROSS REVENUE")

palouse_sumloss_1989_2015_count2$damagecause <- factor(palouse_sumloss_1989_2015_count2$damagecause)

palouse_sumloss_1989_2015_count$commodity <- factor(palouse_sumloss_1989_2015_count$commodity)


levels(palouse_sumloss_1989_2015_count2$damagecause)[5] <- "Excessive Moisture"
levels(palouse_sumloss_1989_2015_count2$damagecause)[11] <- "Other"


#proper=function(x) paste0(toupper(substr(x, 1, 1)), tolower(substring(x, 2)))

palouse_sumloss_1989_2015_count$commodity <- tolower(palouse_sumloss_1989_2015_count$commodity)
palouse_sumloss_1989_2015_count$commodity <- stri_trans_general(palouse_sumloss_1989_2015_count$commodity, id = "Title")

#par(mar=c(12.7, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
par(mar=c(8, 6.1, 7, 1), family = 'serif', mgp=c(4, 1, 0), las=0)

palouse_sumloss_1989_2015_count$commodity <- factor(palouse_sumloss_1989_2015_count$commodity)
levels(palouse_sumloss_1989_2015_count$commodity)[1] <- "Gross Revenue-Lite"
boxplot(palouse_sumloss_1989_2015_count$loss ~ palouse_sumloss_1989_2015_count$commodity, col = 'lightblue', ylab = "Insurance Claim Frequency", yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_count$commodity, las = 3, cex.axis = 1, cex.main = 1, cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1, bty = 1)
axis(2, las = 1, cex.axis = 1, at = pretty(palouse_sumloss_1989_2015_count$loss), labels = pretty(palouse_sumloss_1989_2015_count$loss))

makered <- palouse_sumloss_1989_2015_count$state == "WA"
stripchart(loss ~ commodity, data=palouse_sumloss_1989_2015_count[makered, ], method = "jitter", vertical = TRUE,  add = TRUE, pch = 20, col="red")

makered <- palouse_sumloss_1989_2015_count$state == "ID"
stripchart(loss ~ commodity, method = "jitter", vertical = TRUE,  
    add = TRUE, pch = 20, col="black", data=palouse_sumloss_1989_2015_count[makered, ])

makered <- palouse_sumloss_1989_2015_count$state == "OR"
stripchart(loss ~ commodity, method = "jitter", vertical = TRUE,  
    add = TRUE, pch = 20, col="blue", data=palouse_sumloss_1989_2015_count[makered, ])

graphics::title(xlab="Commodity", line=6.5, cex.lab = 1)
graphics::title(main="PNW insurance claims by commodity: 2001 to 2015", line = 1, adj = 0, cex.main = 1)
legend("topleft", inset=.02, title="State Per Year",
   c("Washington", "Idaho", "Oregon"), fill=c("red", "black", "blue"), horiz=TRUE, cex=0.8)

```

\newpage

```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap=paste("PNW total insurance loss by year: 2001 to 2015")}

#par(mar=c(12.7, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
#par(mar=c(11, 8.0, 7, 0), family = 'serif', mgp=c(3, 1, 0), las=0)
par(mar=c(11, 6.1, 7, 0), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_count2$loss ~ palouse_sumloss_1989_2015_count2$damagecause, col = 'lightblue', ylab = "Insurance Claim Frequency",  yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_count2$damagecause, las = 3, cex.main = 1.9, cex.lab = 1, cex.axis = 1, cex.names = 1, font.lab = 1, font.axis = 1, outline = FALSE)
axis(2, las = 1, cex.axis = 1, at = pretty(palouse_sumloss_1989_2015_count2$loss), labels = pretty(palouse_sumloss_1989_2015_count2$loss))


makered <- palouse_sumloss_1989_2015_count2$state == "OR"
stripchart(loss ~ damagecause, method = "jitter", vertical = TRUE,  
    add = TRUE, pch = 20, col="blue", data=palouse_sumloss_1989_2015_count2[makered, ])

makered <- palouse_sumloss_1989_2015_count2$state == "WA"
stripchart(loss ~ damagecause, data=palouse_sumloss_1989_2015_count2[makered, ], method = "jitter", vertical = TRUE,  add = TRUE, pch = 20, col="red")

makered <- palouse_sumloss_1989_2015_count2$state == "ID"
stripchart(loss ~ damagecause, method = "jitter", vertical = TRUE,  
    add = TRUE, pch = 20, col="black", data=palouse_sumloss_1989_2015_count2[makered, ])



graphics::title(xlab="Damage Cause", line=9.5, cex.lab = 1)
graphics::title(main="PNW insurance claim counts by damage cause: 2001 to 2015", line = 1, adj = 0, cex.main = 1)

#stripchart(palouse_sumloss_1989_2015_count2$loss ~ palouse_sumloss_1989_2015_count2$damagecause, vertical = TRUE,  
#    method = "jitter", add = TRUE, pch = 20, col = "blue" )
legend("topright", inset=.02, title="State Per Year",
   c("Washington", "Idaho", "Oregon"), fill=c("red", "black", "blue"), horiz=TRUE, cex=0.8)
```

\newpage
```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap=paste("PNW total insurance loss by year: 2001 to 2015")}


#par(mar=c(8, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
par(mar=c(11, 6.1, 7, 0), family = 'serif', mgp=c(4, 1, 0), las=0)

means <- aggregate(loss ~  commodity, palouse_sumloss_1989_2015_loss3, mean)
means <- means[order(means$loss),]
means <- subset(means, loss > 2300000)
means$commodity <- factor(means$commodity)

palouse_sumloss_1989_2015_loss3 <- palouse_sumloss_1989_2015_loss3[palouse_sumloss_1989_2015_loss3$commodity %in% means$commodity, ]

palouse_sumloss_1989_2015_loss3$commodity <- tolower(palouse_sumloss_1989_2015_loss3$commodity)
palouse_sumloss_1989_2015_loss3$commodity <- stri_trans_general(palouse_sumloss_1989_2015_loss3$commodity, id = "Title")

boxplot(palouse_sumloss_1989_2015_loss3$loss ~ palouse_sumloss_1989_2015_loss3$commodity, col = 'lightblue', ylab = "Insurance Claim Loss ($)", yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_loss3$commodity, las = 3, cex.axis = 1, cex.main = 1, cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1)
#axis(2, las = 1, cex.axis = 1.2, at = pretty(palouse_sumloss_1989_2015_loss3$loss), labels = pretty(palouse_sumloss_1989_2015_loss3$loss))

pts <- pretty(palouse_sumloss_1989_2015_loss3$loss / 1000000)
pts2 <- pretty(palouse_sumloss_1989_2015_loss3$loss)
axis(2, las = 1, cex.axis = 1, at = pts2, labels = paste(pts, "M", sep = ""))

#stripchart(palouse_sumloss_1989_2015_loss3$loss ~ palouse_sumloss_1989_2015_loss3$commodity, vertical = TRUE,  
#    method = "jitter", add = TRUE, pch = 20, col = "blue" )
palouse_sumloss_1989_2015_loss3$commodity <- factor(palouse_sumloss_1989_2015_loss3$commodity)
palouse_sumloss_1989_2015_loss3$state <- factor(palouse_sumloss_1989_2015_loss3$state)

makered1 <- palouse_sumloss_1989_2015_loss3$state == "OR"
stripchart(loss ~ commodity, method = "jitter", vertical = TRUE,  
    add = TRUE, pch = 20, col="blue", data=palouse_sumloss_1989_2015_loss3[makered1, ])

makered3 <- palouse_sumloss_1989_2015_loss3$state == "WA"
stripchart(loss ~ commodity, method = "jitter", vertical = TRUE,  
    add = TRUE, pch = 20, col="red", data=palouse_sumloss_1989_2015_loss3[makered3, ])

makered2 <- palouse_sumloss_1989_2015_loss3$state == "ID"
stripchart(loss ~ commodity, method = "jitter", vertical = TRUE,  
    add = TRUE, pch = 20, col="black", data=palouse_sumloss_1989_2015_loss3[makered2, ])

with(subset(palouse_sumloss_1989_2015_loss3, year == 2009 & commodity == "Wheat"), text(5,260000000, labels = year, adj = c(1.5,1), cex = .9))
with(subset(palouse_sumloss_1989_2015_loss3, year == 2015 & commodity == "Wheat"), text(5,134000000, labels = year, adj = c(1.5,1), cex = .9))


graphics::title(xlab="Commodity", line=6, cex.lab = 1)
graphics::title(main="PNW insurance loss by commodity: 2001 to 2015", line = 1, adj = 0, cex.main = 1)
legend("topleft", inset=.02, title="State Per Year",
   c("Washington", "Idaho", "Oregon"), fill=c("red", "black", "blue"), horiz=TRUE, cex=0.8)
#points(1:nrow(means), means$loss, col = "red")
#text(1:nrow(means), means$loss + 0.08, labels = means$loss)

```

\newpage
```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap=paste("PNW total insurance loss by year: 2001 to 2015")}

#par(mar=c(12.2, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
par(mar=c(11, 6.1, 7, 0), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_loss2$loss ~ palouse_sumloss_1989_2015_loss2$damagecause, col = 'lightblue', ylab = "Insurance Claim Loss ($)",  yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_loss2$damagecause, las = 3, cex.lab = 1, cex.axis = 1, cex.names = 1, font.lab = 1, font.axis = 1, outline = FALSE)
#axis(2, las = 1, cex.axis = 1.2, at = pretty(palouse_sumloss_1989_2015_loss2$loss), labels = pretty(palouse_sumloss_1989_2015_loss2$loss))
pts <- pretty(palouse_sumloss_1989_2015_loss2$loss / 1000000)
pts2 <- pretty(palouse_sumloss_1989_2015_loss2$loss)
axis(2, las = 1, cex.axis = 1.2, at = pts2, labels = paste(pts, "M", sep = ""))

stripchart(palouse_sumloss_1989_2015_loss2$loss ~ palouse_sumloss_1989_2015_loss2$damagecause, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20, col = "blue" )

graphics::title(xlab="Damage Cause", line=9, cex.lab = 1)
graphics::title(main="PNW insurance loss by damage cause: 2001 to 2015", line = 1, adj = 0, cex.main = 1)

```

\newpage
```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap=paste("PNW total insurance loss by year: 2001 to 2015")}


#par(mar=c(14, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
par(mar=c(11, 6.1, 7, 0), family = 'serif', mgp=c(4, 1, 0), las=0)

palouse_sumloss_1989_2015_lossperacres$commodity <- tolower(palouse_sumloss_1989_2015_lossperacres$commodity)
palouse_sumloss_1989_2015_lossperacres$commodity <- stri_trans_general(palouse_sumloss_1989_2015_lossperacres$commodity, id = "Title")


palouse_sumloss_1989_2015_lossperacres[ palouse_sumloss_1989_2015_lossperacres == "-Inf" ] <- 0
palouse_sumloss_1989_2015_lossperacres[ palouse_sumloss_1989_2015_lossperacres == "Inf" ] <- 0



palouse_sumloss_1989_2015_lossperacres$commodity <- factor(palouse_sumloss_1989_2015_lossperacres$commodity)
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[2] <- "Gross Revenue-Lite"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[39] <- "Revenue Protection"


boxplot(palouse_sumloss_1989_2015_lossperacres$loss ~ palouse_sumloss_1989_2015_lossperacres$commodity, col = 'lightblue', ylab = "Insurance Claim Loss per Acre ($)", yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_lossperacres$commodity, las = 3, cex.axis = 1, cex.main = 1, cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1, outline = FALSE)
axis(2, las = 1, cex.axis = 1, at = pretty(palouse_sumloss_1989_2015_lossperacres$loss), labels = pretty(palouse_sumloss_1989_2015_lossperacres$loss))

#stripchart(palouse_sumloss_1989_2015_lossperacres$loss ~ palouse_sumloss_1989_2015_lossperacres$commodity, vertical = TRUE,  
#    method = "jitter", add = TRUE, pch = 20, col = "blue" )

makered <- palouse_sumloss_1989_2015_lossperacres$state == "WA"
stripchart(lossperacres ~ commodity, data=palouse_sumloss_1989_2015_lossperacres[makered, ], method = "jitter", vertical = TRUE,  add = TRUE, pch = 20, col="red")

makered <- palouse_sumloss_1989_2015_lossperacres$state == "ID"
stripchart(lossperacres ~ commodity, method = "jitter", vertical = TRUE,  
    add = TRUE, pch = 20, col="black", data=palouse_sumloss_1989_2015_lossperacres[makered, ])

makered <- palouse_sumloss_1989_2015_lossperacres$state == "OR"
stripchart(lossperacres ~ commodity, method = "jitter", vertical = TRUE,  
    add = TRUE, pch = 20, col="blue", data=palouse_sumloss_1989_2015_lossperacres[makered, ])

graphics::title(xlab="Commodity", line=9, cex.lab = 1)
graphics::title(main="PNW insurance loss per acre by commodity: 2001 to 2015", line = 1, adj = 0, cex.main = 1)
legend("topright", inset=.02, title="State Per Year",
   c("Washington", "Idaho", "Oregon"), fill=c("red", "black", "blue"), horiz=TRUE, cex=0.8)

```

\newpage

```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap=paste("PNW total insurance loss by year: 2001 to 2015")}

#par(mar=c(11.8, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
par(mar=c(11, 6.1, 7, 0), family = 'serif', mgp=c(4, 1, 0), las=0)


palouse_sumloss_1989_2015_lossperacres2$damagecause <- factor(palouse_sumloss_1989_2015_lossperacres2$damagecause)
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[19] <- "Hurricanes/Trop Dep"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[30] <- "No Prep for Irr"

boxplot(palouse_sumloss_1989_2015_lossperacres2$loss ~ palouse_sumloss_1989_2015_lossperacres2$damagecause, col = 'lightblue', ylab = "Insurance Caim Loss per Acre ($)",  yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_lossperacres2$damagecause, las = 3, cex.main = 1, cex.lab = 1, cex.axis = 1, cex.names = 1, font.lab = 1, font.axis = 1, outline = FALSE)
axis(2, las = 1, cex.axis = 1.4, at = pretty(palouse_sumloss_1989_2015_lossperacres2$loss), labels = pretty(palouse_sumloss_1989_2015_lossperacres2$loss))

graphics::title(xlab="Damage Cause", line=9.5, cex.lab = 1)
graphics::title(main="PNW insurance loss per acre by damage cause: 2001 to 2015", line = 1, adj = 0, cex.main = 1)

stripchart(palouse_sumloss_1989_2015_lossperacres2$loss ~ palouse_sumloss_1989_2015_lossperacres2$damagecause, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20, col = "blue" )

#model_count <- glm(formula = log(loss) ~ damagecause + commodity, family = "poisson", data = palouse_sumloss_1989_2015_count)

```








\newpage

```{r message=FALSE, warning=FALSE, error=TRUE, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: Biplot of principle components for insurance loss for the entire PNW, by county, with commodity as the factor loadings. Bottom panel: Scree plot. Data from 2001 to 2015 is used.")}

usePackage("ggplot2")
usePackage("ggfortify")
usePackage("reshape2")

#PNW by commodity

RMA_damage_PNW_transformed_commodity <- dcast(RMA_damage_PNW, county + state ~ commodity, value.var = c("loss"), sum)
RMA_damage_PNW_transformed_commodity$statecounty <- paste(RMA_damage_PNW_transformed_commodity$county, "_", RMA_damage_PNW_transformed_commodity$state, sep="")
rownames(RMA_damage_PNW_transformed_commodity) <- RMA_damage_PNW_transformed_commodity$statecounty
RMA_damage_PNW_exogenous_commodity <- RMA_damage_PNW_transformed_commodity[,3:41]

RMA_damage_PNW_exogenous_commodity <- RMA_damage_PNW_exogenous_commodity[-1]
RMA_damage_PNW_exogenous_commodity <- RMA_damage_PNW_exogenous_commodity[-20]
RMA_damage_PNW_exogenous_commodity <- RMA_damage_PNW_exogenous_commodity[-37]


fit <- princomp(RMA_damage_PNW_exogenous_commodity, cor=TRUE)
#ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_commodity, scale = TRUE, center = TRUE), data = RMA_damage_PNW_transformed_commodity, colour = 'county', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 3, legend = FALSE) + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_commodity)) + theme(legend.position = "none")


plot1 <- ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_commodity, center = TRUE, scale = TRUE), frame = TRUE, frame.type = 'norm', data = RMA_damage_PNW_transformed_commodity, colour = 'state', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 2, legend = FALSE)  + theme_bw()   + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_commodity)) + theme(legend.position = "none") + ggtitle("Principle Components: PNW insurance loss by county with commodity loadings ") + theme(plot.title = element_text(size =12)) + theme(axis.title.y = element_text(size=12), axis.title.x = element_text(size = 12), axis.text.x = element_text(size=rel(1.5), hjust = 1), axis.text.y = element_text(size=rel(1.5), hjust = 1))

#scree plot

std_dev <- fit$sdev

pr_var <- std_dev^2

#pr_var[1:10]

prop_varex <- pr_var/sum(pr_var)

prop_varex <- data.frame(prop_varex)

prop_varex$comp <- c(1:max(nrow(prop_varex)))

prop_varex$prop_varex <- as.numeric(prop_varex$prop_varex)
prop_varex$comp_factor <- as.factor(prop_varex$comp)


p <- ggplot(prop_varex, aes(as.factor(comp), prop_varex, group=1))
plot2 <- p + geom_point(shape = 21) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
xlab("comp") + theme_bw() + stat_summary(fun.y=sum, geom="line") + labs(title = "Scree plot: PNW insurance loss by county with commodity loadings", x = "principle components", y = "% explained variance") 

#+ panel.border = element_rect(colour = "black", fill=NA, size=1)


grid.arrange(plot1, plot2, nrow=2, heights=c(2,1))


```
\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of principle components of insurance loss, for the entire PNW, for all commodities by year, with damage cause as the factor loadings. Bottom panel: Scree plot. Data from 2001 to 2015 is used.")}

usePackage("ggplot2")
usePackage("ggfortify")
usePackage("reshape2")
usePackage("grid")
usePackage("gridExtra")

RMA_damage_PNW_transformed_year <- dcast(RMA_damage_PNW, year ~ damagecause, value.var = c("loss"), sum)
#RMA_damage_PNW_transformed_year$statecounty <- paste(RMA_damage_PNW_transformed_year$county, "_", RMA_damage_PNW_transformed_year$state, sep="")
rownames(RMA_damage_PNW_transformed_year) <- RMA_damage_PNW_transformed_year$year
RMA_damage_PNW_exogenous_year <- RMA_damage_PNW_transformed_year[,2:31]

#PNW using year as group - with damage cause as loadings
#fit <- princomp(RMA_damage_PNW_exogenous_year, cor=TRUE, scale = TRUE, center = TRUE)

RMA_damage_PNW_exogenous_year_factor <- cbind(RMA_damage_PNW_exogenous_year[,2:3], RMA_damage_PNW_exogenous_year[6], RMA_damage_PNW_exogenous_year[8], RMA_damage_PNW_exogenous_year[,11:14], RMA_damage_PNW_exogenous_year[16:17])

fit <- princomp(RMA_damage_PNW_exogenous_year_factor, cor=TRUE)

plot1 <- ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_year_factor, center = TRUE, scale = TRUE),  data = RMA_damage_PNW_exogenous_year_factor, colour = rownames(RMA_damage_PNW_exogenous_year_factor), loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 2, legend = FALSE)  + theme_bw()   + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_year_factor)) + theme(legend.position = "none") + ggtitle("Principle Components: PNW insurance loss by year with damage cause loadings ") + theme(plot.title = element_text(size =12)) + theme(axis.title.y = element_text( size=12), axis.title.x = element_text(size = 12), axis.text.x = element_text(size=rel(1.5), hjust = 1), axis.text.y = element_text(size=rel(1.5), hjust = 1))

#scree plot

std_dev <- fit$sdev

pr_var <- std_dev^2

#pr_var[1:10]

prop_varex <- pr_var/sum(pr_var)

prop_varex <- data.frame(prop_varex)

prop_varex$comp <- c(1:max(nrow(prop_varex)))

prop_varex$prop_varex <- as.numeric(prop_varex$prop_varex)

p <- ggplot(prop_varex, aes(as.factor(comp), prop_varex, group=1))
plot2 <- p + geom_point(shape = 21) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  xlab("comp") + theme_bw() +
stat_summary(fun.y=sum, geom="line") + labs(title = "Scree plot: PNW insurance loss by year with damage cause loadings", x = "principle components", y = "% explained variance")

grid.arrange(plot1, plot2, nrow=2, heights=c(2,1))

```
\newpage
<br></br>


```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of principle components for insurance loss for the entire PNW, for all commodities by month, with damage cause as the factor loadings.  Bottom panel: Scree plot Data from 2001 is 2015 is used.")}

usePackage("ggplot2")
usePackage("ggfortify")
usePackage("reshape2")

#PNW damage cause as loadings using months as groups

#remove negatives related to lossperacre calc
RMA_PNW_noneg <- subset(RMA_PNW, lossperacre != Inf)
RMA_PNW_noneg2 <- subset(RMA_PNW_noneg, lossperacre >=0 )
RMA_PNW_noneg3 <- subset(RMA_PNW_noneg2, month !="" )

RMA_damage_PNW_transformed_month <- dcast(RMA_PNW_noneg3, month ~ damagecause, value.var = c("loss"), mean)

is.nan.data.frame <- function(x)
do.call(cbind, lapply(x, is.nan))

RMA_damage_PNW_transformed_month[is.nan(RMA_damage_PNW_transformed_month)] <- 0

#RMA_damage_PNW_transformed_year$statecounty <- paste(RMA_damage_PNW_transformed_year$county, "_", RMA_damage_PNW_transformed_year$state, sep="")
rownames(RMA_damage_PNW_transformed_month) <- RMA_damage_PNW_transformed_month$month
RMA_damage_PNW_exogenous_month <- RMA_damage_PNW_transformed_month[,2:31]

RMA_damage_PNW_exogenous_month <- cbind(RMA_damage_PNW_exogenous_month[,2:3], RMA_damage_PNW_exogenous_month[6], RMA_damage_PNW_exogenous_month[8], RMA_damage_PNW_exogenous_month[,11:14], RMA_damage_PNW_exogenous_month[16:17])


#ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_year, center = TRUE, scale = TRUE), data = RMA_damage_PNW_transformed_year, colour = 'year', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 3, legend = FALSE) + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_year)) + theme(legend.position = "none")

#PNW using month as group - with damage cause as loadings
fit <- princomp(RMA_damage_PNW_exogenous_month, cor=TRUE)
plot1 <- ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_month, center = TRUE, scale = TRUE),  data = RMA_damage_PNW_transformed_month, colour = 'month', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 2, legend = FALSE)  + theme_bw()   + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_month)) + theme(legend.position = "none") + ggtitle("Principle Components: PNW insurance loss by month with damage cause loadings ") + theme(plot.title = element_text(size =12)) + theme(axis.title.y = element_text(size=12), axis.title.x = element_text(size = 12), axis.text.x = element_text(size=rel(1.5), hjust = 1), axis.text.y = element_text(size=rel(1.5), hjust = 1, family = "Serif"))
#scree plot

std_dev <- fit$sdev

pr_var <- std_dev^2

#pr_var[1:10]

prop_varex <- pr_var/sum(pr_var)

prop_varex <- data.frame(prop_varex)

prop_varex$comp <- c(1:max(nrow(prop_varex)))

prop_varex$prop_varex <- as.numeric(prop_varex$prop_varex)

p <- ggplot(prop_varex, aes(as.factor(comp), prop_varex, group=1))
plot2 <- p + geom_point(shape = 21) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  xlab("comp") + theme_bw() +
stat_summary(fun.y=sum, geom="line") + labs(title = "Scree plot: PNW insurance loss, for all commodities by month, with damage cause as the factor loadings. ", x = "principle components", y = "% explained variance")

grid.arrange(plot1, plot2, nrow=2, heights=c(2,1))

```
\newpage
<br></br>


```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for wheat by year, with damage cause as the factor loadings. Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

usePackage("ggplot2")
usePackage("ggfortify")
usePackage("reshape2")

#PNW damage cause as loadings using years as groups, JUST FOR WHEAT

RMA_damage_PNW_wheat_year <- subset(RMA_damage_PNW, commodity == "WHEAT")
RMA_damage_PNW_transformed_wheat_year <- dcast(RMA_damage_PNW_wheat_year, year ~ damagecause, value.var = c("loss"), sum)
#RMA_damage_PNW_transformed_year$statecounty <- paste(RMA_damage_PNW_transformed_year$county, "_", RMA_damage_PNW_transformed_year$state, sep="")
rownames(RMA_damage_PNW_transformed_wheat_year) <- RMA_damage_PNW_transformed_wheat_year$year
RMA_damage_PNW_exogenous_wheat_year <- RMA_damage_PNW_transformed_wheat_year
par(mar=c(8, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

#PNW using year as group - with damage cause as loadings: JUST FOR WHEAT

RMA_damage_PNW_exogenous_wheat_year_factor <- cbind(RMA_damage_PNW_exogenous_wheat_year[,3:4], RMA_damage_PNW_exogenous_wheat_year[7], RMA_damage_PNW_exogenous_wheat_year[9], RMA_damage_PNW_exogenous_wheat_year[,12:15], RMA_damage_PNW_exogenous_wheat_year[17:18])
fit <- princomp(RMA_damage_PNW_exogenous_wheat_year_factor, cor=TRUE)

plot1 <- ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_wheat_year_factor, center = TRUE, scale = TRUE),  data = RMA_damage_PNW_exogenous_wheat_year_factor, colour = rownames(RMA_damage_PNW_exogenous_wheat_year_factor), loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 2, legend = FALSE)  + theme_bw()   + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_wheat_year_factor)) + theme(legend.position = "none") + ggtitle("Principle Components: PNW wheat insurance loss by year with \ndamage cause loadings ") + theme(plot.title = element_text(size =12, family = "Serif")) + theme(axis.title.y = element_text(family = "Serif", size=12), axis.title.x = element_text(family = "Serif", size = 12), axis.text.x = element_text(size=rel(1.5), hjust = 1, family = "Serif"), axis.text.y = element_text(size=rel(1.5), hjust = 1, family = "Serif"))

#scree plot

std_dev <- fit$sdev

pr_var <- std_dev^2

#pr_var[1:10]

prop_varex <- pr_var/sum(pr_var)

prop_varex <- data.frame(prop_varex)

prop_varex$comp <- c(1:max(nrow(prop_varex)))

prop_varex$prop_varex <- as.numeric(prop_varex$prop_varex)

p <- ggplot(prop_varex, aes(as.factor(comp), prop_varex, group=1))
plot2 <- p + geom_point(shape = 21) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  xlab("comp") + theme_bw() +
stat_summary(fun.y=sum, geom="line") + labs(title = "Scree plot: insurance loss for the entire PNW, for wheat by year, with \ndamage cause as the factor loadings.", x = "principle components", y = "% explained variance")

grid.arrange(plot1, plot2, nrow=2, heights=c(2,1))


```
\newpage
<br></br>


```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for wheat by county, with damage cause as the factor loadings. Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

#PNW wheat

usePackage("ggplot2")
usePackage("ggfortify")
usePackage("reshape2") 

RMA_damage_PNW_wheat <- subset(RMA_damage_PNW, commodity == "WHEAT")

RMA_damage_PNW_transformed_wheat <- dcast(RMA_damage_PNW_wheat, county + state ~ damagecause, value.var = c("loss"), sum)
RMA_damage_PNW_transformed_wheat$statecounty <- paste(RMA_damage_PNW_transformed_wheat$county, "_", RMA_damage_PNW_transformed_wheat$state, sep="")
rownames(RMA_damage_PNW_transformed_wheat) <- RMA_damage_PNW_transformed_wheat$statecounty
#RMA_damage_PNW_exogenous_wheat <- RMA_damage_PNW_transformed_wheat[,3:27]
RMA_damage_PNW_exogenous_wheat <- RMA_damage_PNW_transformed_wheat

#ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_month), data = RMA_damage_PNW_transformed_month, colour = 'month', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 3, legend = FALSE) + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_month)) + theme(legend.position = "none")

#PNW wheat

RMA_damage_PNW_exogenous_wheat <- cbind(RMA_damage_PNW_exogenous_wheat[,4:5], RMA_damage_PNW_exogenous_wheat[8], RMA_damage_PNW_exogenous_wheat[10], RMA_damage_PNW_exogenous_wheat[,13:16], RMA_damage_PNW_exogenous_wheat[18:19])

fit <- princomp(RMA_damage_PNW_exogenous_wheat, cor=TRUE)
#ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_wheat, scale = TRUE, center = TRUE), data = RMA_damage_PNW_transformed_wheat, colour = 'county', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 3, legend = FALSE) + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_wheat)) + theme(legend.position = "none")

plot1 <- ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_wheat, center = TRUE, scale = TRUE), frame = TRUE, frame.type = 'norm', data = RMA_damage_PNW_transformed_wheat, colour = 'state', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 2, legend = FALSE)  + theme_bw()   + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_wheat)) + theme(legend.position = "none") + ggtitle("Principle Components: PNW wheat insurance loss by county with \ndamage cause loadings ") + theme(plot.title = element_text(size =12, family = "Serif")) + theme(axis.title.y = element_text(family = "Serif", size=12), axis.title.x = element_text(family = "Serif", size = 12), axis.text.x = element_text(size=rel(1.5), hjust = 1, family = "Serif"), axis.text.y = element_text(size=rel(1.5), hjust = 1, family = "Serif"))


#scree plot

std_dev <- fit$sdev

pr_var <- std_dev^2

#pr_var[1:10]

prop_varex <- pr_var/sum(pr_var)

prop_varex <- data.frame(prop_varex)

prop_varex$comp <- c(1:max(nrow(prop_varex)))

prop_varex$prop_varex <- as.numeric(prop_varex$prop_varex)

p <- ggplot(prop_varex, aes(as.factor(comp), prop_varex, group=1))
plot2 <- p + geom_point(shape = 21) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  xlab("comp") + theme_bw() +
stat_summary(fun.y=sum, geom="line") + labs(title = "Scree plot: insurance loss for the entire PNW, for wheat by county, with \ndamage cause as the factor loadings.", x = "principle components", y = "% explained variance")

grid.arrange(plot1, plot2, nrow=2, heights=c(2,1))

```
\newpage
<br></br>

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for apples by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

#PNW apples

usePackage("ggplot2")
usePackage("ggfortify")
usePackage("reshape2")
RMA_damage_PNW_apples <- subset(RMA_damage_PNW, commodity == "APPLES")

RMA_damage_PNW_transformed_apples <- dcast(RMA_damage_PNW_apples, county + state ~ damagecause, value.var = c("loss"), sum)
RMA_damage_PNW_transformed_apples$statecounty <- paste(RMA_damage_PNW_transformed_apples$county, "_", RMA_damage_PNW_transformed_apples$state, sep="")
rownames(RMA_damage_PNW_transformed_apples) <- RMA_damage_PNW_transformed_apples$statecounty
RMA_damage_PNW_exogenous_apples <- RMA_damage_PNW_transformed_apples[,3:24]

RMA_damage_PNW_exogenous_apples <- cbind(RMA_damage_PNW_exogenous_apples[,1:4], RMA_damage_PNW_exogenous_apples[,7:10], RMA_damage_PNW_exogenous_apples[,13:14])

fit <- princomp(RMA_damage_PNW_exogenous_apples, cor=TRUE)
#PNW apples

#ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_apples), data = RMA_damage_PNW_transformed_apples, colour = 'county', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 3, legend = FALSE) + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_apples)) + theme(legend.position = "none")

plot1 <- ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_apples, center = TRUE, scale = TRUE), frame = TRUE, frame.type = 'norm', data = RMA_damage_PNW_transformed_apples, colour = 'state', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 2, legend = FALSE)  + theme_bw()   + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_apples)) + theme(legend.position = "none") + ggtitle("Principle Components: PNW apples insurance loss by county with \ndamage cause loadings ") + theme(plot.title = element_text(size =12, family = "Serif")) + theme(axis.title.y = element_text(family = "Serif", size=12), axis.title.x = element_text(family = "Serif", size = 12), axis.text.x = element_text(size=rel(1.5), hjust = 1, family = "Serif"), axis.text.y = element_text(size=rel(1.5), hjust = 1, family = "Serif"))


#scree plot

std_dev <- fit$sdev

pr_var <- std_dev^2

#pr_var[1:10]

prop_varex <- pr_var/sum(pr_var)

prop_varex <- data.frame(prop_varex)

prop_varex$comp <- c(1:max(nrow(prop_varex)))

prop_varex$prop_varex <- as.numeric(prop_varex$prop_varex)

p <- ggplot(prop_varex, aes(as.factor(comp), prop_varex, group=1))
plot2 <- p + geom_point(shape = 21) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  xlab("comp") + theme_bw() +
stat_summary(fun.y=sum, geom="line") + labs(title = "Scree plot: insurance loss for the entire PNW, for apples by county, with \n damage cause as the factor loadings.", x = "principle components", y = "% explained variance")

grid.arrange(plot1, plot2, nrow=2, heights=c(2,1))

```

\newpage
<br></br>


```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for barley by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

#PNW barley

usePackage("ggplot2")
usePackage("ggfortify")
usePackage("reshape2")

RMA_damage_PNW_barley <- subset(RMA_damage_PNW, commodity == "BARLEY")

RMA_damage_PNW_transformed_barley <- dcast(RMA_damage_PNW_barley, county + state ~ damagecause, value.var = c("loss"), sum)
RMA_damage_PNW_transformed_barley$statecounty <- paste(RMA_damage_PNW_transformed_barley$county, "_", RMA_damage_PNW_transformed_barley$state, sep="")
rownames(RMA_damage_PNW_transformed_barley) <- RMA_damage_PNW_transformed_barley$statecounty
#RMA_damage_PNW_exogenous_barley <- RMA_damage_PNW_transformed_barley[,3:23]
RMA_damage_PNW_exogenous_barley <- RMA_damage_PNW_transformed_barley

RMA_damage_PNW_exogenous_barley <- cbind(RMA_damage_PNW_exogenous_barley[,3:4], RMA_damage_PNW_exogenous_barley[7], RMA_damage_PNW_exogenous_barley[9], RMA_damage_PNW_exogenous_barley[,12:15], RMA_damage_PNW_exogenous_barley[17:18])

fit <- princomp(RMA_damage_PNW_exogenous_barley, cor=TRUE)

#PNW barley

#ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_barley), data = RMA_damage_PNW_transformed_barley, colour = 'county', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 3, legend = FALSE) + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_barley)) + theme(legend.position = "none")

plot2 <- ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous_barley, center = TRUE, scale = TRUE), frame = TRUE, frame.type = 'norm', data = RMA_damage_PNW_transformed_barley, colour = 'state', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 2, legend = FALSE)  + theme_bw()   + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous_barley)) + theme(legend.position = "none") + ggtitle("Principle Components: PNW barley insurance loss by county with \ndamage cause loadings ") + theme(plot.title = element_text(size =12, family = "Serif")) + theme(axis.title.y = element_text(family = "Serif", size=12), axis.title.x = element_text(family = "Serif", size = 12), axis.text.x = element_text(size=rel(1.5), hjust = 1, family = "Serif"), axis.text.y = element_text(size=rel(1.5), hjust = 1, family = "Serif"))


#scree plot

std_dev <- fit$sdev

pr_var <- std_dev^2

#pr_var[1:10]

prop_varex <- pr_var/sum(pr_var)

prop_varex <- data.frame(prop_varex)

prop_varex$comp <- c(1:max(nrow(prop_varex)))

prop_varex$prop_varex <- as.numeric(prop_varex$prop_varex)

p <- ggplot(prop_varex, aes(as.factor(comp), prop_varex, group=1))
plot2 <- p + geom_point(shape = 21) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  xlab("comp") + theme_bw() +
stat_summary(fun.y=sum, geom="line") + labs(title = "Scree plot: insurance loss for the entire PNW, for barley by county, with \ndamage cause as the factor loadings.", x = "principle components", y = "% explained variance")

grid.arrange(plot1, plot2, nrow=2, heights=c(2,1))

```

\newpage
<br></br>


```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 6, fig.cap=paste("24 county inland Pacific Northwest (iPNW) study area. ")}

usePackage("data.table")
usePackage("maptools")
usePackage("classInt")
usePackage("leaflet")
usePackage("dplyr")
usePackage("raster")
usePackage("htmltools")

usePackage("sp")
usePackage("ggplot2")
usePackage("ggmap")
usePackage("maps")
usePackage("mapdata")

#URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/states/states_conus.zip"
#destfile <- "/tmp/seamon/states_conus.zip"
#download.file(URL, destfile)
#outDir<-"/tmp/seamon"
#unzip(destfile,exdir=outDir)

states <- readShapePoly('/tmp/seamon/states_conus/states_conus.shp',
                        proj4string=CRS
                        ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")



#setwd("/dmine/data/counties/")


#URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/counties/threestate_palouse.zip"
#destfile <- "/tmp/seamon/threestate_palouse.zip"
#download.file(URL, destfile)
#outDir<-"/tmp/seamon"
#unzip(destfile,exdir=outDir)

counties <- readShapePoly('/tmp/seamon/threestate_palouse/threestate_palouse.shp',
                     proj4string=CRS
                     ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")


#pal <- colorNumeric(palette = c("white", "orange", "darkorange", "red", "darkred"),
#                    domain = counties$NAME)
exte <- as.vector(extent(counties))

#label <- paste(sep = "<br/>", counties$NAME, round(counties$NAME, 0))
#markers <- data.frame(label)
#labs <- as.list(counties$NAME)

counties <- counties[counties$NAME != "Kootenai",]
counties <- counties[counties$NAME != "Clearwater",]


      lat_long <- coordinates(counties)

 counties_a <- data.frame(counties)
      labs <- lapply(seq(nrow(counties_a)), function(i) {
        paste0(as.character(counties_a[i, "NAME"]))
      })

#leaflet(data = counties, options = leafletOptions(minZoom = 6, maxZoom = 6)) %>%  addProviderTiles("Stamen.TonerLite") %>% fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(color = "blue",  weight = 1) %>%

usePackage("mapproj")

map("worldHires","Canada", xlim=c(-125,-112),ylim=c(43.5,49.5), col="gray90", fill=TRUE)  #plot the region of Canada I want

map("worldHires","usa", xlim=c(-125,-112),ylim=c(43.5,49.5), col="gray95", fill=TRUE, add=TRUE)  #add the adjacent parts of the US; can't forget my homeland

plot(counties_palouse, add=TRUE, col=alpha("yellow", 0.6), border=FALSE)  
lines(counties_palouse)
lines(states)

box(lty = 1, col = 'black')

map.scale(x=-121, y=44, ratio=FALSE, relwidth=0.17) 

# Inmap
par(usr=c(-129, 100, 22, 152))
rect(xleft =-126.2,ybottom = 23.8,xright = -65.5,ytop = 50.6,col = "white")
map("usa", xlim=c(-126.2,-65.5), ylim=c(23.8,50.6),add=T)
map("state", xlim=c(-126.2,-65.5), ylim=c(23.8,50.6),add=T, boundary = F, interior = T, lty=2)
#map("state", region="california", fill=T, add=T)
#points(-121.6945, 39.36708, bg = "white", pch = 21)
map("state", region=c("washington", "Idaho", "Oregon"), fill=T, add=T) 


#mapz <- leaflet(data = counties, options = leafletOptions(zoomControl = FALSE, zoomSnap = .4, zoomDelta = .4)) %>%  
 # addProviderTiles(providers$Hydda.Base) %>%
#   addProviderTiles(providers$Stamen.TonerLines) %>% 
  
 
  
#  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(color = "lightyellow",  fillOpacity = .8, weight = 1) %>%  addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>%  addPolygons(color = "gray",  fillOpacity = 0, weight = 2) %>%  

  
 # addMiniMap(
#    tiles = providers$Stamen.TonerLite,
#    position = 'topleft', 
#    width = 175, height = 175,
#    toggleDisplay = FALSE) %>%
  
  
#addLabelOnlyMarkers(data = counties, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "16px", color = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE, col = "white")
#)) 
        
#addScaleBar(mapz, position = c("topright"), options = scaleBarOptions())



#markerOptions(map, riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")


```

\newpage


```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for barley by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

palouse_sumloss_aggregate <- subset(RMA_damage_IPNW, year >= 2001 & year <= 2015) 

#palouse_sumloss_1989_2015 <- subset(palouse_sumloss_aggregate, commodity == "WHEAT")

palouse_sumloss_1989_2015 <- aggregate(RMA_damage_IPNW$loss, list(RMA_damage_IPNW$year), FUN = "sum")

colnames(palouse_sumloss_1989_2015) <- c("year", "loss")

#palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 

X <- palouse_sumloss_1989_2015

#X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")

XX <- X
#XX <- subset(X, loss > 1000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

#YYY1<- YYY1[seq(dim(YYY1)[1],1),]
YYY1$loss <- round(YYY1$loss, 0)
#grid.table(YYY1, theme = tt3, rows = NULL)

YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

dd2 <- cbind(YYY2[1:15, ])
colnames(dd2) <- c("year", "loss")
dd2[is.na(dd2)] <- ""


par(mar=c(6, 8.1, 6, 2.1), family = 'serif', mgp=c(6, 1, 0), las=0)
#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$year, las = 3, cex.names = 1, yaxt="n", col = "lightblue") 
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""), cex.axis = 1)
graphics::title(main="IPNW total insurance loss: 2001 to 2015", line = 1, cex.main = 1, adj = 0)
graphics::title(xlab="Years", line=4, cex.lab = 1)
graphics::title(ylab="Insurance claim loss ($)", line=6.5, cex.lab = 1)

#abline(v = 14.5, lty = 2, color = "red")

```


\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for barley by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

#htmlTable(dd2,
#          cgroup = c("2001-2015"),
#          n.cgroup = c(2),
 #         caption = "IPNW region total insurance loss by year, 2001-2015",
#          align = "c",
 #         rnames = FALSE,
#          css.cell = "padding-left: .5em; padding-right: .5em;")





usePackage("plotly")
usePackage("gridExtra")
usePackage("stringi")

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}


#palouse_sumloss_aggregate <- subset(palouse_sumloss_aggregate, year >= 1989 & year <= 201)
palouse_sumloss_1989_2015 <- aggregate(palouse_sumloss_aggregate$loss, list(palouse_sumloss_aggregate$commodity), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("commodity", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
XX <- subset(X, loss > 15000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

YYY1<- YYY1[seq(dim(YYY1)[1],1),]
#grid.table(YYY1, theme = tt3)


YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

YYY2 <- subset(YYY2, commodity != "ADJUSTED GROSS REVENUE")


#kable(YYY1, format = "html", row.names = FALSE) %>% kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE)


YYY1 <- subset(YYY1, commodity != "ADJUSTED GROSS REVENUE")
YYY1 <- subset(YYY1, commodity != "ADJUSTED GROSS REVENUE-LITE")

par(mar=c(8, 9.1, 6, 2.1), family = 'serif', mgp=c(6, 1, 0), las=0)

YYY1$commodity<- tolower(YYY1$commodity)
YYY1$commodity <- stri_trans_general(YYY1$commodity, id = "Title")


#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$commodity, cex.names = 1, las = 3, yaxt="n", cex.lab = 1, col = "lightblue") 
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, "M", sep = ""))

graphics::title(main="IPNW total insurance loss by commodity: 2001 to 2015", line = 1, cex.main = 1, adj = 0)
graphics::title(xlab="Commodity", line=6, cex.lab = 1)
graphics::title(ylab="Insurance claim loss ($)", line=6.5, cex.lab = 1)


#htmlTable(YYY2,
#          cgroup = c("2001-2015"),
#          caption = "IPNW region total insurance loss by commodity, 2001-2015",
#          align = "c",
#          rnames = FALSE,
#          css.cell = "padding-left: .5em; padding-right: .5em;")

```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for barley by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

#palouse_sumloss_1989_2015 <- subset(palouse_sumloss_aggregate, commodity == "WHEAT")
palouse_sumloss_1989_2015 <- aggregate(palouse_sumloss_aggregate$loss, list(palouse_sumloss_aggregate$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("commodity", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
XX <- subset(X, loss > 10000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))


YYY1<- YYY1[seq(dim(YYY1)[1],1),]

YYY2 <- YYY1
levels(YYY2$commodity)[10] <- "Excessive Moisture"
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)
colnames(YYY2) <- c("damage cause", "loss")

#YYY2 <- subset(YYY2, commodity != "ADJUSTED GROSS REVENUE")


#grid.table(YYY1, theme = tt3)
#kable(YYY1, format = "html", row.names = FALSE) %>% kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE)

par(mar=c(10, 9.8, 6, 2.1), family = 'serif', mgp=c(2, 1, 0), las=0)
levels(YYY1$commodity)[10] <- "Excessive Moisture"
barplot(YYY1$loss, names.arg = YYY1$commodity, cex.names = 1, las = 3, yaxt="n", col = "lightblue")
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, "M", sep = ""))

#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 7.8)

graphics::title(main="IPNW total insurance loss by damage cause: 2001 to 2015", line = 1, cex.main = 1, adj = 0)
graphics::title(xlab="Damage Cause", line=8, cex.lab = 1)
graphics::title(ylab="Insurance claim loss ($)", line=7, cex.lab = 1)

#htmlTable(YYY2,
#          cgroup = c("2001-2015"),
#          caption = "IPNW region total insurance loss by damage cause, 2001-2015",
#          align = "c",
#          rnames = FALSE,
#          css.cell = "padding-left: .5em; padding-right: .5em;")


```


\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for barley by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

usePackage("plotly")
usePackage("gridExtra")
usePackage("knitr")
usePackage("kableExtra")
usePackage("htmlTable")
usePackage("stringi")

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}


palouse_sumloss_1989_2015_lossperacres <- aggregate(RMA_damage_IPNW$lossperacre, list( RMA_damage_IPNW$year, RMA_damage_IPNW$state, RMA_damage_IPNW$commodity), FUN = "mean")



colnames(palouse_sumloss_1989_2015_lossperacres) <- c("year", "state", "commodity",  "lossperacres")

palouse_sumloss_1989_2015_lossperacres2 <- aggregate(RMA_damage_IPNW$lossperacre, list( RMA_damage_IPNW$year, RMA_damage_IPNW$damagecause), FUN = "mean")

colnames(palouse_sumloss_1989_2015_lossperacres2) <- c("year", "damagecause", "lossperacres")

#palouse_sumloss_1989_2015_lossperacres <- subset(palouse_sumloss_1989_2015_lossperacres, lossperacres > 200)
#palouse_sumloss_1989_2015_lossperacres2 <- subset(palouse_sumloss_1989_2015_lossperacres2, lossperacres > 200)

#palouse_sumloss_1989_2015_lossperacres <- subset(palouse_sumloss_1989_2015_lossperacres, commodity != "ADJUSTED GROSS REVENUE")
#palouse_sumloss_1989_2015_lossperacres <- subset(palouse_sumloss_1989_2015_lossperacres, commodity != "Other (Snow/Lightning-Etc.)")

palouse_sumloss_1989_2015_lossperacres2$damagecause <- factor(palouse_sumloss_1989_2015_lossperacres2$damagecause)

palouse_sumloss_1989_2015_lossperacres$commodity <- factor(palouse_sumloss_1989_2015_lossperacres$commodity)


levels(palouse_sumloss_1989_2015_lossperacres$commodity)[13] <- "APRICOTS"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[14] <- "FREESTONE PEACHES"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[15] <- "NECTARINES"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[22] <- "PASTURE, RANGELAND"

levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[8] <- "Excessive Moisture"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[23] <- "Snow/Lightning"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[21] <- "Lack Irrig Prep"






palouse_sumloss_1989_2015_loss <- aggregate(RMA_damage_IPNW$loss, by = list( RMA_damage_IPNW$year, RMA_damage_IPNW$commodity), FUN = "sum")

colnames(palouse_sumloss_1989_2015_loss) <- c("year", "commodity",  "loss")

palouse_sumloss_1989_2015_loss2 <- aggregate(RMA_damage_IPNW$loss, list( RMA_damage_IPNW$year, RMA_damage_IPNW$damagecause), FUN = "sum")

colnames(palouse_sumloss_1989_2015_loss2) <- c("year", "damagecause", "loss")

psloss <- palouse_sumloss_1989_2015_loss

palouse_sumloss_1989_2015_loss <- subset(palouse_sumloss_1989_2015_loss, loss > 10000000)
palouse_sumloss_1989_2015_loss2 <- subset(palouse_sumloss_1989_2015_loss2, loss > 10000000)

palouse_sumloss_1989_2015_loss <- subset(palouse_sumloss_1989_2015_loss, commodity != "ADJUSTED GROSS REVENUE")

palouse_sumloss_1989_2015_loss2$damagecause <- factor(palouse_sumloss_1989_2015_loss2$damagecause)

palouse_sumloss_1989_2015_loss$commodity <- factor(palouse_sumloss_1989_2015_loss$commodity)


levels(palouse_sumloss_1989_2015_loss2$damagecause)[4] <- "Excessive Moisture"






palouse_sumloss_1989_2015_count <- aggregate(RMA_damage_IPNW$count, list( RMA_damage_IPNW$year, RMA_damage_IPNW$state, RMA_damage_IPNW$commodity), FUN = "sum")

colnames(palouse_sumloss_1989_2015_count) <- c("year", "state", "commodity",  "loss")

palouse_sumloss_1989_2015_count2 <- aggregate(RMA_damage_IPNW$count, list( RMA_damage_IPNW$year, RMA_damage_IPNW$damagecause), FUN = "sum")

colnames(palouse_sumloss_1989_2015_count2) <- c("year", "damagecause", "loss")

#-boxplots of count data for all commodities and all damage causes- 1989-2015

palouse_sumloss_1989_2015_count <- subset(palouse_sumloss_1989_2015_count, loss > 50)
palouse_sumloss_1989_2015_count2 <- subset(palouse_sumloss_1989_2015_count2, loss > 50)

palouse_sumloss_1989_2015_count <- subset(palouse_sumloss_1989_2015_count, commodity != "ADJUSTED GROSS REVENUE")

palouse_sumloss_1989_2015_count2$damagecause <- factor(palouse_sumloss_1989_2015_count2$damagecause)

palouse_sumloss_1989_2015_count$commodity <- factor(palouse_sumloss_1989_2015_count$commodity)


levels(palouse_sumloss_1989_2015_count2$damagecause)[5] <- "Excessive Moisture"
#levels(palouse_sumloss_1989_2015_count2$damagecause)[11] <- "Other"


#proper=function(x) paste0(toupper(substr(x, 1, 1)), tolower(substring(x, 2)))

palouse_sumloss_1989_2015_count$commodity <- tolower(palouse_sumloss_1989_2015_count$commodity)
palouse_sumloss_1989_2015_count$commodity <- stri_trans_general(palouse_sumloss_1989_2015_count$commodity, id = "Title")

par(mar=c(9.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_count$loss ~ palouse_sumloss_1989_2015_count$commodity, col = 'lightblue', ylab = "Insurance Claim Frequency", yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_count$commodity, las = 3, cex.axis = 1, cex.main = 1, cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1)
axis(2, las = 1, cex.axis = 1, at = pretty(palouse_sumloss_1989_2015_count$loss), labels = pretty(palouse_sumloss_1989_2015_count$loss))

stripchart(palouse_sumloss_1989_2015_count$loss ~ palouse_sumloss_1989_2015_count$commodity, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20, col="blue" )

graphics::title(xlab="Commodity", line=7.5, cex.lab = 1)
graphics::title(main="IPNW insurance claims by commodity: 2001 to 2015", line = 2, adj = 0, cex.main = 1)

```

\newpage


```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for barley by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

par(mar=c(12.7, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_count2$loss ~ palouse_sumloss_1989_2015_count2$damagecause, col = 'lightblue', ylab = "Insurance Claim Frequency",  yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_count2$damagecause, las = 3, cex.main = 1, cex.lab = 1, cex.axis = 1, cex.names = 1, font.lab = 1, font.axis = 1, outline = FALSE)
axis(2, las = 1, cex.axis = 1, at = pretty(palouse_sumloss_1989_2015_count2$loss), labels = pretty(palouse_sumloss_1989_2015_count2$loss))

graphics::title(xlab="Damage Cause", line=11.5, cex.lab = 1)
graphics::title(main="IPNW insurance claims by damage cause: 2001 to 2015", line = 2, adj = 0, cex.main = 1)

stripchart(palouse_sumloss_1989_2015_count2$loss ~ palouse_sumloss_1989_2015_count2$damagecause, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20, col="blue" )



```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for barley by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

par(mar=c(8, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

means <- aggregate(loss ~  commodity, palouse_sumloss_1989_2015_loss, mean)

palouse_sumloss_1989_2015_loss$commodity <- tolower(palouse_sumloss_1989_2015_loss$commodity)
palouse_sumloss_1989_2015_loss$commodity <- stri_trans_general(palouse_sumloss_1989_2015_loss$commodity, id = "Title")

boxplot(palouse_sumloss_1989_2015_loss$loss ~ palouse_sumloss_1989_2015_loss$commodity, col = 'lightblue', ylab = "Insurance Claim Loss ($)", yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_loss$commodity, las = 3, cex.axis = 1, cex.main = 1, cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1, outline = FALSE)
#axis(2, las = 1, cex.axis = 1.2, at = pretty(palouse_sumloss_1989_2015_loss$loss), labels = pretty(palouse_sumloss_1989_2015_loss$loss))

pts <- pretty(palouse_sumloss_1989_2015_loss$loss / 1000000)
pts2 <- pretty(palouse_sumloss_1989_2015_loss$loss)
axis(2, las = 1, cex.axis = 1, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")
stripchart(palouse_sumloss_1989_2015_loss$loss ~ palouse_sumloss_1989_2015_loss$commodity, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20, col="blue")

graphics::title(xlab="Commodity", line=6, cex.lab = 1)
graphics::title(main="IPNW insurance loss by commodity: 2001 to 2015", line = 2, adj = 0, cex.main = 1)

#points(1:nrow(means), means$loss, col = "red")
#text(1:nrow(means), means$loss + 0.08, labels = means$loss)

```


\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for barley by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

par(mar=c(12.2, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_loss2$loss ~ palouse_sumloss_1989_2015_loss2$damagecause, col = 'lightblue', ylab = "Insurance Claim Loss ($)",  yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_loss2$damagecause, las = 3, cex.lab = 1, cex.axis = 1, cex.names = 1, font.lab = 1, font.axis = 1, outline = FALSE)
#axis(2, las = 1, cex.axis = 1.2, at = pretty(palouse_sumloss_1989_2015_loss2$loss), labels = pretty(palouse_sumloss_1989_2015_loss2$loss))
pts <- pretty(palouse_sumloss_1989_2015_loss2$loss / 1000000)
pts2 <- pretty(palouse_sumloss_1989_2015_loss2$loss)
axis(2, las = 1, cex.axis = 1, at = pts2, labels = paste(pts, "M", sep = ""))
stripchart(palouse_sumloss_1989_2015_loss2$loss ~ palouse_sumloss_1989_2015_loss2$damagecause, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20, col="blue" )

graphics::title(xlab="Damage Cause", line=11, cex.lab = 1)
graphics::title(main="IPNW insurance loss by damage cause: 2001 to 2015", line = 2, adj = 0, cex.main = 1)

```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for barley by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

par(mar=c(11.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

palouse_sumloss_1989_2015_lossperacres$commodity <- tolower(palouse_sumloss_1989_2015_lossperacres$commodity)
palouse_sumloss_1989_2015_lossperacres$commodity <- stri_trans_general(palouse_sumloss_1989_2015_lossperacres$commodity, id = "Title")

palouse_sumloss_1989_2015_lossperacres$commodity <- factor(palouse_sumloss_1989_2015_lossperacres$commodity)
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[1] <- "Gross Revenue"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[2] <- "Gross Revenue-Lite"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[33] <- "Farm Rev Protection"

boxplot(palouse_sumloss_1989_2015_lossperacres$loss ~ palouse_sumloss_1989_2015_lossperacres$commodity, col = 'lightblue', ylab = "Insurance Claim Loss per Acre ($)", yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_lossperacres$commodity, las = 3, cex.axis = 1, cex.main = 1, cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1, outline = FALSE)
axis(2, las = 1, cex.axis = 1, at = pretty(palouse_sumloss_1989_2015_lossperacres$loss), labels = pretty(palouse_sumloss_1989_2015_lossperacres$loss))

stripchart(palouse_sumloss_1989_2015_lossperacres$loss ~ palouse_sumloss_1989_2015_lossperacres$commodity, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20, col="blue" )

graphics::title(xlab="Commodity", line=10.5, cex.lab = 1)
graphics::title(main="IPNW insurance loss per acre by commodity: 2001 to 2015", line = 2, adj = 0, cex.main = 1)


```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the entire PNW, for barley by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

par(mar=c(11.8, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)


palouse_sumloss_1989_2015_lossperacres2$damagecause <- factor(palouse_sumloss_1989_2015_lossperacres2$damagecause)
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[20] <- "Snow/Lightning"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[27] <- "No Prep for Irr"
palouse_sumloss_1989_2015_lossperacres2$damagecause <- factor(palouse_sumloss_1989_2015_lossperacres2$damagecause)
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[26] <- "No Prep for Irr"
palouse_sumloss_1989_2015_lossperacres2$damagecause <- factor(palouse_sumloss_1989_2015_lossperacres2$damagecause)


boxplot(palouse_sumloss_1989_2015_lossperacres2$loss ~ palouse_sumloss_1989_2015_lossperacres2$damagecause, col = 'lightblue', ylab = "Insurance Caim Loss per Acre ($)",  yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_lossperacres2$damagecause, las = 3, cex.main = 1, cex.lab = 1, cex.axis = 1, cex.names = 1, font.lab = 1, font.axis = 1, outline = FALSE)
axis(2, las = 1, cex.axis = 1, at = pretty(palouse_sumloss_1989_2015_lossperacres2$loss), labels = pretty(palouse_sumloss_1989_2015_lossperacres2$loss))

graphics::title(xlab="Damage Cause", line=10.5, cex.lab = 1)
graphics::title(main="IPNW insurance loss per acre by damage cause: 2001 to 2015", line = 2, adj = 0, cex.main = 1)

stripchart(palouse_sumloss_1989_2015_lossperacres2$loss ~ palouse_sumloss_1989_2015_lossperacres2$damagecause, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20, col="blue" )


```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

#all PNW by damage

usePackage("ggplot2")
usePackage("ggfortify")
usePackage("reshape2")
usePackage("gridExtra")


RMA_damage_PNW_transformed <- dcast(RMA_damage_PNW, county + state ~ damagecause, value.var = c("loss"), sum)
RMA_damage_PNW_transformed$statecounty <- paste(RMA_damage_PNW_transformed$county, "_", RMA_damage_PNW_transformed$state, sep="")
rownames(RMA_damage_PNW_transformed) <- RMA_damage_PNW_transformed$statecounty
RMA_damage_PNW_exogenous <- RMA_damage_PNW_transformed[,3:32]
par(mar=c(8, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

fit <- stats::princomp(RMA_damage_PNW_exogenous, cor=TRUE)
plot1 <- ggplot2::autoplot(prcomp(RMA_damage_PNW_exogenous, center = TRUE, scale = TRUE), frame = TRUE, frame.type = 'norm', data = RMA_damage_PNW_transformed, colour = 'state', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 3, label = FALSE, label.size = 2, legend = FALSE)  + theme_bw()   + geom_text(vjust=-1, label=rownames(RMA_damage_PNW_exogenous)) + theme(legend.position = "none") + ggtitle("Principle Components: IPNW insurance loss by county with \ndamage cause loadings: 2001 to 2015") + theme(plot.title = element_text(size =12, family = "Serif")) + theme(axis.title.y = element_text(family = "Serif", size=12), axis.title.x = element_text(family = "Serif", size = 12), axis.text.x = element_text(size=rel(1.5), hjust = 1, family = "Serif"), axis.text.y = element_text(size=rel(1.5), hjust = 1, family = "Serif"))

par(mar=c(8, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

#scree plot

std_dev <- fit$sdev

pr_var <- std_dev^2

#pr_var[1:10]

prop_varex <- pr_var/sum(pr_var)

prop_varex <- data.frame(prop_varex)

prop_varex$comp <- c(1:max(nrow(prop_varex)))

prop_varex$prop_varex <- as.numeric(prop_varex$prop_varex)

p <- ggplot(prop_varex, aes(as.factor(comp), prop_varex, group=1))
plot2 <- p + geom_point(shape = 21) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  xlab("comp") + theme_bw() +
stat_summary(fun.y=sum, geom="line") + labs(title = "Scree plot of insurance loss for the inland PNW, for all commodities by county, with \ndamage cause as the factor loadings.", x = "principle components", y = "% explained variance")

grid.arrange(plot1, plot2, nrow=2, heights=c(2,1))

```

\newpage

```{r message=FALSE, warning=FALSE, echo = FALSE, error=TRUE}

#--reduce years to 2001-2015
xxyear <- subset(RMA_damage_IPNW, year >= 2001)
xxyear$log10_loss <- log10(xxyear$loss)

#missing data review of data from 2001-2015 for all commodities and all damage causes
#ezDesign(xxyear, year, damagecause)
#ezDesign(xxyear, county, damagecause)
#ezDesign(xxyear, county, commodity)

#Now lets subset by the four main commodities of interest.
#--subset to four commodities - Barley, Wheat, Apples, and Dry Peas
xx <- subset(xxyear, commodity == "BARLEY" | commodity == "WHEAT" | 
               commodity == "APPLES" | commodity == "DRY PEAS" | commodity == "CHERRIES" | commodity == "BARLEY")

#--subset to a select set of damage causes - Drought, Heat, Hail, Frost, Freeze, Excessive Moisture, Cold Winter, Cold Weather, and Decline in Price
xxx <- subset(xx, damagecause == "Drought" | damagecause == "Heat" | 
                damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze" | damagecause == "Excessive Moisture/Precip/Rain" | damagecause == "Cold Winter" | 
                damagecause == "Cold Wet Weather" | damagecause == "Decline in Price")


#examine missing data after narrowing commodities and damage causes to the most relevant
#ezDesign(xxx, year, damagecause)
#ezDesign(xxx, county, year)
#ezDesign(xxx, county, damagecause)
#ezDesign(xxx, year, commodity)
#ezDesign(xxx, county, commodity)

#palouse_sumloss_aggregate <- xxx

#now lets divide the data into four different model files that are commodity specific.
xxx_wheat <- subset(xxx, commodity == "WHEAT")
xxx_apples <- subset(xxx, commodity == "APPLES")
xxx_cherries <- subset(xxx, commodity == "CHERRIES")
xxx_drypeas <- subset(xxx, commodity == "DRY PEAS")
xxx_barley <- subset(xxx, commodity == "BARLEY")

palouse_sumloss_aggregate_apples <- xxx_apples
palouse_sumloss_aggregate_cherries <- xxx_cherries
palouse_sumloss_aggregate_drypeas <- xxx_drypeas
palouse_sumloss_aggregate_wheat <- xxx_wheat
palouse_sumloss_aggregate_barley <- xxx_barley

#-remove counties for each commodity file that have considerable missing data.  
#the reasoning is that those counties that have very little of the commodity in question
#may be inappropriate to fill in data as zero.  While there are sporadic commodity loss
#for these counties, there is a high liklihood that this commodity may NOT be grown
#for the missing years, vs just no commodity loss claims.  So we remove these select
#counties given the EzDesign data review of each commodity file

palouse_sumloss_aggregate_apples <- subset(palouse_sumloss_aggregate_apples, 
                                           county != "Columbia" & county != "Wasco")
palouse_sumloss_aggregate_apples$county <- 
  factor(palouse_sumloss_aggregate_apples$county)

palouse_sumloss_aggregate_apples <- 
  subset(palouse_sumloss_aggregate_apples, damagecause != "Drought")
palouse_sumloss_aggregate_apples$damagecause <- 
  factor(palouse_sumloss_aggregate_apples$damagecause)


palouse_sumloss_aggregate_wheat <- 
  subset(palouse_sumloss_aggregate_wheat, county != "Kootenai")
palouse_sumloss_aggregate_wheat$county <- 
  factor(palouse_sumloss_aggregate_wheat$county)

palouse_sumloss_aggregate_cherries <- 
  subset(palouse_sumloss_aggregate_cherries, county != "Adams" & county != "Union")
palouse_sumloss_aggregate_cherries$county <- 
  factor(palouse_sumloss_aggregate_cherries$county)

palouse_sumloss_aggregate_drypeas <- 
  subset(palouse_sumloss_aggregate_drypeas, county != "Douglas" 
         & county != "Gilliam" & county != "Adams")
palouse_sumloss_aggregate_drypeas$county <- 
  factor(palouse_sumloss_aggregate_drypeas$county)

palouse_sumloss_aggregate_barley <- 
  subset(palouse_sumloss_aggregate_barley, county != "Douglas" & county != "Garfield"
         & county != "Gilliam" & county != "Adams" & county != "Kootenai" & county != "Benton")
palouse_sumloss_aggregate_barley$county <- 
  factor(palouse_sumloss_aggregate_barley$county)

palouse_sumloss_aggregate_barley <- 
  subset(palouse_sumloss_aggregate_barley, damagecause != "Cold Winter")
palouse_sumloss_aggregate_barley$damagecause <- 
  factor(palouse_sumloss_aggregate_barley$damagecause)

#re-factor 

palouse_sumloss_aggregate_apples$damagecause <- factor(palouse_sumloss_aggregate_apples$damagecause)
palouse_sumloss_aggregate_wheat$damagecause <- factor(palouse_sumloss_aggregate_wheat$damagecause)
palouse_sumloss_aggregate_cherries$damagecause <- factor(palouse_sumloss_aggregate_cherries$damagecause)
palouse_sumloss_aggregate_drypeas$damagecause <- factor(palouse_sumloss_aggregate_drypeas$damagecause)
palouse_sumloss_aggregate_barley$damagecause <- factor(palouse_sumloss_aggregate_barley$damagecause)

```


```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

usePackage("plotly")
usePackage("gridExtra")

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

APPLES <- subset(RMA_damage_IPNW, commodity == "APPLES")

palouse_sumloss_1989_2015 <- aggregate(APPLES$loss, list(APPLES$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 1500000) 
summary_dataset2 <- X %>% filter(loss > 1500000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

#--year
palouse_sumloss_year <- aggregate(APPLES$loss, list(APPLES$year), FUN = "sum")
colnames(palouse_sumloss_year) <- c("year", "loss")

#--county

palouse_sumloss_county <- aggregate(APPLES$loss, list(APPLES$county), FUN = "sum")
colnames(palouse_sumloss_county) <- c("county", "loss")

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' million'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for APPLES, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

p <- plot_ly(palouse_sumloss_year, labels = ~year, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' million'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Years for APPLES, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

p <- plot_ly(palouse_sumloss_county, labels = ~county, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' million'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Counties for APPLES, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

           
#p

YYY2 <- YYY1
YYY2$loss <- round(YYY2$loss, digits = 0)
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

#--year
palouse_sumloss_year <- aggregate(APPLES$loss, list(APPLES$year), FUN = "sum")
colnames(palouse_sumloss_year) <- c("year", "loss")

#--county

palouse_sumloss_county <- aggregate(APPLES$loss, list(APPLES$county), FUN = "sum")
colnames(palouse_sumloss_county) <- c("county", "loss")

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(palouse_sumloss_county$loss, names.arg = palouse_sumloss_county$county, cex.names = 1, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(palouse_sumloss_county$loss / 1000000)
pts2 <- pretty(palouse_sumloss_county$loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, "M", sep = ""))

#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 8)

graphics::title(main="Apples insurance loss by commodity: 2001 to 2015", line = 2, cex.main = 1, adj = 0)
graphics::title(xlab="Counties", line=8, cex.lab = 1)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1)

```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(palouse_sumloss_year$loss, names.arg = palouse_sumloss_year$year, cex.names = 1.4, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(palouse_sumloss_year$loss / 1000000)
pts2 <- pretty(palouse_sumloss_year$loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, "M", sep = ""))

#mtext(text = "Years",
#      side = 1,#side 1 = bottom
#      line = 8)

graphics::title(main="Apples insurance loss by year: 2001 to 2015", line = 2, cex.main = 1, adj = 0)
graphics::title(xlab="Years", line=8, cex.lab = 1)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1)

```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(YYY1$loss, names.arg = YYY1$damagecause, cex.names = 1, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, "M", sep = ""))

#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 8)

graphics::title(main="Apples insurance loss by damage cause: 2001 to 2015", line = 2, cex.main = 1, adj = 0)
graphics::title(xlab="Damage Cause", line=11, cex.lab = 1)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1)


#htmlTable(YYY2,
#          cgroup = c("2001-2015"),
#           caption = "IPNW region APPLES total insurance loss by damage cause, 2001-2015",
#          align = "c",
#          rnames = FALSE,
#          css.cell = "padding-left: .5em; padding-right: .5em;")

```

\newpage


```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

usePackage("maptools")

states <- readShapePoly('/tmp/seamon/states_conus/states_conus.shp', 
                                  proj4string=CRS
                                  ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
        projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

#--interaction plot loss vs year for all damage causes, all Palouse counties

APPLES <- subset(RMA_damage_IPNW, commodity == "APPLES")

levels(APPLES$damagecause)[10] <- "Excessive Moisture"
APPLES$damagecause <- factor(APPLES$damagecause)

APPLES_damage <- subset(APPLES, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze" | damagecause == "Cold Wet Weather" | damagecause == "Wind/Excess Wind" | damagecause == "Heat")

APPLES_damage$damagecause <- factor(APPLES_damage$damagecause)
#aggregate(WHEAT_damage$loss, list(WHEAT_damage$damagecause), FUN = "sum")

usePackage("scales")

APPLES_damage_top <- subset(APPLES_damage, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")
APPLES_damage_top <- subset(APPLES_damage_top, year >= 2001 & year <= 2015)


APPLES_damage_top_agg_hailfrostfreeze <- aggregate(APPLES_damage_top$loss, by = list(APPLES_damage_top$county), FUN = "sum")
colnames(APPLES_damage_top_agg_hailfrostfreeze) <- c("NAME", "loss")

county_apples_hailfrostfreeze <- merge(counties, APPLES_damage_top_agg_hailfrostfreeze, by = "NAME")

#2013

APPLES_damage_top2013 <- subset(APPLES_damage, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")
APPLES_damage_top2013 <- subset(APPLES_damage_top2013, year == 2013)



APPLES_damage_top_agg_hailfrostfreeze2013 <- aggregate(APPLES_damage_top2013$loss, by = list(APPLES_damage_top2013$county), FUN = "sum")
colnames(APPLES_damage_top_agg_hailfrostfreeze2013) <- c("NAME", "loss")

county_apples_hailfrostfreeze2013 <- merge(counties, APPLES_damage_top_agg_hailfrostfreeze2013, by = "NAME")

#2006

APPLES_damage_top2006 <- subset(APPLES_damage, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")
APPLES_damage_top2006 <- subset(APPLES_damage_top2006, year == 2006)



APPLES_damage_top_agg_hailfrostfreeze2006 <- aggregate(APPLES_damage_top2006$loss, by = list(APPLES_damage_top2006$county), FUN = "sum")
colnames(APPLES_damage_top_agg_hailfrostfreeze2006) <- c("NAME", "loss")

county_apples_hailfrostfreeze2006 <- merge(counties, APPLES_damage_top_agg_hailfrostfreeze2006, by = "NAME")


#how many claims of hail in walla walla in 2006?  2!

apples_hailfrostfreeze_count2006 <- subset(RMA_damage_IPNW, commodity == "APPLES")
apples_hailfrostfreeze_count2006 <- subset(apples_hailfrostfreeze_count2006, year == "2006")
apples_hailfrostfreeze_count2006 <- subset(apples_hailfrostfreeze_count2006, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")


apples_hailfrostfreeze_count2006_sum <- aggregate(apples_hailfrostfreeze_count2006$count, by=list(apples_hailfrostfreeze_count2006$county), FUN = "sum")
colnames(apples_hailfrostfreeze_count2006_sum) <- c("county", "count")



#2015

APPLES_damage_top2015 <- subset(APPLES_damage, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")
APPLES_damage_top2015 <- subset(APPLES_damage_top2015, year == 2015)



APPLES_damage_top_agg_hailfrostfreeze2015 <- aggregate(APPLES_damage_top2015$loss, by = list(APPLES_damage_top2015$county), FUN = "sum")
colnames(APPLES_damage_top_agg_hailfrostfreeze2015) <- c("NAME", "loss")

county_apples_hailfrostfreeze2015 <- merge(counties, APPLES_damage_top_agg_hailfrostfreeze2015, by = "NAME")


#2012

APPLES_damage_top2012 <- subset(APPLES_damage, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")
APPLES_damage_top2012 <- subset(APPLES_damage_top2012, year == 2012)



APPLES_damage_top_agg_hailfrostfreeze2012 <- aggregate(APPLES_damage_top2012$loss, by = list(APPLES_damage_top2012$county), FUN = "sum")
colnames(APPLES_damage_top_agg_hailfrostfreeze2012) <- c("NAME", "loss")

county_apples_hailfrostfreeze2012 <- merge(counties, APPLES_damage_top_agg_hailfrostfreeze2012, by = "NAME")



#ggplot(APPLES_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
#    geom_bar( stat="identity") + theme_bw() + ggtitle("IPNW apples loss vs. year - top damage causes") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(size=rel(1.5), angle = 90, hjust = 1, family = "Serif")) + theme(plot.title = element_text(hjust = 0.5, family = "Serif"))  +  scale_x_discrete(limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14)) + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=18)) + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))

par(mar=c(11,8,6,2), mgp = c(5, 1, 0)) 

gg2 <- ggplot(APPLES_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
    geom_bar( stat="identity") + theme_bw() + theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) + ggtitle("IPNW apples loss vs. year - top damage causes") + theme(axis.title.y = element_text(size=12), axis.title.x = element_text(size = 12), axis.text.y = element_text(size=rel(1), hjust = 1), axis.text.x = element_text(size=rel(1), angle = 90, hjust = 1)) + theme(plot.title = element_text(size =10))  +  scale_x_discrete(name = "Years", limits=c(2001:2015)) + theme(legend.text=element_text(size=10)) + scale_fill_manual("legend", values = c("Hail" = "red", "Frost" = "blue", "Freeze" = "gray")) + theme(legend.title=element_text(size=10, face = "bold")) + theme(plot.title = element_text(size=12, face = "bold")) + scale_y_continuous(name = "Insurance claim loss ($)", label = unit_format(unit = "M", scale = 1e-6, digits = 0)) + theme(legend.position="bottom")

print(gg2)

```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

apples <- palouse_sumloss_aggregate_apples
#i <- interaction.plot(x.factor     = apples$year,
#                 trace.factor = apples$damagecause, 
#                 trace.label = "apples",
#                 response     = apples$loss, 
#                 fun = sum,
#                 las = 3,
#                 type="p",
#                 col=c("black","red","green"),  ### Colors for levels of trace var.
#                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
#                 fixed=TRUE,                    ### Order by factor order in data
#                 leg.bty = "n",
#                 ylab="",
#                 xlab="Year",
#                 main="Interaction Plot - APPLES Loss vs. year - top damage causes", las = 2)

#EDA for apples
#-boxplots of data by cube loss by each of the three factors
par(mar=c(8,8,4,2), family = 'serif', mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_apples, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1, cex.axis = 1, cex.names = 1, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_apples$log10loss)
pts2 <- pretty(palouse_sumloss_aggregate_apples$log10loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, sep = ""))

graphics::title(main="Logrithmic transform: IPNW apples insurance loss by year", line = 2, cex.main = 1, adj = 0)
graphics::title(xlab="Years", line=4, cex.lab = 1)
graphics::title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1)

stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_apples, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

par(mar=c(11,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_apples, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1, cex.lab = 1, cex.axis = 1, cex.names = 1, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_apples$log10loss)
pts2 <- pretty(palouse_sumloss_aggregate_apples$log10loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, sep = ""))

graphics::title(main="Logrithmic transform: IPNW apples insurance loss\nby damage cause", line = 2, cex.main = 1, adj = 0)
graphics::title(xlab="Damage Cause", line=7, cex.lab = 1)
graphics::title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1)

stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_apples, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

par(mar=c(11,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ county, palouse_sumloss_aggregate_apples, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1, cex.lab = 1, cex.axis = 1, cex.names = 1, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_apples$log10loss)
pts2 <- pretty(palouse_sumloss_aggregate_apples$log10loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, sep = ""))

graphics::title(main="Logrithmic transform: IPNW apples insurance loss\nby county", line = 2, cex.main = 1, adj = 0)
graphics::title(xlab="Counties", line=7, cex.lab = 1)
graphics::title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1)


stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_apples, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is usedxx")}

usePackage("RgoogleMaps")
usePackage("sp")
usePackage("ggplot2")
usePackage("ggmap")
usePackage("maps")
usePackage("mapdata")
usePackage("RColorBrewer")
usePackage("mapproj")

#--

counties_apples <- counties[counties$NAME != "Lewis",]
counties_apples <- counties_apples[counties_apples$NAME != "Lincoln",]
counties_apples <- counties_apples[counties_apples$NAME != "Kootenai",]
counties_apples <- counties_apples[counties_apples$NAME != "Garfield",]
counties_apples <- counties_apples[counties_apples$NAME != "Wallowa",]
counties_apples <- counties_apples[counties_apples$NAME != "Nez Perce",]
counties_apples <- counties_apples[counties_apples$NAME != "Latah",]
counties_apples <- counties_apples[counties_apples$NAME != "Sherman",]
counties_apples <- counties_apples[counties_apples$NAME != "Morrow",]
counties_apples <- counties_apples[counties_apples$NAME != "Union",]
counties_apples <- counties_apples[counties_apples$NAME != "Whitman",]
counties_apples <- counties_apples[counties_apples$NAME != "Asotin",]
counties_apples <- counties_apples[counties_apples$NAME != "Benewah",]
counties_apples <- counties_apples[counties_apples$NAME != "Spokane",]
counties_apples <- counties_apples[counties_apples$NAME != "Clearwater",]
counties_apples <- counties_apples[counties_apples$NAME != "Gilliam",]
counties_apples <- counties_apples[counties_apples$NAME != "Idaho",]
counties_apples <- counties_apples[counties_apples$NAME != "Wasco",]

counties_apples$NAME <- factor(counties_apples$NAME)

labs2 <- lapply(seq(nrow(counties_apples@data)), function(i) {
        paste0(as.character(counties_apples@data[i, "NAME"]))
      })




#-----2001 - 2015

county_apples_hailfrostfreeze2 <- county_apples_hailfrostfreeze
county_apples_hailfrostfreeze2$loss[is.na(county_apples_hailfrostfreeze2$loss)] <- 0





labels <- subset(county_apples_hailfrostfreeze, loss != "NA")
labels2 <- labels$loss/1000000
labels2 <- round(labels2, digits = 2)
labels2=as.character(labels2)
labels2 <- paste(labels2, "M", sep="")

#nc.labels <- maptools::pointLabel(x=coordinates(labels)[,1],y=coordinates(labels)[,2],labels=labels2)
nc.labels <- as.data.frame(cbind(coordinates(labels[1])[,1], coordinates(labels[,2])[,2]))
colnames(nc.labels) <- c("x", "y")
nc.labels <- as.list(nc.labels)

stateline <- list("sp.lines", as(states, 'SpatialLines'), col = gray(0.4), lwd = 3)
locs.labels <- getSpPPolygonsLabptSlots(county_apples_hailfrostfreeze)
labels.white.panel <- list("panel.text",nc.labels$x-.01,nc.labels$y-.01,labels=labels2,col="black",cex=1)
spplot(county_apples_hailfrostfreeze, zcol = "loss", sp.layout=list(list(labels.white.panel), list(states, fill="white", first=TRUE), stateline), cuts = length(which(county_apples_hailfrostfreeze$loss != "NA"))-1, col.regions = brewer.pal(100, "Blues"), main = "Apples - insurance loss due to hail, frost, freeze: 2001 to 2015") 

par(mar=c(8.5, 6.1, 6, 2.1), family = 'serif', mgp=c(5, 1, 0), las=0)
  barplot(APPLES_damage_top_agg_hailfrostfreeze$loss, names.arg = APPLES_damage_top_agg_hailfrostfreeze$NAME, yaxt="n", las = 2, col = "lightblue", cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1)
pts <- pretty(APPLES_damage_top_agg_hailfrostfreeze$loss / 1000000)
pts2 <- pretty(APPLES_damage_top_agg_hailfrostfreeze$loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, "M", sep = ""))
graphics::title(main="IPNW apples insurance loss due to hail, frost, and freeze\n2001 to 2015", line = 2, adj = 0, cex.main = 1)
graphics::title(xlab="Counties", line=7, cex.lab = 1)
graphics::title(ylab="Apples insurance claim loss ($)", line=4, cex.lab = 1)

```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

#-2013

#-----2013

county_apples_hailfrostfreeze2 <- county_apples_hailfrostfreeze2013
county_apples_hailfrostfreeze2$loss[is.na(county_apples_hailfrostfreeze2$loss)] <- 0


labels <- subset(county_apples_hailfrostfreeze2013, loss != "NA")
labels2 <- labels$loss/1000000
labels2 <- round(labels2, digits = 2)
labels2=as.character(labels2)
labels2 <- paste(labels2, "M", sep="")

#nc.labels <- maptools::pointLabel(x=coordinates(labels)[,1],y=coordinates(labels)[,2],labels=labels2)
nc.labels <- as.data.frame(cbind(coordinates(labels[1])[,1], coordinates(labels[,2])[,2]))
colnames(nc.labels) <- c("x", "y")
nc.labels <- as.list(nc.labels)

stateline <- list("sp.lines", as(states, 'SpatialLines'), col = gray(0.4), lwd = 3)
locs.labels <- getSpPPolygonsLabptSlots(county_apples_hailfrostfreeze2013)
labels.white.panel <- list("panel.text",nc.labels$x-.01,nc.labels$y-.01,labels=labels2,col="black",cex=1)
spplot(county_apples_hailfrostfreeze2013, zcol = "loss", sp.layout=list(list(labels.white.panel), list(states, fill="white", first=TRUE), stateline), cuts = length(which(county_apples_hailfrostfreeze2013$loss != "NA"))-1, col.regions = brewer.pal(100, "Blues"), main = "Apples - insurance loss due to hail, frost, freeze: 2001 to 2015") 

# pal <- colorNumeric(colorRampPalette(c("lightblue", "blue"))(11), na.color = "#ffffff",
 #                     domain = eval(parse(text=paste("county_apples_hailfrostfreeze2013$", "loss", sep=""))))

#map <- leaflet(data = county_apples_hailfrostfreeze2013, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
#  addProviderTiles(providers$Hydda.Base) %>%
#   addProviderTiles(providers$Stamen.TonerLines) %>%
  
#  addMiniMap(
#    tiles = providers$Stamen.TonerLite,
#    position = 'topleft', 
#    width = 200, height = 200,
#    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
#  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_apples_hailfrostfreeze2013$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
#    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Apples hail frost<br>freeze 2013", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


#addLabelOnlyMarkers(data = county_apples_hailfrostfreeze2013, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
#)) 
        
#addScaleBar(map, position = c("topright"), options = scaleBarOptions())


par(mar=c(8.5, 6.1, 6, 2.1), family = 'serif', mgp=c(5, 1, 0), las=0)
  barplot(APPLES_damage_top_agg_hailfrostfreeze2013$loss, names.arg = APPLES_damage_top_agg_hailfrostfreeze2013$NAME, yaxt="n", las = 2, col = "lightblue", cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1)
pts <- pretty(APPLES_damage_top_agg_hailfrostfreeze2013$loss / 1000000)
pts2 <- pretty(APPLES_damage_top_agg_hailfrostfreeze2013$loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, "M", sep = ""))
graphics::title(main="IPNW apples insurance loss due to hail, frost, and freeze 2013", line = 2, adj = 0, cex.main = 1)
graphics::title(xlab="Counties", line=7, cex.lab = 1)
graphics::title(ylab="Apples insurance claim loss ($)", line=4, cex.lab = 1)


```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

#-2012

#-----2012

county_apples_hailfrostfreeze2 <- county_apples_hailfrostfreeze2012
county_apples_hailfrostfreeze2$loss[is.na(county_apples_hailfrostfreeze2$loss)] <- 0


labels <- subset(county_apples_hailfrostfreeze2012, loss != "NA")
labels2 <- labels$loss/1000000
labels2 <- round(labels2, digits = 2)
labels2=as.character(labels2)
labels2 <- paste(labels2, "M", sep="")

#nc.labels <- maptools::pointLabel(x=coordinates(labels)[,1],y=coordinates(labels)[,2],labels=labels2)
nc.labels <- as.data.frame(cbind(coordinates(labels[1])[,1], coordinates(labels[,2])[,2]))
colnames(nc.labels) <- c("x", "y")
nc.labels <- as.list(nc.labels)

stateline <- list("sp.lines", as(states, 'SpatialLines'), col = gray(0.4), lwd = 3)
locs.labels <- getSpPPolygonsLabptSlots(county_apples_hailfrostfreeze2012)
labels.white.panel <- list("panel.text",nc.labels$x-.01,nc.labels$y-.01,labels=labels2,col="black",cex=1)
spplot(county_apples_hailfrostfreeze2012, zcol = "loss", sp.layout=list(list(labels.white.panel), list(states, fill="white", first=TRUE), stateline), cuts = length(which(county_apples_hailfrostfreeze2012$loss != "NA"))-1, col.regions = brewer.pal(100, "Blues"), main = "Apples - insurance loss due to hail, frost, freeze: 2001 to 2015") 

#-2012


# pal <- colorNumeric(colorRampPalette(c("lightblue", "blue"))(11), na.color = "#ffffff",
#                      domain = eval(parse(text=paste("county_apples_hailfrostfreeze2012$", "loss", sep=""))))

#map <- leaflet(data = county_apples_hailfrostfreeze2012, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
#  addProviderTiles(providers$Hydda.Base) %>%
#   addProviderTiles(providers$Stamen.TonerLines) %>%
  
#  addMiniMap(
#    tiles = providers$Stamen.TonerLite,
#    position = 'topleft', 
 #   width = 200, height = 200,
#    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
#  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_apples_hailfrostfreeze2012$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
#    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Apples hail frost<br>freeze 2012", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


#addLabelOnlyMarkers(data = county_apples_hailfrostfreeze2012, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
#)) 
        
#addScaleBar(map, position = c("topright"), options = scaleBarOptions())

par(mar=c(8.5, 6.1, 6, 2.1), family = 'serif', mgp=c(5, 1, 0), las=0)
  barplot(APPLES_damage_top_agg_hailfrostfreeze2012$loss, names.arg = APPLES_damage_top_agg_hailfrostfreeze2012$NAME, yaxt="n", las = 2, col = "lightblue", cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1)
pts <- pretty(APPLES_damage_top_agg_hailfrostfreeze2012$loss / 1000000)
pts2 <- pretty(APPLES_damage_top_agg_hailfrostfreeze2012$loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, "M", sep = ""))
graphics::title(main="IPNW apples insurance loss due to hail, frost, and freeze\n2012", line = 2, adj = 0, cex.main = 1)
graphics::title(xlab="Counties", line=7, cex.lab = 1)
graphics::title(ylab="Apples insurance claim loss ($)", line=4, cex.lab = 1)


```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

#-2006

#-----2006

county_apples_hailfrostfreeze2 <- county_apples_hailfrostfreeze2006
county_apples_hailfrostfreeze2$loss[is.na(county_apples_hailfrostfreeze2$loss)] <- 0


labels <- subset(county_apples_hailfrostfreeze2006, loss != "NA")
labels2 <- labels$loss/1000000
labels2 <- round(labels2, digits = 2)
labels2=as.character(labels2)
labels2 <- paste(labels2, "M", sep="")

#nc.labels <- maptools::pointLabel(x=coordinates(labels)[,1],y=coordinates(labels)[,2],labels=labels2)
nc.labels <- as.data.frame(cbind(coordinates(labels[1])[,1], coordinates(labels[,2])[,2]))
colnames(nc.labels) <- c("x", "y")
nc.labels <- as.list(nc.labels)

stateline <- list("sp.lines", as(states, 'SpatialLines'), col = gray(0.4), lwd = 3)
locs.labels <- getSpPPolygonsLabptSlots(county_apples_hailfrostfreeze2006)
labels.white.panel <- list("panel.text",nc.labels$x-.01,nc.labels$y-.01,labels=labels2,col="black",cex=1)
spplot(county_apples_hailfrostfreeze2006, zcol = "loss", sp.layout=list(list(labels.white.panel), list(states, fill="white", first=TRUE), stateline), cuts = length(which(county_apples_hailfrostfreeze2006$loss != "NA"))-1, col.regions = brewer.pal(100, "Blues"), main = "Apples - insurance loss due to hail, frost, freeze: 2001 to 2015") 



#-2006


# pal <- colorNumeric(colorRampPalette(c("lightblue", "blue"))(11), na.color = "#ffffff",
#                      domain = eval(parse(text=paste("county_apples_hailfrostfreeze2006$", "loss", sep=""))))

#map <- leaflet(data = county_apples_hailfrostfreeze2006, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
 # addProviderTiles(providers$Hydda.Base) %>%
#   addProviderTiles(providers$Stamen.TonerLines) %>%
  
#  addMiniMap(
#    tiles = providers$Stamen.TonerLite,
#    position = 'topleft', 
#    width = 200, height = 200,
#    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
#  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_apples_hailfrostfreeze2006$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
#    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Apples hail frost<br>freeze 2006", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


#addLabelOnlyMarkers(data = county_apples_hailfrostfreeze2006, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
#)) 
        
#addScaleBar(map, position = c("topright"), options = scaleBarOptions())

par(mar=c(8.5, 6.1, 6, 2.1), family = 'serif', mgp=c(5, 1, 0), las=0)
  barplot(APPLES_damage_top_agg_hailfrostfreeze2006$loss, names.arg = APPLES_damage_top_agg_hailfrostfreeze2006$NAME, yaxt="n", las = 2, col = "lightblue", cex.lab = 1, cex.names = 1, font.lab = 1, font.axis = 1)
pts <- pretty(APPLES_damage_top_agg_hailfrostfreeze2006$loss / 1000000)
pts2 <- pretty(APPLES_damage_top_agg_hailfrostfreeze2006$loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, "M", sep = ""))
graphics::title(main="IPNW apples insurance loss due to hail, frost, and freeze\n2006", line = 2, adj = 0, cex.main = 1)
graphics::title(xlab="Counties", line=7, cex.lab = 1)
graphics::title(ylab="Apples insurance claim loss ($)", line=4, cex.lab = 1)

```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}


gg3 <- ggplot(apples_hailfrostfreeze_count2006, aes(fill=damagecause, y=count, x=county)) + 
    geom_bar( stat="identity") + theme_bw() + theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) + ggtitle("2006 IPNW apples counts vs. county: Hail/Frost/Freeze") + theme(axis.title.y = element_text(size=12), axis.title.x = element_text(size = 10), axis.text.x = element_text(size=rel(1), angle = 90, hjust = 1), axis.text.y = element_text(size=rel(1))) + theme(plot.title = element_text(size =10))  + theme(legend.text=element_text(size=10)) + scale_fill_manual("legend", values = c("Hail" = "red", "Frost" = "blue", "Freeze" = "gray")) + theme(legend.title=element_text(size=12, face = "bold")) + theme(plot.title = element_text(size=12, face = "bold")) +  theme(legend.position="bottom") + scale_y_discrete(limits=c(1:10))

print(gg3)

```

\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

#-2015

#-----2015

county_apples_hailfrostfreeze2 <- county_apples_hailfrostfreeze2015
county_apples_hailfrostfreeze2$loss[is.na(county_apples_hailfrostfreeze2$loss)] <- 0


labels <- subset(county_apples_hailfrostfreeze2015, loss != "NA")
labels2 <- labels$loss/1000000
labels2 <- round(labels2, digits = 2)
labels2=as.character(labels2)
labels2 <- paste(labels2, "M", sep="")

#nc.labels <- maptools::pointLabel(x=coordinates(labels)[,1],y=coordinates(labels)[,2],labels=labels2)
nc.labels <- as.data.frame(cbind(coordinates(labels[1])[,1], coordinates(labels[,2])[,2], labels2))
colnames(nc.labels) <- c("x", "y", "labels")

locs.labels <- getSpPPolygonsLabptSlots(county_apples_hailfrostfreeze2015)
labels.white.panel <- list("panel.text",nc.labels$x-.01,nc.labels$y-.01,labels=labels2,col="black",cex=1)
spplot(county_apples_hailfrostfreeze2015, zcol = "loss", sp.layout=list(list(labels.white.panel), list(states, fill="white", first=TRUE)), cuts = length(which(county_apples_hailfrostfreeze2015$loss != "NA"))-1, col.regions = brewer.pal(100, "Blues"), main = "Apples - insurance loss due to hail, frost, freeze: 2001 to 2015") 


#-2015


# pal <- colorNumeric(colorRampPalette(c("lightblue", "blue"))(11), na.color = "#ffffff",
#                      domain = eval(parse(text=paste("county_apples_hailfrostfreeze2015$", "loss", sep=""))))

#map <- leaflet(data = county_apples_hailfrostfreeze2015, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
#  addProviderTiles(providers$Hydda.Base) %>%
#   addProviderTiles(providers$Stamen.TonerLines) %>%
  
#  addMiniMap(
#    tiles = providers$Stamen.TonerLite,
#    position = 'topleft', 
#    width = 200, height = 200,
#    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
#  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_apples_hailfrostfreeze2015$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
#    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Apples hail frost<br>freeze 2015", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


#addLabelOnlyMarkers(data = county_apples_hailfrostfreeze2015, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
#)) 
        
#addScaleBar(map, position = c("topright"), options = scaleBarOptions())


par(mar=c(8.5, 6.1, 6, 2.1), family = 'serif', mgp=c(5, 1, 0), las=0)
  barplot(APPLES_damage_top_agg_hailfrostfreeze2015$loss, names.arg = APPLES_damage_top_agg_hailfrostfreeze2015$NAME, yaxt="n", las = 2, col = "lightblue", cex.lab = 1, cex.names = 1.4, font.lab = 1, font.axis = 1)
pts <- pretty(APPLES_damage_top_agg_hailfrostfreeze2015$loss / 1000000)
pts2 <- pretty(APPLES_damage_top_agg_hailfrostfreeze2015$loss)
axis(2, las = 1, at = pts2, cex.axis = 1, labels = paste(pts, "M", sep = ""))
graphics::title(main="IPNW apples insurance loss due to hail, frost, and freeze\n2015", line = 2, adj = 0, cex.main = 1)
graphics::title(xlab="Counties", line=7, cex.lab = 1)
graphics::title(ylab="Apples insurance claim loss ($)", line=4, cex.lab = 1)


```

\newpage











<br></br>

**Step 3c. PCA + KMEANS: WHEAT IPNW insurance loss, by COUNTY with DAMAGE CAUSE loadings: 2001 to 2015**

Here we perform a PCA for the insurance loss for the inland PNW, for wheat by county, with damage cause as the factor loadings.  Data from 2001 is 2015 is used.  We additionally have generated a scree plot that shows the proportion of variance explained by the individual components.


```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE}

#just the IPNW

usePackage("ggplot2")
usePackage("ggfortify")
usePackage("reshape2")

RMA_damage_IPNW$log10loss <- log10(RMA_damage_IPNW$loss)


RMA_damage_IPNW_wheat <- subset(RMA_damage_IPNW, commodity == "WHEAT")
RMA_damage_IPNW_transformed <- dcast(RMA_damage_IPNW_wheat, county + state ~ damagecause, value.var = c("loss"), sum)
RMA_damage_IPNW_transformed$statecounty <- paste(RMA_damage_IPNW_transformed$county, "_", RMA_damage_IPNW_transformed$state, sep="")
rownames(RMA_damage_IPNW_transformed) <- RMA_damage_IPNW_transformed$statecounty
RMA_damage_IPNW_exogenous <- RMA_damage_IPNW_transformed[,3:26]


#IPNW

#RMA_damage_IPNW_exogenous <- scale(RMA_damage_IPNW_exogenous, scale = TRUE, center = TRUE)
pca_RMA_damage_IPNW_exogenous <- prcomp(RMA_damage_IPNW_exogenous, scale = TRUE, center = TRUE)

RMA_damage_IPNW_exogenous_factor <- cbind(RMA_damage_IPNW_exogenous[2:3], RMA_damage_IPNW_exogenous[5:6], RMA_damage_IPNW_exogenous[8], RMA_damage_IPNW_exogenous[11], RMA_damage_IPNW_exogenous[13:14], RMA_damage_IPNW_exogenous[16:17])

fit <- prcomp(RMA_damage_IPNW_exogenous_factor, cor=TRUE, center = TRUE, scale = TRUE)

comp <- data.frame(fit$x[,1:2])
# Plot
#plot(comp, pch=16, col=rgb(0,0,0,0.5))


wss <- (nrow(RMA_damage_IPNW_exogenous_factor)-1)*sum(apply(RMA_damage_IPNW_exogenous_factor,2,var))
for (i in 1:23) wss[i] <- sum(kmeans(RMA_damage_IPNW_exogenous_factor,
                                     centers=i)$withinss)
plot(1:23, wss, type="b", xlab="Number of Clusters",
     ylab="Within groups sum of squares", main = "KMeans COUNTIES Elbow Plot")

```
\newpage




``` {r, warning = FALSE, echo= FALSE, message = FALSE, fig.show = 'hide'}

#``` {r, warning = FALSE, echo= FALSE, message = FALSE, results='hide',fig.keep='all', fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for all commodities by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used")}

  #identify the optimum number of clusters using NbClust
  par(mar=c(1,1,1,1))
  usePackage("NbClust")
  usePackage("factoextra")
  
  clustering_distance <- c("euclidean")
 clust<-NbClust(fit$x[,1:3], diss=NULL, distance = clustering_distance, min.nc=2, max.nc=20, method = "kmeans", index = "all")


  #clust<-NbClust(damage_loss[,1:(length(waterscarcity)-4)], diss=NULL, distance = clustering_distance, min.nc=2, max.nc=20, method = "kmeans", index = "dindex") 
  
  #res$All.index
  #res$Best.nc
  #res$All.CriticalValues
  #res$Best.partition
  
  maxclusters <- length(unique(clust$Best.partition))
  km.res <- kmeans(fit$x[,1:2], maxclusters, nstart = 25)
  #pam.res <- pam(damage_loss, maxclusters)
  hc.cut <- hcut(fit$x[,1:2], k = maxclusters, hc_method = "ward.D2")

```
\newpage



``` {r, warning = FALSE, echo= FALSE, message = FALSE, fig.show = 'hide'}

  #identify the optimum number of clusters using NbClust
  par(mar=c(1,1,1,1))
  usePackage("NbClust")
  usePackage("factoextra")
  
  clustering_distance <- c("euclidean")
 clust<-NbClust(fit$x[,1:3], diss=NULL, distance = clustering_distance, min.nc=2, max.nc=20, method = "kmeans", index = "all")
  par(mfrow=c(1,1))  
  
```
\newpage

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Hiearchical clustering dendrogram of iPNW counties, using principle components.")}

par(mar=c(8, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

plot(hc.cut, cex = 0.6) # plot tree
rect.hclust(hc.cut, k = maxclusters, border = 2:5) # add rectangle

usePackage("mclust")
d_clust <- Mclust(RMA_damage_IPNW_exogenous_factor, G=1:7, 
                  modelNames = mclust.options("emModelNames"))
#d_clust$BIC
plot(d_clust, what = c("BIC"))


```

```{r message=FALSE, warning=FALSE, echo= FALSE, error=TRUE, fig.width = 8, fig.height = 8, fig.cap=paste("Top panel: biplot of insurance loss for the inland PNW, for wheat by county, with damage cause as the factor loadings.  Bottom panel: Scree plot. Data from 2001 is 2015 is used.")}

usePackage("RColorBrewer")
usePackage("scales")

k <- kmeans(comp, 2, nstart=25, iter.max=1000)

palette(alpha(brewer.pal(9,'Set2'), 1))
#plot(comp, col=k$clust, pch=2)


kclust <- data.frame(k$clust)
kclust$k.clust <- factor(kclust$k.clust)

plot1 <- ggplot2::autoplot(prcomp(RMA_damage_IPNW_exogenous_factor, scale = TRUE, center = TRUE), frame = TRUE, frame.type = 'norm', data = kclust, colour = 'k.clust', loadings = TRUE, loadings.label = TRUE, loadings.label.size  = 4, label = FALSE, label.size = 3, legend = FALSE)  + theme_bw()   + geom_text(vjust=-1, label=rownames(RMA_damage_IPNW_exogenous)) + theme(legend.position = "none") + ggtitle("Principle Components: IPNW insurance loss\nby county with damage cause loadings ") + theme(plot.title = element_text(size =12, family = "Serif")) + theme(axis.title.y = element_text(family = "Serif", size=12), axis.title.x = element_text(family = "Serif", size = 12), axis.text.x = element_text(size=rel(1.5), hjust = 1, family = "Serif"), axis.text.y = element_text(size=rel(1.5), hjust = 1, family = "Serif"))  + theme(legend.position="bottom") 


#scree plot

std_dev <- fit$sdev

pr_var <- std_dev^2

#pr_var[1:10]

prop_varex <- pr_var/sum(pr_var)

prop_varex <- data.frame(prop_varex)

prop_varex$comp <- c(1:max(nrow(prop_varex)))

prop_varex$prop_varex <- as.numeric(prop_varex$prop_varex)

p <- ggplot(prop_varex, aes(as.factor(comp), prop_varex, group=1))
plot2 <- p + geom_point(shape = 21) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  xlab("comp") + theme_bw() +
stat_summary(fun.y=sum, geom="line") + labs(title = "Scree plot of insurance loss for the inland PNW, for wheat by county, with \ndamage cause as the factor loadings.", y = "% explained variance")

grid.arrange(plot1, plot2, nrow=2, heights=c(2,1))


```
