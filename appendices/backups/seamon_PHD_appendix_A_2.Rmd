---
title: 'Appendix A: Agricultural Insurance Loss and Relationships to Climate across
  the Inland Pacific Northwest Region of the United States'
author: "Erich Seamon, Paul E. Gessler, John T. Abatzoglou, Philip Mote, Stephen Lee"
date: "September 2019"
output:
  html_document:
    css: custom.css
    code_folding: hide
    highlight: textmate
    theme: united
    toc: yes
    toc_float: yes
  pdf_document: default
params: null
mainfont: serif
---
 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width='600px', out.height='600px', dpi=200)

#rmarkdown::render(input = "/dmine/code/git/paper-PHD1/appendix/paper-PHD1-appendix_EDA.Rmd", output_file = paste("/dmine/code/git/seamon_dissertation/appendices/seamon_PHD_appendix_A.html", sep=""))

```
![](https://dmine.io/waf/img/Step1.png)
**Dissertation Appendix A**

**Chapter 1: Agricultural Insurance Loss Analysis of the Pacific Northwest, 2001 to 2015**

Appendix A documents the Chapter 1 exploratory data analysis process, examining the relationships of agricultural commodity loss, at a county level, from 1989-2015, across the three state region of the Pacific Northwest (Washington, Idaho, and Oregon), and then focus in on the 24 county region of the Inland Pacific Northwest (IPNW). 

We examine the entire range of commodities and damage causes for the IPNW study area, identifying the top revenue loss commodities and their most pertinent damage causes, as indicated from the USDA's agricultural commodity loss insurance archive.  We also explore claim freqency, We fiinally zero in on the top 5 commodities for the region, and examine specific loss variation by year and damage cause.

Several steps were performed to examine the full set of data, and to narrow down factors to a usable form for further modeling analysis.
<br></br>
<br></br>
**Step 1.** Data Preparation.  Here we load our agricultural insurance loss data.

**Step 2.** Data Preparation. Original Insurance Loss Dataset - Pacific Northwest

**Step 3.** Data Preparation.  Aggregated Insurance Loss Dataset - Pacific Northwest

**Step 4.** Pacific Northwest (PNW) Overview.  Here we examine overall commodity loss for the entire three state region of Washington, Idaho, and Oregon, which comes primarily from three primary agricultural regions - the IPNW (mostly Washington, with portions of northern Idaho and northeastern Oregon), the Southern Idaho Valley (Idaho), and the Willamette Valley (Oregon).

**Step 5.** PNW region overview of insurance loss by year, damage cause, and commodity, and county: 1989 to 2015.  From the results of this examination, we narrow our time frame to 2001 to 2015. 

**Step 6.** PNW region overview of insurance Loss claim counts by year, damage cause, commodity, and county: 2001-2015

**Step 7.** Refining our analysis to the 24-county inland Pacific Northwest (iPNW) Study Area.

**Step 8.** IPNW region overview of Insurance Loss by year, damage cause, commodity and county: 2001-2015

**Step 9.** IPNW region overview of Insurance Loss claim counts: 2001-2015

**Step 10.** APPLES: IPNW region overview of Insurance Loss 2001-2015

**Step 11.** BARLEY: IPNW region overview of Insurance Loss 2001-2015

**Step 12.** WHEAT: IPNW region overview of Insurance Loss 2001-2015

**Step 13.** CHERRIES: IPNW region overview of Insurance Loss 2001-2015

**Step 14.** PEAS: IPNW region overview of Insurance Loss 2001-2015



![](https://dmine.io/waf/img/Step1.png)


##Step 1: Data Preparation

The first step was to load Pacific Northwest agricultural insurance commodity loss data, aggregate by county, damage cause and commodity, remove zeros, transform the loss values ($) into cube root and logrithmic outputs, and scale and center the data.  

Original data file for all insurance claims for the Pacific Northwest, can be found here:

https://github.com/erichseamon/paper-PHD1/blob/master/data/RMA_PNW_2001_2015.csv

Aggregated data file, which summarizes data by year, county, commodity, and damage cause, for just the Pacific Northwest, can be found here:

https://github.com/erichseamon/paper-PHD1/blob/master/data/RMA_damage_PNW_2001_2015.csv

All code that generates the following graphs and tables, can be found here:

https://github.com/erichseamon/paper-PHD1/




```{r message=FALSE, warning=FALSE}
library(knitr)
library(tab)
library(car)
library(RCurl)
library(lme4)
library(ez)
library(lattice)
library(ggplot2)
library(coefplot2)
library(broom)
library(htmlTable)
library(gridExtra)
library(kableExtra)
library(repmis)



#options(scipen=999)

#load original data as txt file 

rma1989 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/1989.txt"), 
sep = "|", header = FALSE, strip.white = TRUE)

rma1990 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/1990.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma1991 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/1991.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma1992 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/1992.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma1993 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/1993.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma1994 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/1994.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma1995 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/1995.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma1996 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/1996.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma1997 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/1997.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma1998 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/1998.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma1999 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/1999.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2000 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2000.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2001 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2001.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2002 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2002.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2003 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2003.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2004 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2004.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2005 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2005.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2006 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2006.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2007 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2007.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2008 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2008.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2009 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2009.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2010 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2010.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2011 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2011.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2012 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2012.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2013 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2013.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2014 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2014.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

rma2015 <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/RMA_originaldata/2015.txt"), 
header = FALSE, strip.white = TRUE, sep = "|")

#load individual files from 1989 to 2000
RMA_1989 <- rbind(rma1989, rma1990, rma1991, rma1992, rma1993, rma1994, rma1995, rma1996, rma1997, rma1998, rma1999, rma2000)

#filter columns
RMA_1989 <- data.frame(RMA_1989[,1], RMA_1989[,3], RMA_1989[,5], RMA_1989[,7], RMA_1989[,12], RMA_1989[,13], RMA_1989[,14], RMA_1989[,15])

#set column names
colnames(RMA_1989) <- c("year", "state", "county", "commodity", "damagecause", "monthcode", "month", "loss")

#load individual files from 2001 to 2015
RMA <- rbind(rma2001, rma2002, rma2003, rma2004, rma2005, rma2006, rma2007, rma2008, rma2009, rma2010, rma2011, rma2012, rma2013, rma2014, rma2015)

#filter columns
RMA <- data.frame(RMA[,1], RMA[,3], RMA[,5], RMA[,7], RMA[,12], RMA[,13], RMA[,14], RMA[,15], RMA[,16])

#set column names
colnames(RMA) <- c("year", "state", "county", "commodity", "damagecause", "monthcode", "month", "acres", "loss")

#subset 2001 to 2015 for ID, WA, and OR
RMA_PNW <- subset(RMA, state == "WA" | state == "OR" | state == "ID" )

#subset 1989 to 2000 for ID, WA, and OR
RMA_PNW_1989 <- subset(RMA_1989, state == "WA" | state == "OR" | state == "ID" )

#calculate loss per acre
RMA_PNW$lossperacre <- RMA_PNW$loss / RMA_PNW$acres

#remove records with missing months
RMA_PNW <- subset(RMA_PNW, month != "")

#set a crop year column (i.e. water year)
RMA_PNW$cropyear <- RMA_PNW$year

#make oct/nov/dec part of the crop year
RMA_PNW$cropyear[RMA_PNW$monthcode >= 10] <- RMA_PNW$year + 1

#remove 2016
RMA_PNW <- subset(RMA_PNW, year != 2016)


#aggregate by year/state/county/commodity, for total loss in $
RMA_commodity_loss <- aggregate(RMA$loss, by = list(RMA$year, RMA$state, RMA$county, RMA$commodity), FUN = sum)
colnames(RMA_commodity_loss) <- c("year", "state", "county", "commodity", "loss")
RMA_commodity_loss <- subset(RMA_commodity_loss, commodity != "ADJUSTED GROSS REVENUE")

#aggregate by year/state/county/commodity for total number of claims
RMA_commodity_count <- aggregate(RMA$loss, by = list(RMA$year, RMA$state, RMA$county, RMA$commodity), FUN = length)
colnames(RMA_commodity_count) <- c("year", "state", "county", "commodity", "count")
RMA_commodity_count <- subset(RMA_commodity_count, commodity != "ADJUSTED GROSS REVENUE")

#aggregate for year/state/county/commodity for acreage
RMA_commodity_acres <- aggregate(RMA$acres, by = list(RMA$year, RMA$state, RMA$county, RMA$commodity), FUN = sum)
colnames(RMA_commodity_acres) <- c("year", "state", "county", "commodity", "acres")
RMA_commodity_acres <- subset(RMA_commodity_acres, commodity != "ADJUSTED GROSS REVENUE")

#aggregate for year/state/county/damage cause for total loss in $
RMA_damage_loss <- aggregate(RMA$loss, by = list(RMA$year, RMA$state, RMA$county, RMA$commodity, RMA$damagecause), FUN = sum)
colnames(RMA_damage_loss) <- c("year", "state", "county", "commodity", "damagecause", "loss")

#aggregate for year/state/county/commodity/damage cause by total loss in $
RMA_damage_count <- aggregate(RMA$loss, by = list(RMA$year, RMA$state, RMA$county, RMA$commodity, RMA$damagecause), FUN = length)
colnames(RMA_damage_count) <- c("year", "state", "county", "commodity", "damagecause", "count")

#aggregate by year/state/county/commodity/damage cause by acres
RMA_damage_acres <- aggregate(RMA$acres, by = list(RMA$year, RMA$state, RMA$county, RMA$commodity, RMA$damagecause), FUN = sum)
colnames(RMA_damage_acres) <- c("year", "state", "county", "commodity", "damaecause", "acres")

#combine all the aggregated commodity values (loss, count, acreage)
RMA_commodity_combined <- cbind(RMA_commodity_loss, RMA_commodity_count$count, RMA_commodity_acres$acres)
colnames(RMA_commodity_combined) <- c("year", "state", "county", "commodity", "loss", "count", "acres")

#calculate lossperacre for aggregated commodity
RMA_commodity_combined$lossperacre <- RMA_commodity_combined$loss / RMA_commodity_combined$acres

#calculate loss per claim for aggregated commodity
RMA_commodity_combined$lossperclaim <- RMA_commodity_combined$loss / RMA_commodity_combined$count

#calculate acres per claim for aggregated commodity
RMA_commodity_combined$acresperclaim <- RMA_commodity_combined$acres / RMA_commodity_combined$count

#combine all aggregated damage cause values (loss, count, acreage) 
RMA_damage_combined <- cbind(RMA_damage_loss, RMA_damage_count$count, RMA_damage_acres$acres)
colnames(RMA_damage_combined) <- c("year", "state", "county", "commodity", "damagecause", "loss", "count", "acres")

#calculate lossperacre for aggregated damage cause
RMA_damage_combined$lossperacre <- RMA_damage_combined$loss / RMA_damage_combined$acres

#calculate loss per claim for aggregated damage cause
RMA_damage_combined$lossperclaim <- RMA_damage_combined$loss / RMA_damage_combined$count

#calculate acres per claim for aggregated damage cause
RMA_damage_combined$acresperclaim <- RMA_damage_combined$acres / RMA_damage_combined$count

#set NAs for loss per acre for damage cause combo to zero.  
RMA_damage_combined$lossperacre[!is.finite(RMA_damage_combined$lossperacre)] <- 0

#subset for PNW - 2001 - 2015
RMA_damage_PNW <- subset(RMA_damage_combined, state == "WA" | state == "OR" | state == "ID")

#remove all other counties values
RMA_damage_PNW <- subset(RMA_damage_PNW, county != "All Other Counties")

#subset just for Idaho
RMA_Idaho <- subset(RMA_damage_PNW, state == "ID")

#subset just for Oregon
RMA_Oregon <- subset(RMA_damage_PNW, state == "OR")

#subset just for Washington
RMA_Washington <- subset(RMA_damage_PNW, state == "WA")

#subset just for iPNW counties for Idaho
RMA_Idaho_IPNW <- subset(RMA_Idaho, county == "Idaho" | county == "Lewis" | county ==  "Nez Perce" | county ==  "Latah" | county ==  "Benewah")

#subset just for iPNW counties for Oregon
RMA_Oregon_IPNW <- subset(RMA_Oregon, county == "Wasco" | county ==  "Sherman" | county ==  "Gilliam" | county ==  "Morrow" | county ==  "Umatilla" | county ==  "Union" | county ==  "Wallowa")

#subset just for iPNW counties for Washington
RMA_Washington_IPNW <- subset(RMA_Washington, county ==  "Douglas" | county ==  "Grant" | county ==  "Benton" | county ==  "Franklin" | county ==  "Walla Walla" | county ==  "Adams" | county ==  "Lincoln" | county ==  "Spokane" | county ==  "Whitman" | county ==  "Columbia" | county ==  "Garfield" | county ==  "Asotin")


#combine all iPNW counties
RMA_damage_IPNW <- rbind(RMA_Idaho_IPNW,RMA_Oregon_IPNW,RMA_Washington_IPNW)

#-load summarized data
Southern_ID_sumloss <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/dmine_anova/master/PNW_summary_all.csv"), 
header = TRUE)

Southern_ID_sumloss_all_sum <- RMA_damage_PNW

Southern_ID_sumloss_all_sum  <- aggregate(loss ~ year + 
                                            damagecause + state + county + commodity,  
                                         Southern_ID_sumloss, sum)

Southern_ID_count_all_count  <- aggregate(count ~ year + 
                                            damagecause + county + commodity,  
                                          Southern_ID_sumloss, sum)
Southern_ID_sumloss_all_sum <- 
  Southern_ID_sumloss_all_sum[Southern_ID_sumloss_all_sum$loss >= 1, ]

#---subsetting for palouse/IPNW for sum, count, and lossperacre

#- SUM: sumloss_palouse_sum
#- COUNT: count_palouse_count
#- LOSSPERACRE: palouse_lossperacres

 palousecounties    <-  c("Idaho", "Lewis", "Nez Perce", "Clearwater", "Latah", "Benewah", "Kootenai","Douglas", "Grant", "Benton", "Franklin", "Walla Walla", "Adams", "Lincoln", "Spokane", "Whitman", "Columbia", "Garfield", "Asotin","Wasco", "Sherman", "Gilliam", "Morrow", "Umatilla", "Union", "Wallowa")

sumloss_palouse <- Southern_ID_sumloss[Southern_ID_sumloss$county %in% palousecounties, ]
sumloss_nonpalouse <- Southern_ID_sumloss[!Southern_ID_sumloss$county %in% palousecounties, ]
                      

sumloss_palouse_sum  <- aggregate(loss ~ year + 
                                            damagecause + county + state + commodity,  
                                          sumloss_palouse, sum)
count_palouse_count  <- aggregate(count ~ year + 
                                            damagecause + county + state + commodity,  
                                          sumloss_palouse, sum)

palouse_lossperacres  <- aggregate(lossperacres ~ year + 
                                            damagecause + county + state + commodity,  
                                          sumloss_palouse, mean)
sumloss_palouse_sum <- 
  sumloss_palouse_sum[sumloss_palouse_sum$loss >= 1, ]


#creating transforms for sum loss - cube root, square root, inverse, log10 and natural log, and then scale and center

Math.cbrt <- function(x) {
  sign(x) * abs(x)^(1/3)
}

#-calculate cube loss
sumloss_palouse_sum$cube_loss <- Math.cbrt(sumloss_palouse_sum$loss)

#-remove zeros
sumloss_palouse_sum <- subset(sumloss_palouse_sum, loss > 0)

#-use a log transform 

sumloss_palouse_sum$log10_loss <- log10(sumloss_palouse_sum$loss)
sumloss_palouse_sum$log_loss <- log(sumloss_palouse_sum$loss)

#-inverse transform
sumloss_palouse_sum$inverse_loss <- 1/sumloss_palouse_sum$loss

#sq root transformation
sumloss_palouse_sum$sqroot_loss <- sqrt(sumloss_palouse_sum$loss)

#--scale and center
sumloss_palouse_sum$scaled_cube_loss <- scale(sumloss_palouse_sum$cube_loss)
sumloss_palouse_sum$scaled_inverse_loss <- 
  scale(sumloss_palouse_sum$inverse_loss, center = TRUE, scale = TRUE)

#----


#-Loading all WHEAT claims for the palouse from 1989-2015
palouse_sumloss <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/dmine_anova/master/Palouse_summary_sumloss.csv"), 
header = TRUE)
palouse_counts <- read.csv(text=getURL
("https://raw.githubusercontent.com/erichseamon/dmine_anova/master/Palouse_summary_counts.csv"), 
header = TRUE)


#use a cube transformation on loss for WHEAT claims
Math.cbrt <- function(x) {
  sign(x) * abs(x)^(1/3)
}

Southern_ID_sumloss_all_sum$cube_loss <- Math.cbrt(Southern_ID_sumloss_all_sum$loss)
Southern_ID_count_all_count$cube_counts <- Math.cbrt(Southern_ID_count_all_count$count)


#--aggregate palouse but not by county
palouse_sumloss_aggregate_county <- aggregate(loss ~ damagecause + year + commodity + county, 
                                       palouse_sumloss, mean)

#--aggregate palouse
palouse_sumloss_aggregate <- aggregate(loss ~ damagecause + year + commodity + county, 
                                       palouse_sumloss, sum)

#-calculate cube loss
palouse_sumloss_aggregate$cube_loss <- Math.cbrt(palouse_sumloss_aggregate$loss)

#-remove zeros
palouse_sumloss_aggregate <- subset(palouse_sumloss_aggregate, loss > 0)

#-use a log transform 

palouse_sumloss_aggregate$log10_loss <- log10(palouse_sumloss_aggregate$loss)
palouse_sumloss_aggregate$log_loss <- log(palouse_sumloss_aggregate$loss)

#-inverse transform
palouse_sumloss_aggregate$inverse_loss <- 1/palouse_sumloss_aggregate$loss

#sq root transformation
palouse_sumloss_aggregate$sqroot_loss <- sqrt(palouse_sumloss_aggregate$loss)

#--scale and center
palouse_sumloss_aggregate$scaled_cube_loss <- scale(palouse_sumloss_aggregate$cube_loss)
palouse_sumloss_aggregate$scaled_inverse_loss <- 
  scale(palouse_sumloss_aggregate$inverse_loss, center = TRUE, scale = TRUE)

#----

```
<br></br>

##Step 2. Original Insurance Loss Dataset - Pacific Northwest

The following table is an example of the original data that was acquired from the USDA Risk Management Agency (RMA).  Each record represents an individual insurance claim.


```{r message=FALSE, warning=FALSE, error=TRUE, fig.width = 10, fig.height = 9}

knitr::kable(RMA_PNW[1:10,], format="markdown") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

<br></br>

##Step 3. Aggregated Insurance Loss Dataset - Pacific Northwest

The following table is an example of an aggregated dataset derived from the original files.  Here we have summarized claims by year, county, commodity, and damage cause.  Each unique combination is summarized, which includes the total summarized loss, the number of claims, the total summarized acreage, loss per acre, loss per claim, and acres per claim.  This dataset was the basis for our data examination.


```{r message=FALSE, warning=FALSE, error=TRUE, fig.width = 10, fig.height = 9}

knitr::kable(RMA_damage_PNW[1:10,], format="markdown") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

<br></br>

![](https://dmine.io/waf/img/Step1.png)

##Step 4: Pacific Northwest(PNW) Study Area

The following map shows the three key agricultural regions that make up over 95% of all agricultural insurance loss for the three state region of Washington, Oregon, and Idaho.


```{r message=FALSE, warning=FALSE, error=TRUE}

library(data.table)
library(maptools)
library(classInt)
library(leaflet)
library(dplyr)
library(raster)
library(htmltools)

URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/states/states_conus.zip"
destfile <- "/tmp/states_conus.zip"
download.file(URL, destfile)
outDir<-"/tmp"
unzip(destfile,exdir=outDir)

states <- readShapePoly('/tmp/states_conus.shp',
                        proj4string=CRS
                        ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")


URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/states/threestate_boundary.zip"
destfile <- "/tmp/threestate_boundary.zip"
download.file(URL, destfile)
outDir<-"/tmp"
unzip(destfile,exdir=outDir)
    
threestates <- readShapePoly('/tmp/threestate_boundary.shp', 
                                  proj4string=CRS
                                  ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
        projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")


#setwd("/dmine/data/counties/")
        
URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/counties/threestate_willamette.zip"
destfile <- "/tmp/threestate_willamette.zip"
download.file(URL, destfile)
outDir<-"/tmp"
unzip(destfile,exdir=outDir)

counties_willamette <- readShapePoly('/tmp/threestate_willamette.shp',
                     proj4string=CRS
                     ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/counties/threestate_southernID.zip"
destfile <- "/tmp/threestate_southernID.zip"
download.file(URL, destfile)
outDir<-"/tmp"
unzip(destfile,exdir=outDir)

counties_ID <- readShapePoly('/tmp/threestate_southernID.shp',
                     proj4string=CRS
                     ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

URL <- "https://raw.githubusercontent.com/erichseamon/seamon_dissertation/master/data/counties/threestate_palouse.zip"
destfile <- "/tmp/threestate_palouse.zip"
download.file(URL, destfile)
outDir<-"/tmp"
unzip(destfile,exdir=outDir)

counties_palouse <- readShapePoly('/tmp/threestate_palouse.shp',
                     proj4string=CRS
                     ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

#pal <- colorNumeric(palette = c("white", "orange", "darkorange", "red", "darkred"),
#                    domain = counties$NAME)



exte <- as.vector(extent(threestates))

#label <- paste(sep = "<br/>", counties$NAME, round(counties$NAME, 0))
#markers <- data.frame(label)
#labs <- as.list(counties$NAME)

counties_palouse <- counties_palouse[counties_palouse$NAME != "Kootenai",]
counties_palouse <- counties_palouse[counties_palouse$NAME != "Clearwater",]

#--


mapz <- leaflet(options = leafletOptions(zoomSnap = .4, zoomDelta = .4)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>% 
 
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(data = counties_palouse, color = "lightyellow",  fillOpacity = .8, weight = 1) %>% addPolygons(data = counties_palouse, color = "gray",  fillOpacity = 0, weight = 1) %>% addPolygons(data = counties_ID, color = "gray", fillOpacity = 0,  weight = 1) %>% addPolygons(data = counties_ID, color = "red",  weight = 1) %>% addPolygons(data = counties_willamette, color = "green",  weight = 1)  %>% addPolygons(data = counties_willamette, color = "gray", fillOpacity = 0, weight = 1)  %>% addPolygons(data = states, stroke = TRUE, color = "black",  weight = 3, fillOpacity = 0) 

addScaleBar(mapz, position = c("bottomright"), options = scaleBarOptions())


```

<br></br>

![](https://dmine.io/waf/img/Step1.png)
<br></br>

##Step 5: PNW insurance claim loss summary

Here we examine the PNW region's insurance loss by year, damage cause, and commodity, and county, from 1989 to 2015.  From the results of this examination, we narrow our time frame to 2001 to 2015. 

```{r message=FALSE, warning=FALSE, error=TRUE, fig.width = 10, fig.height = 9}
#palouse_sumloss_aggregate <- subset(palouse_sumloss_aggregate, year >= 2001 & year <= 2015)

#palouse_sumloss_1989_2015 <- subset(palouse_sumloss_aggregate, commodity == "WHEAT")

#barplot of 1989 to 2015

RMA_PNW_aggregates <- aggregate(RMA_PNW$loss, by=list(RMA_PNW$year), FUN = "sum")
RMA_PNW_1989_aggregates <- aggregate(RMA_PNW_1989$loss, by=list(RMA_PNW_1989$year), FUN = "sum")
RMA_allyear <- rbind(RMA_PNW_1989_aggregates, RMA_PNW_aggregates)
colnames(RMA_allyear) <- c("Year", "Loss")

#barplot of 1989 to 2015 for damage causes

RMA_PNW_aggregates_d <- aggregate(RMA_PNW$loss, by=list(RMA_PNW$damagecause), FUN = "sum")
RMA_PNW_1989_aggregates_d <- aggregate(RMA_PNW_1989$loss, by=list(RMA_PNW_1989$damagecause), FUN = "sum")
RMA_allyear_d <- rbind(RMA_PNW_1989_aggregates_d, RMA_PNW_aggregates_d)
colnames(RMA_allyear_d) <- c("Damagecause", "Loss")
RMA_allyear_d <- RMA_allyear_d[order(-RMA_allyear_d$Loss),] 

par(mar=c(12, 8.1, 7, 0), family = 'serif', mgp=c(4, 1, 0), las=0)
#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(RMA_allyear$Loss, names.arg = RMA_allyear$Year, las = 3, main = "", yaxt="n", col = "lightblue", xlab = "", cex.main = 1.9, cex.lab = 1.9, cex.names = 1.9, font.lab = 1, font.axis = 1) 
graphics::title(main = "PNW total insurance loss by \ndamage cause: 1989 to 2015", line = 1, adj = 0, cex.main = 3)
pts <- pretty(RMA_allyear$Loss / 1000000)
pts2 <- pretty(RMA_allyear$Loss)
axis(2, las = 1, cex.axis = 1.9, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")

mtext("Year", cex = 1.9, side=1, line=6)
mtext("Insurance Claim Loss ($)", cex = 1.9, side=2, line=6.5)


#--Analysis for Entire PNW, from 2001 to 2015

library(stringi)

palouse_sumloss_1989_2015 <- aggregate(Southern_ID_sumloss$loss, list(Southern_ID_sumloss$year), FUN = "sum")
palouse_sumloss_1989_2015_dc <- aggregate(Southern_ID_sumloss$loss, list(Southern_ID_sumloss$damagecause), FUN = "sum")

palouse_sumloss_1989_2015_c <- aggregate(Southern_ID_sumloss$loss, list(Southern_ID_sumloss$commodity), FUN = "sum")

colnames(palouse_sumloss_1989_2015_c) <- c("commodity", "loss")

c <- palouse_sumloss_1989_2015_c[order(palouse_sumloss_1989_2015_c$loss),] 

c2 <- c[seq(dim(c)[1],1),]

colnames(palouse_sumloss_1989_2015_dc) <- c("damagecause", "loss")

dc <- palouse_sumloss_1989_2015_dc[order(palouse_sumloss_1989_2015_dc$loss),] 

dc2 <- dc[seq(dim(dc)[1],1),]

colnames(palouse_sumloss_1989_2015) <- c("year", "loss")

#palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 

X <- dc2

#X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")

XX <- X
XX <- subset(X, loss > 50000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

#YYY1<- YYY1[seq(dim(YYY1)[1],1),]
YYY1$loss <- round(YYY1$loss, 0)
#grid.table(YYY1, theme = tt3, rows = NULL)

YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

dd2 <- cbind(YYY2[1:14, ])
colnames(dd2) <- c("damage cause", "loss")
dd2[is.na(dd2)] <- ""

dd3 <- cbind(RMA_allyear_d[1:10, ])
colnames(dd3) <- c("damage cause", "loss")
dd3[is.na(dd3)] <- ""

#--barplot of damage causes from 2001 to 2015

levels(dd3$`damage cause`)[6] <- "Excessive Moisture"
par(mar=c(18, 8.1, 6, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

barplot(dd3$loss, names.arg = dd3$`damage cause`, las = 3, main = "", yaxt="n", col = "lightblue", xlab = "", cex.main = 1.9, cex.lab = 1.9, cex.names = 1.9, font.lab = 1, font.axis = 1) 
graphics::title(main = "PNW total insurance loss by \ndamage cause: 1989 to 2015", line = 1, adj = 0, cex.main = 3)
pts <- pretty(RMA_allyear_d$Loss / 1000000)
pts2 <- pretty(RMA_allyear_d$Loss)
axis(2, las = 1, cex.axis = 1.9, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")

mtext("Damage Cause", cex = 1.9, side=1, line=15)
mtext("Insurance Claim Loss ($)", cex = 1.9, side=2, line=6.5)

htmlTable(dd3,
          cgroup = c("1989-2015"),
          n.cgroup = c(2),
          caption = "PNW total insurance loss by year, 1989-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

#--barplot of damage causes from 2001 to 2015

levels(YYY1$damagecause)[8] <- "Excessive Moisture"
par(mar=c(18, 8.1, 6, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$damagecause, las = 3, main = "", yaxt="n", col = "lightblue", xlab = "", cex.main = 1.9, cex.lab = 1.9, cex.names = 1.9, font.lab = 1, font.axis = 1) 
graphics::title(main = "PNW total insurance loss by \ndamage cause: 2001 to 2015", line = 1, adj = 0, cex.main = 3)
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, cex.axis = 1.9, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")

mtext("Damage Cause", cex = 1.9, side=1, line=15)
mtext("Insurance Claim Loss ($)", cex = 1.9, side=2, line=6.5)


htmlTable(dd2,
          cgroup = c("2001-2015"),
          n.cgroup = c(2),
          caption = "PNW total insurance loss by year, 2001-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

X <- c2

#X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")

XX <- X
XX <- subset(X, loss > 50000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

#YYY1<- YYY1[seq(dim(YYY1)[1],1),]
YYY1$loss <- round(YYY1$loss, 0)
#grid.table(YYY1, theme = tt3, rows = NULL)

YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

dd2 <- cbind(YYY2[1:14, ])
colnames(dd2) <- c("commodity", "loss")
dd2[is.na(dd2)] <- ""

YYY1$commodity <- tolower(YYY1$commodity)
YYY1$commodity <- stri_trans_general(YYY1$commodity, id = "Title")

par(mar=c(14, 7.5, 6, 2.1), family = 'serif', mgp=c(7, 1, 0), las=0)
#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$commodity, las = 3, yaxt="n", col = "lightblue", cex.main = 1.5, cex.lab = 1.4, cex.names = 1.9, font.lab = 1, font.axis = 1) 
graphics::title(main = "PNW total insurance loss by \ncommodity: 2001 to 2015", line = 1, adj = 0, cex.main = 3)
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, cex.axis = 1.9, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")

mtext("Insurance Claim Loss ($)", cex = 1.9, side=2, line=6)
mtext("Commodity", cex = 1.9, side=1, line=8)


htmlTable(dd2,
          cgroup = c("2001-2015"),
          n.cgroup = c(2),
          caption = "PNW total insurance loss by year, 2001-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")


X <- palouse_sumloss_1989_2015

#X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")

XX <- X
#XX <- subset(X, loss > 50000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

#YYY1<- YYY1[seq(dim(YYY1)[1],1),]
YYY1$loss <- round(YYY1$loss, 0)
#grid.table(YYY1, theme = tt3, rows = NULL)

YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

dd2 <- cbind(YYY2[1:15, ])
colnames(dd2) <- c("year", "loss")
dd2[is.na(dd2)] <- ""

par(mar=c(10, 7.5, 6, 2.1), family = 'serif', mgp=c(6, 1, 0), las=0)
#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$year, las = 3, yaxt="n", col = "lightblue", cex.lab = 1.4, cex.main = 1.5, cex.names = 1.9, font.lab = 1, font.axis = 1) 
graphics::title(main = "PNW total insurance loss \nby year: 2001 to 2015", line = 1, adj = 0, cex.main = 3)

pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, cex.axis = 1.9, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")

mtext("Insurance Claim Loss ($)", cex = 1.9, side=2, line=6)
mtext("Year", cex = 1.9, side=1, line=6)


htmlTable(dd2,
          cgroup = c("2001-2015"),
          n.cgroup = c(2),
          caption = "PNW total insurance loss by year, 2001-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")
```

<br></br>

![](https://dmine.io/waf/img/Step1.png)

<br></br>

##Step 6: PNW insurance claim freqency summary

Below we examine the PNW insurance claim counts by the same factors: by commodity, damage cause, year, and county.  

```{r message=FALSE, warning=TRUE, error=TRUE, fig.width = 10, fig.height = 9, fig.show='hold'}

library(plotly)
library(gridExtra)
library(knitr)
library(kableExtra)
library(htmlTable)
library(stringi)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}


palouse_sumloss_1989_2015_lossperacres <- aggregate(Southern_ID_sumloss$lossperacres, list( Southern_ID_sumloss$year, Southern_ID_sumloss$state, Southern_ID_sumloss$commodity), FUN = "mean")

colnames(palouse_sumloss_1989_2015_lossperacres) <- c("year", "state", "commodity",  "lossperacres")

palouse_sumloss_1989_2015_lossperacres2 <- aggregate(Southern_ID_sumloss$lossperacres, list( Southern_ID_sumloss$year, Southern_ID_sumloss$damagecause), FUN = "mean")

colnames(palouse_sumloss_1989_2015_lossperacres2) <- c("year", "damagecause", "lossperacres")

#palouse_sumloss_1989_2015_lossperacres <- subset(palouse_sumloss_1989_2015_lossperacres, lossperacres > 200)
#palouse_sumloss_1989_2015_lossperacres2 <- subset(palouse_sumloss_1989_2015_lossperacres2, lossperacres > 200)

#palouse_sumloss_1989_2015_lossperacres <- subset(palouse_sumloss_1989_2015_lossperacres, commodity != "ADJUSTED GROSS REVENUE")
#palouse_sumloss_1989_2015_lossperacres <- subset(palouse_sumloss_1989_2015_lossperacres, commodity != "Other (Snow/Lightning-Etc.)")

palouse_sumloss_1989_2015_lossperacres2$damagecause <- factor(palouse_sumloss_1989_2015_lossperacres2$damagecause)

palouse_sumloss_1989_2015_lossperacres$commodity <- factor(palouse_sumloss_1989_2015_lossperacres$commodity)


levels(palouse_sumloss_1989_2015_lossperacres$commodity)[14] <- "FORAGE"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[15] <- "APRICOTS"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[16] <- "FREESTONE PEACHES"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[17] <- "NECTARINES"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[24] <- "PASTURE, RANGELAND"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[30] <- "BLACKBERRIES"

levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[8] <- "Excessive Moisture"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[25] <- "Snow/Lightning"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[21] <- "Hurricane"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[24] <- "Mycotoxin"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[22] <- "Lack Irrig Prep"






palouse_sumloss_1989_2015_loss <- aggregate(Southern_ID_sumloss$loss, by = list( Southern_ID_sumloss$year, Southern_ID_sumloss$commodity), FUN = "sum")

colnames(palouse_sumloss_1989_2015_loss) <- c("year", "commodity",  "loss")

palouse_sumloss_1989_2015_loss2 <- aggregate(Southern_ID_sumloss$loss, list( Southern_ID_sumloss$year, Southern_ID_sumloss$damagecause), FUN = "sum")

colnames(palouse_sumloss_1989_2015_loss2) <- c("year", "damagecause", "loss")

psloss <- palouse_sumloss_1989_2015_loss

palouse_sumloss_1989_2015_loss <- subset(palouse_sumloss_1989_2015_loss, loss > 20000000)
palouse_sumloss_1989_2015_loss2 <- subset(palouse_sumloss_1989_2015_loss2, loss > 20000000)

palouse_sumloss_1989_2015_loss <- subset(palouse_sumloss_1989_2015_loss, commodity != "ADJUSTED GROSS REVENUE")

palouse_sumloss_1989_2015_loss2$damagecause <- factor(palouse_sumloss_1989_2015_loss2$damagecause)

palouse_sumloss_1989_2015_loss$commodity <- factor(palouse_sumloss_1989_2015_loss$commodity)


levels(palouse_sumloss_1989_2015_loss2$damagecause)[4] <- "Excessive Moisture"






palouse_sumloss_1989_2015_count <- aggregate(Southern_ID_sumloss$loss, list( Southern_ID_sumloss$year, Southern_ID_sumloss$state, Southern_ID_sumloss$commodity), FUN = "length")

colnames(palouse_sumloss_1989_2015_count) <- c("year", "state", "commodity",  "loss")

palouse_sumloss_1989_2015_count2 <- aggregate(Southern_ID_sumloss$loss, list( Southern_ID_sumloss$year, Southern_ID_sumloss$damagecause), FUN = "length")

colnames(palouse_sumloss_1989_2015_count2) <- c("year", "damagecause", "loss")

#-boxplots of count data for all commodities and all damage causes- 1989-2015

palouse_sumloss_1989_2015_count <- subset(palouse_sumloss_1989_2015_count, loss > 50)
palouse_sumloss_1989_2015_count2 <- subset(palouse_sumloss_1989_2015_count2, loss > 50)

palouse_sumloss_1989_2015_count <- subset(palouse_sumloss_1989_2015_count, commodity != "ADJUSTED GROSS REVENUE")

palouse_sumloss_1989_2015_count2$damagecause <- factor(palouse_sumloss_1989_2015_count2$damagecause)

palouse_sumloss_1989_2015_count$commodity <- factor(palouse_sumloss_1989_2015_count$commodity)


levels(palouse_sumloss_1989_2015_count2$damagecause)[5] <- "Excessive Moisture"
levels(palouse_sumloss_1989_2015_count2$damagecause)[11] <- "Other"


#proper=function(x) paste0(toupper(substr(x, 1, 1)), tolower(substring(x, 2)))

palouse_sumloss_1989_2015_count$commodity <- tolower(palouse_sumloss_1989_2015_count$commodity)
palouse_sumloss_1989_2015_count$commodity <- stri_trans_general(palouse_sumloss_1989_2015_count$commodity, id = "Title")

par(mar=c(9.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_count$loss ~ palouse_sumloss_1989_2015_count$commodity, col = 'lightblue', ylab = "Insurance Claim Frequency", yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_count$commodity, las = 3, cex.axis = 1.4, cex.main = 1.4, cex.lab = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1)
axis(2, las = 1, cex.axis = 1.4, at = pretty(palouse_sumloss_1989_2015_count$loss), labels = pretty(palouse_sumloss_1989_2015_count$loss))

stripchart(palouse_sumloss_1989_2015_count$loss ~ palouse_sumloss_1989_2015_count$commodity, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20 )

graphics::title(xlab="Commodity", line=7.5, cex.lab = 1.4)
graphics::title(main="PNW insurance claims by commodity: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)



par(mar=c(12.7, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_count2$loss ~ palouse_sumloss_1989_2015_count2$damagecause, col = 'lightblue', ylab = "Insurance Claim Frequency",  yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_count2$damagecause, las = 3, cex.main = 1.9, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
axis(2, las = 1, cex.axis = 1.2, at = pretty(palouse_sumloss_1989_2015_count2$loss), labels = pretty(palouse_sumloss_1989_2015_count2$loss))

graphics::title(xlab="Damage Cause", line=11.5, cex.lab = 1.4)
graphics::title(main="PNW insurance claims by damage cause: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)

stripchart(palouse_sumloss_1989_2015_count2$loss ~ palouse_sumloss_1989_2015_count2$damagecause, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20 )


par(mar=c(8, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

means <- aggregate(loss ~  commodity, palouse_sumloss_1989_2015_loss, mean)

palouse_sumloss_1989_2015_loss$commodity <- tolower(palouse_sumloss_1989_2015_loss$commodity)
palouse_sumloss_1989_2015_loss$commodity <- stri_trans_general(palouse_sumloss_1989_2015_loss$commodity, id = "Title")

boxplot(palouse_sumloss_1989_2015_loss$loss ~ palouse_sumloss_1989_2015_loss$commodity, col = 'lightblue', ylab = "Insurance Claim Loss ($)", yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_loss$commodity, las = 3, cex.axis = 1.4, cex.main = 1.4, cex.lab = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
#axis(2, las = 1, cex.axis = 1.2, at = pretty(palouse_sumloss_1989_2015_loss$loss), labels = pretty(palouse_sumloss_1989_2015_loss$loss))

pts <- pretty(palouse_sumloss_1989_2015_loss$loss / 1000000)
pts2 <- pretty(palouse_sumloss_1989_2015_loss$loss)
axis(2, las = 1, cex.axis = 1.4, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")

stripchart(palouse_sumloss_1989_2015_loss$loss ~ palouse_sumloss_1989_2015_loss$commodity, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20 )

graphics::title(xlab="Commodity", line=6, cex.lab = 1.4)
graphics::title(main="PNW insurance loss by commodity: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)

#points(1:nrow(means), means$loss, col = "red")
#text(1:nrow(means), means$loss + 0.08, labels = means$loss)


par(mar=c(12.2, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_loss2$loss ~ palouse_sumloss_1989_2015_loss2$damagecause, col = 'lightblue', ylab = "Insurance Claim Loss ($)",  yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_loss2$damagecause, las = 3, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
#axis(2, las = 1, cex.axis = 1.2, at = pretty(palouse_sumloss_1989_2015_loss2$loss), labels = pretty(palouse_sumloss_1989_2015_loss2$loss))
pts <- pretty(palouse_sumloss_1989_2015_loss2$loss / 1000000)
pts2 <- pretty(palouse_sumloss_1989_2015_loss2$loss)
axis(2, las = 1, cex.axis = 1.2, at = pts2, labels = paste(pts, "M", sep = ""))

stripchart(palouse_sumloss_1989_2015_loss2$loss ~ palouse_sumloss_1989_2015_loss2$damagecause, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20 )

graphics::title(xlab="Damage Cause", line=11, cex.lab = 1.4)
graphics::title(main="PNW insurance loss by damage cause: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)



par(mar=c(11.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

palouse_sumloss_1989_2015_lossperacres$commodity <- tolower(palouse_sumloss_1989_2015_lossperacres$commodity)
palouse_sumloss_1989_2015_lossperacres$commodity <- stri_trans_general(palouse_sumloss_1989_2015_lossperacres$commodity, id = "Title")

boxplot(palouse_sumloss_1989_2015_lossperacres$loss ~ palouse_sumloss_1989_2015_lossperacres$commodity, col = 'lightblue', ylab = "Insurance Claim Loss per Acre ($)", yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_lossperacres$commodity, las = 3, cex.axis = 1.4, cex.main = 1.4, cex.lab = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
axis(2, las = 1, cex.axis = 1.4, at = pretty(palouse_sumloss_1989_2015_lossperacres$loss), labels = pretty(palouse_sumloss_1989_2015_lossperacres$loss))

stripchart(palouse_sumloss_1989_2015_lossperacres$loss ~ palouse_sumloss_1989_2015_lossperacres$commodity, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20 )

graphics::title(xlab="Commodity", line=10.5, cex.lab = 1.4)
graphics::title(main="PNW insurance loss per acre by commodity: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)

par(mar=c(11.8, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_lossperacres2$loss ~ palouse_sumloss_1989_2015_lossperacres2$damagecause, col = 'lightblue', ylab = "Insurance Caim Loss per Acre ($)",  yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_lossperacres2$damagecause, las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
axis(2, las = 1, cex.axis = 1.4, at = pretty(palouse_sumloss_1989_2015_lossperacres2$loss), labels = pretty(palouse_sumloss_1989_2015_lossperacres2$loss))

graphics::title(xlab="Damage Cause", line=10.5, cex.lab = 1.4)
graphics::title(main="PNW insurance loss per acre by damage cause: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)

stripchart(palouse_sumloss_1989_2015_lossperacres2$loss ~ palouse_sumloss_1989_2015_lossperacres2$damagecause, vertical = TRUE,  
    method = "jitter", add = TRUE, pch = 20 )

#model_count <- glm(formula = log(loss) ~ damagecause + commodity, family = "poisson", data = palouse_sumloss_1989_2015_count)

palouse_sumloss_1989_2015_loss_barplot <- aggregate(Southern_ID_sumloss$loss, by = list(Southern_ID_sumloss$commodity), FUN = "sum")
colnames(palouse_sumloss_1989_2015_loss_barplot) <- c("commodity", "loss")

sumloss_nonpalouse$region <- "PNW minus IPNW"
sumloss_palouse$region <- "IPNW"
sumloss_PNW <- rbind(sumloss_nonpalouse, sumloss_palouse)

palouse_sumloss_1989_2015_loss_barplot <- aggregate(sumloss_PNW$loss, by = list(sumloss_PNW$commodity, sumloss_PNW$region), FUN = "sum")

colnames(palouse_sumloss_1989_2015_loss_barplot) <- c("commodity", "region", "loss")

pslb <- aggregate(palouse_sumloss_1989_2015_loss_barplot$loss, by = list(palouse_sumloss_1989_2015_loss_barplot$commodity), FUN = "sum")
colnames(pslb) <- c("commodity", "loss")
pslb <- pslb[with(pslb, order(loss)), ]

palouse_sumloss_1989_2015_loss_barplot <- subset(palouse_sumloss_1989_2015_loss_barplot, commodity == "GRAPES" | commodity == "DRY PEAS" | commodity == "BARLEY" | commodity ==  "POTATOES" | commodity ==  "APPLES" | commodity == "CHERRIES" | commodity == "WHEAT")
colnames(palouse_sumloss_1989_2015_loss_barplot) <- c("commodity", "region", "loss")

palouse_sumloss_1989_2015_loss_barplot <- palouse_sumloss_1989_2015_loss_barplot[with(palouse_sumloss_1989_2015_loss_barplot, order(loss)), ]


palouse_sumloss_1989_2015_loss_barplot$region <- factor(palouse_sumloss_1989_2015_loss_barplot$region, levels = c("PNW minus IPNW", "IPNW"))
pts <- pretty(palouse_sumloss_1989_2015_loss_barplot$loss / 1000000)

palouse_sumloss_1989_2015_loss_barplot$commodity <- tolower(palouse_sumloss_1989_2015_loss_barplot$commodity)
palouse_sumloss_1989_2015_loss_barplot$commodity <- stri_trans_general(palouse_sumloss_1989_2015_loss_barplot$commodity, id = "Title")

gg1 <- ggplot(palouse_sumloss_1989_2015_loss_barplot, aes(fill=region, y=loss, x=commodity)) + 
    geom_bar( stat="identity") + theme_bw() + theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) + ggtitle("PNW vs IPNW loss vs. commodity: 2001 to 2015") + theme(axis.title.y = element_text(family = "Serif", size=24), axis.title.x = element_text(family = "Serif", size = 24), axis.text.x = element_text(size=rel(2.3), angle = 90, hjust = 1, family = "Serif"), axis.text.y = element_text(size=rel(2.3), hjust = 1, family = "Serif")) + theme(plot.title = element_text(family = "Serif", vjust = 2))  + theme(legend.text=element_text(family = "Serif", size=24)) + theme(legend.title=element_text(family = "Serif", size=24, face = "bold")) + theme(plot.title = element_text(size=24, face = "bold")) + scale_y_continuous(labels = paste(pts, "M", sep = ""), breaks = pts * 1000000 ) + ylab("Insurance Claim Loss ($)") + theme(legend.position="bottom") + scale_fill_manual("legend", values = c("PNW minus IPNW" = "red", "IPNW" = "blue")) 

print(gg1)

```

<br></br>

![](https://dmine.io/waf/img/Step1.png)


<br></br>

##Step 7: IPNW Study Area

```{r message=FALSE, warning=FALSE, error=TRUE, fig.width = 10, fig.height = 9}

library(data.table)
library(maptools)
library(classInt)
library(leaflet)
library(dplyr)
library(raster)
library(htmltools)
#--irrigation analysis 2018


#setwd("/dmine/data/counties/")

counties <- readShapePoly('/dmine/data/counties/threestate_palouse.shp',
                     proj4string=CRS
                     ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

#pal <- colorNumeric(palette = c("white", "orange", "darkorange", "red", "darkred"),
#                    domain = counties$NAME)
exte <- as.vector(extent(counties))

#label <- paste(sep = "<br/>", counties$NAME, round(counties$NAME, 0))
#markers <- data.frame(label)
#labs <- as.list(counties$NAME)

counties <- counties[counties$NAME != "Kootenai",]
counties <- counties[counties$NAME != "Clearwater",]


      lat_long <- coordinates(counties)

 counties_a <- data.frame(counties)
      labs <- lapply(seq(nrow(counties_a)), function(i) {
        paste0(as.character(counties_a[i, "NAME"]))
      })

#leaflet(data = counties, options = leafletOptions(minZoom = 6, maxZoom = 6)) %>%  addProviderTiles("Stamen.TonerLite") %>% fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(color = "blue",  weight = 1) %>%

      
#--


mapz <- leaflet(data = counties, options = leafletOptions(zoomControl = FALSE, zoomSnap = .4, zoomDelta = .4)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>% 
  
 
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(color = "lightyellow",  fillOpacity = .8, weight = 1) %>%  addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>%  addPolygons(color = "gray",  fillOpacity = 0, weight = 2) %>%  

  
 # addMiniMap(
#    tiles = providers$Stamen.TonerLite,
#    position = 'topleft', 
#    width = 175, height = 175,
#    toggleDisplay = FALSE) %>%
  
  
addLabelOnlyMarkers(data = counties, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "16px", color = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE, col = "white")
)) 
        
addScaleBar(mapz, position = c("topright"), options = scaleBarOptions())



#markerOptions(map, riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")


```


<br></br>

![](https://dmine.io/waf/img/Step1.png)

<br></br>

##Step 8: IPNW insurance claim loss summary

```{r message=FALSE, warning=FALSE, error=TRUE,  fig.width = 10, fig.height = 9}

library(plotly)
library(gridExtra)
library(knitr)
library(kableExtra)
library(htmlTable)
library(stringi)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}


palouse_sumloss_1989_2015_lossperacres <- aggregate(palouse_lossperacres$lossperacres, list( palouse_lossperacres$year, palouse_lossperacres$state, palouse_lossperacres$commodity), FUN = "mean")



colnames(palouse_sumloss_1989_2015_lossperacres) <- c("year", "state", "commodity",  "lossperacres")

palouse_sumloss_1989_2015_lossperacres2 <- aggregate(palouse_lossperacres$lossperacres, list( palouse_lossperacres$year, palouse_lossperacres$damagecause), FUN = "mean")

colnames(palouse_sumloss_1989_2015_lossperacres2) <- c("year", "damagecause", "lossperacres")

#palouse_sumloss_1989_2015_lossperacres <- subset(palouse_sumloss_1989_2015_lossperacres, lossperacres > 200)
#palouse_sumloss_1989_2015_lossperacres2 <- subset(palouse_sumloss_1989_2015_lossperacres2, lossperacres > 200)

#palouse_sumloss_1989_2015_lossperacres <- subset(palouse_sumloss_1989_2015_lossperacres, commodity != "ADJUSTED GROSS REVENUE")
#palouse_sumloss_1989_2015_lossperacres <- subset(palouse_sumloss_1989_2015_lossperacres, commodity != "Other (Snow/Lightning-Etc.)")

palouse_sumloss_1989_2015_lossperacres2$damagecause <- factor(palouse_sumloss_1989_2015_lossperacres2$damagecause)

palouse_sumloss_1989_2015_lossperacres$commodity <- factor(palouse_sumloss_1989_2015_lossperacres$commodity)


levels(palouse_sumloss_1989_2015_lossperacres$commodity)[13] <- "APRICOTS"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[14] <- "FREESTONE PEACHES"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[15] <- "NECTARINES"
levels(palouse_sumloss_1989_2015_lossperacres$commodity)[22] <- "PASTURE, RANGELAND"

levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[8] <- "Excessive Moisture"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[23] <- "Snow/Lightning"
levels(palouse_sumloss_1989_2015_lossperacres2$damagecause)[21] <- "Lack Irrig Prep"






palouse_sumloss_1989_2015_loss <- aggregate(sumloss_palouse_sum$loss, by = list( sumloss_palouse_sum$year, sumloss_palouse_sum$commodity), FUN = "sum")

colnames(palouse_sumloss_1989_2015_loss) <- c("year", "commodity",  "loss")

palouse_sumloss_1989_2015_loss2 <- aggregate(sumloss_palouse_sum$loss, list( sumloss_palouse_sum$year, sumloss_palouse_sum$damagecause), FUN = "sum")

colnames(palouse_sumloss_1989_2015_loss2) <- c("year", "damagecause", "loss")

psloss <- palouse_sumloss_1989_2015_loss

palouse_sumloss_1989_2015_loss <- subset(palouse_sumloss_1989_2015_loss, loss > 10000000)
palouse_sumloss_1989_2015_loss2 <- subset(palouse_sumloss_1989_2015_loss2, loss > 10000000)

palouse_sumloss_1989_2015_loss <- subset(palouse_sumloss_1989_2015_loss, commodity != "ADJUSTED GROSS REVENUE")

palouse_sumloss_1989_2015_loss2$damagecause <- factor(palouse_sumloss_1989_2015_loss2$damagecause)

palouse_sumloss_1989_2015_loss$commodity <- factor(palouse_sumloss_1989_2015_loss$commodity)


levels(palouse_sumloss_1989_2015_loss2$damagecause)[4] <- "Excessive Moisture"






palouse_sumloss_1989_2015_count <- aggregate(count_palouse_count$count, list( count_palouse_count$year, count_palouse_count$state, count_palouse_count$commodity), FUN = "sum")

colnames(palouse_sumloss_1989_2015_count) <- c("year", "state", "commodity",  "loss")

palouse_sumloss_1989_2015_count2 <- aggregate(count_palouse_count$count, list( count_palouse_count$year, count_palouse_count$damagecause), FUN = "sum")

colnames(palouse_sumloss_1989_2015_count2) <- c("year", "damagecause", "loss")

#-boxplots of count data for all commodities and all damage causes- 1989-2015

palouse_sumloss_1989_2015_count <- subset(palouse_sumloss_1989_2015_count, loss > 50)
palouse_sumloss_1989_2015_count2 <- subset(palouse_sumloss_1989_2015_count2, loss > 50)

palouse_sumloss_1989_2015_count <- subset(palouse_sumloss_1989_2015_count, commodity != "ADJUSTED GROSS REVENUE")

palouse_sumloss_1989_2015_count2$damagecause <- factor(palouse_sumloss_1989_2015_count2$damagecause)

palouse_sumloss_1989_2015_count$commodity <- factor(palouse_sumloss_1989_2015_count$commodity)


levels(palouse_sumloss_1989_2015_count2$damagecause)[5] <- "Excessive Moisture"
#levels(palouse_sumloss_1989_2015_count2$damagecause)[11] <- "Other"


#proper=function(x) paste0(toupper(substr(x, 1, 1)), tolower(substring(x, 2)))

palouse_sumloss_1989_2015_count$commodity <- tolower(palouse_sumloss_1989_2015_count$commodity)
palouse_sumloss_1989_2015_count$commodity <- stri_trans_general(palouse_sumloss_1989_2015_count$commodity, id = "Title")

par(mar=c(9.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_count$loss ~ palouse_sumloss_1989_2015_count$commodity, col = 'lightblue', ylab = "Insurance Claim Frequency", yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_count$commodity, las = 3, cex.axis = 1.4, cex.main = 1.4, cex.lab = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1)
axis(2, las = 1, cex.axis = 1.4, at = pretty(palouse_sumloss_1989_2015_count$loss), labels = pretty(palouse_sumloss_1989_2015_count$loss))

#stripchart(palouse_sumloss_1989_2015_count$loss ~ palouse_sumloss_1989_2015_count$commodity, vertical = TRUE,  
#    method = "jitter", add = TRUE, pch = 20, col=unique(as.numeric(palouse_sumloss_1989_2015_count$state)) )

graphics::title(xlab="Commodity", line=7.5, cex.lab = 1.4)
graphics::title(main="IPNW insurance claims by commodity: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)



par(mar=c(12.7, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_count2$loss ~ palouse_sumloss_1989_2015_count2$damagecause, col = 'lightblue', ylab = "Insurance Claim Frequency",  yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_count2$damagecause, las = 3, cex.main = 1.9, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
axis(2, las = 1, cex.axis = 1.2, at = pretty(palouse_sumloss_1989_2015_count2$loss), labels = pretty(palouse_sumloss_1989_2015_count2$loss))

graphics::title(xlab="Damage Cause", line=11.5, cex.lab = 1.4)
graphics::title(main="IPNW insurance claims by damage cause: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)



par(mar=c(8, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

means <- aggregate(loss ~  commodity, palouse_sumloss_1989_2015_loss, mean)

palouse_sumloss_1989_2015_loss$commodity <- tolower(palouse_sumloss_1989_2015_loss$commodity)
palouse_sumloss_1989_2015_loss$commodity <- stri_trans_general(palouse_sumloss_1989_2015_loss$commodity, id = "Title")

boxplot(palouse_sumloss_1989_2015_loss$loss ~ palouse_sumloss_1989_2015_loss$commodity, col = 'lightblue', ylab = "Insurance Claim Loss ($)", yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_loss$commodity, las = 3, cex.axis = 1.4, cex.main = 1.4, cex.lab = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
#axis(2, las = 1, cex.axis = 1.2, at = pretty(palouse_sumloss_1989_2015_loss$loss), labels = pretty(palouse_sumloss_1989_2015_loss$loss))

pts <- pretty(palouse_sumloss_1989_2015_loss$loss / 1000000)
pts2 <- pretty(palouse_sumloss_1989_2015_loss$loss)
axis(2, las = 1, cex.axis = 1.4, at = pts2, labels = paste(pts, "M", sep = ""))
#abline(v = 14.5, lty = 2, color = "red")
#stripchart(palouse_sumloss_1989_2015_loss$loss ~ palouse_sumloss_1989_2015_loss$commodity, vertical = TRUE,  
#    method = "jitter", add = TRUE, pch = 20, col=unique(as.numeric(palouse_sumloss_1989_2015_loss$state)) )

graphics::title(xlab="Commodity", line=6, cex.lab = 1.4)
graphics::title(main="IPNW insurance loss by commodity: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)

#points(1:nrow(means), means$loss, col = "red")
#text(1:nrow(means), means$loss + 0.08, labels = means$loss)


par(mar=c(12.2, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_loss2$loss ~ palouse_sumloss_1989_2015_loss2$damagecause, col = 'lightblue', ylab = "Insurance Claim Loss ($)",  yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_loss2$damagecause, las = 3, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
#axis(2, las = 1, cex.axis = 1.2, at = pretty(palouse_sumloss_1989_2015_loss2$loss), labels = pretty(palouse_sumloss_1989_2015_loss2$loss))
pts <- pretty(palouse_sumloss_1989_2015_loss2$loss / 1000000)
pts2 <- pretty(palouse_sumloss_1989_2015_loss2$loss)
axis(2, las = 1, cex.axis = 1.2, at = pts2, labels = paste(pts, "M", sep = ""))
#stripchart(palouse_sumloss_1989_2015_loss2$loss ~ palouse_sumloss_1989_2015_loss2$damagecause, vertical = TRUE,  
 #   method = "jitter", add = TRUE, pch = 20, col=unique(as.numeric(palouse_sumloss_1989_2015_loss2$state)) )

graphics::title(xlab="Damage Cause", line=11, cex.lab = 1.4)
graphics::title(main="IPNW insurance loss by damage cause: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)



par(mar=c(11.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

palouse_sumloss_1989_2015_lossperacres$commodity <- tolower(palouse_sumloss_1989_2015_lossperacres$commodity)
palouse_sumloss_1989_2015_lossperacres$commodity <- stri_trans_general(palouse_sumloss_1989_2015_lossperacres$commodity, id = "Title")

boxplot(palouse_sumloss_1989_2015_lossperacres$loss ~ palouse_sumloss_1989_2015_lossperacres$commodity, col = 'lightblue', ylab = "Insurance Claim Loss per Acre ($)", yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_lossperacres$commodity, las = 3, cex.axis = 1.4, cex.main = 1.4, cex.lab = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
axis(2, las = 1, cex.axis = 1.4, at = pretty(palouse_sumloss_1989_2015_lossperacres$loss), labels = pretty(palouse_sumloss_1989_2015_lossperacres$loss))

#stripchart(palouse_sumloss_1989_2015_count$loss ~ palouse_sumloss_1989_2015_count$commodity, vertical = TRUE,  
#    method = "jitter", add = TRUE, pch = 20, col=unique(as.numeric(palouse_sumloss_1989_2015_count$state)) )

graphics::title(xlab="Commodity", line=10.5, cex.lab = 1.4)
graphics::title(main="IPNW insurance loss per acre by commodity: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)

par(mar=c(11.8, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

boxplot(palouse_sumloss_1989_2015_lossperacres2$loss ~ palouse_sumloss_1989_2015_lossperacres2$damagecause, col = 'lightblue', ylab = "Insurance Caim Loss per Acre ($)",  yaxt = 'n', xlab = "", names.arg = palouse_sumloss_1989_2015_lossperacres2$damagecause, las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
axis(2, las = 1, cex.axis = 1.4, at = pretty(palouse_sumloss_1989_2015_lossperacres2$loss), labels = pretty(palouse_sumloss_1989_2015_lossperacres2$loss))

graphics::title(xlab="Damage Cause", line=10.5, cex.lab = 1.4)
graphics::title(main="IPNW insurance loss per acre by damage cause: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)


```

<br></br>

![](https://dmine.io/waf/img/Step1.png)

<br></br>

##Step 9: IPNW insurance claim count summary

```{r message=FALSE, warning=FALSE, error=TRUE,  fig.width = 10, fig.height = 7}
palouse_sumloss_aggregate <- subset(palouse_sumloss_aggregate, year >= 2001 & year <= 2015) 

#palouse_sumloss_1989_2015 <- subset(palouse_sumloss_aggregate, commodity == "WHEAT")

palouse_sumloss_1989_2015 <- aggregate(palouse_sumloss_aggregate$loss, list(palouse_sumloss_aggregate$year), FUN = "sum")

colnames(palouse_sumloss_1989_2015) <- c("year", "loss")

#palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 

X <- palouse_sumloss_1989_2015

#X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")

XX <- X
#XX <- subset(X, loss > 1000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

#YYY1<- YYY1[seq(dim(YYY1)[1],1),]
YYY1$loss <- round(YYY1$loss, 0)
#grid.table(YYY1, theme = tt3, rows = NULL)

YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

dd2 <- cbind(YYY2[1:15, ])
colnames(dd2) <- c("year", "loss")
dd2[is.na(dd2)] <- ""


par(mar=c(7.8, 8.1, 6, 2.1), family = 'serif', mgp=c(6, 1, 0), las=0)
#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$year, las = 3, cex.names = 1.9, yaxt="n", col = "lightblue") 
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""), cex.axis = 1.9)
graphics::title(main="IPNW total insurance \nloss: 2001 to 2015", line = 1, cex.main = 3, adj = 0)
graphics::title(xlab="Years", line=5.5, cex.lab = 1.9)
graphics::title(ylab="Insurance claim loss ($)", line=6.5, cex.lab = 1.9)

#abline(v = 14.5, lty = 2, color = "red")

htmlTable(dd2,
          cgroup = c("2001-2015"),
          n.cgroup = c(2),
          caption = "IPNW region total insurance loss by year, 2001-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")





library(plotly)
library(gridExtra)
library(stringi)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}


#palouse_sumloss_aggregate <- subset(palouse_sumloss_aggregate, year >= 1989 & year <= 201)
palouse_sumloss_1989_2015 <- aggregate(palouse_sumloss_aggregate$loss, list(palouse_sumloss_aggregate$commodity), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("commodity", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
XX <- subset(X, loss > 15000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))

YYY1<- YYY1[seq(dim(YYY1)[1],1),]
#grid.table(YYY1, theme = tt3)


YYY2 <- YYY1
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

YYY2 <- subset(YYY2, commodity != "ADJUSTED GROSS REVENUE")


#kable(YYY1, format = "html", row.names = FALSE) %>% kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE)


YYY1 <- subset(YYY1, commodity != "ADJUSTED GROSS REVENUE")
YYY1 <- subset(YYY1, commodity != "ADJUSTED GROSS REVENUE-LITE")

par(mar=c(10.5, 9.1, 6, 2.1), family = 'serif', mgp=c(6, 1, 0), las=0)

YYY1$commodity<- tolower(YYY1$commodity)
YYY1$commodity <- stri_trans_general(YYY1$commodity, id = "Title")


#levels(YYY1$commodity)[1] <- "ADJ GROSS REVENUE"
barplot(YYY1$loss, names.arg = YYY1$commodity, cex.names = 1.9, las = 3, yaxt="n", cex.lab = 1.9, col = "lightblue") 
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.9, labels = paste(pts, "M", sep = ""))

graphics::title(main="IPNW total insurance loss by \ncommodity: 2001 to 2015", line = 1, cex.main = 3, adj = 0)
graphics::title(xlab="Commodity", line=8.5, cex.lab = 1.9)
graphics::title(ylab="Insurance claim loss ($)", line=6.5, cex.lab = 1.9)


htmlTable(YYY2,
          cgroup = c("2001-2015"),
          caption = "IPNW region total insurance loss by commodity, 2001-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")





library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

#palouse_sumloss_1989_2015 <- subset(palouse_sumloss_aggregate, commodity == "WHEAT")
palouse_sumloss_1989_2015 <- aggregate(palouse_sumloss_aggregate$loss, list(palouse_sumloss_aggregate$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("commodity", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
XX <- subset(X, loss > 10000000)
YYY1 <- XX

tt3 <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                      rowhead=list(fg_params=list(hjust=0, x=0)))


YYY1<- YYY1[seq(dim(YYY1)[1],1),]

YYY2 <- YYY1
levels(YYY2$commodity)[8] <- "Excessive Moisture"
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)
colnames(YYY2) <- c("damage cause", "loss")

#YYY2 <- subset(YYY2, commodity != "ADJUSTED GROSS REVENUE")


#grid.table(YYY1, theme = tt3)
#kable(YYY1, format = "html", row.names = FALSE) %>% kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE)

par(mar=c(15.5, 9.8, 6, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
levels(YYY1$commodity)[8] <- "Excessive Moisture"
barplot(YYY1$loss, names.arg = YYY1$commodity, cex.names = 1.9, las = 3, yaxt="n", col = "lightblue")
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.9, labels = paste(pts, "M", sep = ""))

#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 7.8)

graphics::title(main="IPNW total insurance loss by \ndamage cause: 2001 to 2015", line = 1, cex.main = 3, adj = 0)
graphics::title(xlab="Damage Cause", line=14, cex.lab = 1.9)
graphics::title(ylab="Insurance claim loss ($)", line=7, cex.lab = 1.9)

htmlTable(YYY2,
          cgroup = c("2001-2015"),
          caption = "IPNW region total insurance loss by damage cause, 2001-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

#pie chart of 2001 - 2015 damage causes

p <- plot_ly(YYY1, labels = ~commodity, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' millions'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'iPNW insurance loss by damage cause, all commodities', showlegend = T,
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

p




```

<br></br>

![](https://dmine.io/waf/img/Step1.png)

<br></br>

##Step 10: APPLES, 2001-2015 for the IPNW

```{r message=FALSE, warning=FALSE, error=TRUE}

#--reduce years to 2001-2015
xxyear <- subset(palouse_sumloss_aggregate, year >= 2001)

#missing data review of data from 2001-2015 for all commodities and all damage causes
#ezDesign(xxyear, year, damagecause)
#ezDesign(xxyear, county, damagecause)
#ezDesign(xxyear, county, commodity)

#Now lets subset by the four main commodities of interest.
#--subset to four commodities - Barley, Wheat, Apples, and Dry Peas
xx <- subset(xxyear, commodity == "BARLEY" | commodity == "WHEAT" | 
               commodity == "APPLES" | commodity == "DRY PEAS" | commodity == "CHERRIES" | commodity == "BARLEY")

#--subset to a select set of damage causes - Drought, Heat, Hail, Frost, Freeze, Excessive Moisture, Cold Winter, Cold Weather, and Decline in Price
xxx <- subset(xx, damagecause == "Drought" | damagecause == "Heat" | 
                damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze" | damagecause == "Excessive Moisture/Precip/Rain" | damagecause == "Cold Winter" | 
                damagecause == "Cold Wet Weather" | damagecause == "Decline in Price")


#examine missing data after narrowing commodities and damage causes to the most relevant
#ezDesign(xxx, year, damagecause)
#ezDesign(xxx, county, year)
#ezDesign(xxx, county, damagecause)
#ezDesign(xxx, year, commodity)
#ezDesign(xxx, county, commodity)

#palouse_sumloss_aggregate <- xxx

#now lets divide the data into four different model files that are commodity specific.
xxx_wheat <- subset(xxx, commodity == "WHEAT")
xxx_apples <- subset(xxx, commodity == "APPLES")
xxx_cherries <- subset(xxx, commodity == "CHERRIES")
xxx_drypeas <- subset(xxx, commodity == "DRY PEAS")
xxx_barley <- subset(xxx, commodity == "BARLEY")

palouse_sumloss_aggregate_apples <- xxx_apples
palouse_sumloss_aggregate_cherries <- xxx_cherries
palouse_sumloss_aggregate_drypeas <- xxx_drypeas
palouse_sumloss_aggregate_wheat <- xxx_wheat
palouse_sumloss_aggregate_barley <- xxx_barley

#-remove counties for each commodity file that have considerable missing data.  
#the reasoning is that those counties that have very little of the commodity in question
#may be inappropriate to fill in data as zero.  While there are sporadic commodity loss
#for these counties, there is a high liklihood that this commodity may NOT be grown
#for the missing years, vs just no commodity loss claims.  So we remove these select
#counties given the EzDesign data review of each commodity file

palouse_sumloss_aggregate_apples <- subset(palouse_sumloss_aggregate_apples, 
                                           county != "Columbia" & county != "Wasco")
palouse_sumloss_aggregate_apples$county <- 
  factor(palouse_sumloss_aggregate_apples$county)

palouse_sumloss_aggregate_apples <- 
  subset(palouse_sumloss_aggregate_apples, damagecause != "Drought")
palouse_sumloss_aggregate_apples$damagecause <- 
  factor(palouse_sumloss_aggregate_apples$damagecause)


palouse_sumloss_aggregate_wheat <- 
  subset(palouse_sumloss_aggregate_wheat, county != "Kootenai")
palouse_sumloss_aggregate_wheat$county <- 
  factor(palouse_sumloss_aggregate_wheat$county)

palouse_sumloss_aggregate_cherries <- 
  subset(palouse_sumloss_aggregate_cherries, county != "Adams" & county != "Union")
palouse_sumloss_aggregate_cherries$county <- 
  factor(palouse_sumloss_aggregate_cherries$county)

palouse_sumloss_aggregate_drypeas <- 
  subset(palouse_sumloss_aggregate_drypeas, county != "Douglas" 
         & county != "Gilliam" & county != "Adams")
palouse_sumloss_aggregate_drypeas$county <- 
  factor(palouse_sumloss_aggregate_drypeas$county)

palouse_sumloss_aggregate_barley <- 
  subset(palouse_sumloss_aggregate_barley, county != "Douglas" & county != "Garfield"
         & county != "Gilliam" & county != "Adams" & county != "Kootenai" & county != "Benton")
palouse_sumloss_aggregate_barley$county <- 
  factor(palouse_sumloss_aggregate_barley$county)

palouse_sumloss_aggregate_barley <- 
  subset(palouse_sumloss_aggregate_barley, damagecause != "Cold Winter")
palouse_sumloss_aggregate_barley$damagecause <- 
  factor(palouse_sumloss_aggregate_barley$damagecause)

#re-factor 

palouse_sumloss_aggregate_apples$damagecause <- factor(palouse_sumloss_aggregate_apples$damagecause)
palouse_sumloss_aggregate_wheat$damagecause <- factor(palouse_sumloss_aggregate_wheat$damagecause)
palouse_sumloss_aggregate_cherries$damagecause <- factor(palouse_sumloss_aggregate_cherries$damagecause)
palouse_sumloss_aggregate_drypeas$damagecause <- factor(palouse_sumloss_aggregate_drypeas$damagecause)
palouse_sumloss_aggregate_barley$damagecause <- factor(palouse_sumloss_aggregate_barley$damagecause)

```



```{r message=FALSE, warning=FALSE, error=TRUE, fig.width = 10, fig.height = 7}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

APPLES <- subset(palouse_sumloss_aggregate, commodity == "APPLES")

palouse_sumloss_1989_2015 <- aggregate(APPLES$loss, list(APPLES$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 1500000) 
summary_dataset2 <- X %>% filter(loss > 1500000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

#--year
palouse_sumloss_year <- aggregate(APPLES$loss, list(APPLES$year), FUN = "sum")
colnames(palouse_sumloss_year) <- c("year", "loss")

#--county

palouse_sumloss_county <- aggregate(APPLES$loss, list(APPLES$county), FUN = "sum")
colnames(palouse_sumloss_county) <- c("county", "loss")

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' million'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for APPLES, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

p <- plot_ly(palouse_sumloss_year, labels = ~year, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' million'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Years for APPLES, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

p <- plot_ly(palouse_sumloss_county, labels = ~county, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' million'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Counties for APPLES, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

           
#p

YYY2 <- YYY1
YYY2$loss <- round(YYY2$loss, digits = 0)
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

#--year
palouse_sumloss_year <- aggregate(APPLES$loss, list(APPLES$year), FUN = "sum")
colnames(palouse_sumloss_year) <- c("year", "loss")

#--county

palouse_sumloss_county <- aggregate(APPLES$loss, list(APPLES$county), FUN = "sum")
colnames(palouse_sumloss_county) <- c("county", "loss")

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(palouse_sumloss_county$loss, names.arg = palouse_sumloss_county$county, cex.names = 1.4, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(palouse_sumloss_county$loss / 1000000)
pts2 <- pretty(palouse_sumloss_county$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 8)

graphics::title(main="Apples insurance loss by commodity: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Counties", line=8, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(palouse_sumloss_year$loss, names.arg = palouse_sumloss_year$year, cex.names = 1.4, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(palouse_sumloss_year$loss / 1000000)
pts2 <- pretty(palouse_sumloss_year$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

#mtext(text = "Years",
#      side = 1,#side 1 = bottom
#      line = 8)

graphics::title(main="Apples insurance loss by year: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Years", line=8, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(YYY1$loss, names.arg = YYY1$damagecause, cex.names = 1.4, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 8)

graphics::title(main="Apples insurance loss by damage cause: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Damage Cause", line=11, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)


htmlTable(YYY2,
          cgroup = c("2001-2015"),
           caption = "IPNW region APPLES total insurance loss by damage cause, 2001-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

```



```{r message=FALSE, warning=FALSE, error=TRUE,  fig.width = 10, fig.height = 7}

states <- readShapePoly('/dmine/data/states/states.shp', 
                                  proj4string=CRS
                                  ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
        projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

#--interaction plot loss vs year for all damage causes, all Palouse counties

APPLES <- subset(palouse_sumloss_aggregate, commodity == "APPLES")


levels(APPLES$damagecause)[8] <- "Excessive Moisture"
APPLES$damagecause <- factor(APPLES$damagecause)

APPLES_damage <- subset(APPLES, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze" | damagecause == "Cold Wet Weather" | damagecause == "Wind/Excess Wind" | damagecause == "Heat")

APPLES_damage$damagecause <- factor(APPLES_damage$damagecause)
#aggregate(WHEAT_damage$loss, list(WHEAT_damage$damagecause), FUN = "sum")

library(scales)

APPLES_damage_top <- subset(APPLES_damage, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")
APPLES_damage_top <- subset(APPLES_damage_top, year >= 2001 & year <= 2015)


APPLES_damage_top_agg_hailfrostfreeze <- aggregate(APPLES_damage_top$loss, by = list(APPLES_damage_top$county), FUN = "sum")
colnames(APPLES_damage_top_agg_hailfrostfreeze) <- c("NAME", "loss")

county_apples_hailfrostfreeze <- merge(counties, APPLES_damage_top_agg_hailfrostfreeze, by = "NAME")

#2013

APPLES_damage_top2013 <- subset(APPLES_damage, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")
APPLES_damage_top2013 <- subset(APPLES_damage_top2013, year == 2013)



APPLES_damage_top_agg_hailfrostfreeze2013 <- aggregate(APPLES_damage_top2013$loss, by = list(APPLES_damage_top2013$county), FUN = "sum")
colnames(APPLES_damage_top_agg_hailfrostfreeze2013) <- c("NAME", "loss")

county_apples_hailfrostfreeze2013 <- merge(counties, APPLES_damage_top_agg_hailfrostfreeze2013, by = "NAME")

#2006

APPLES_damage_top2006 <- subset(APPLES_damage, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")
APPLES_damage_top2006 <- subset(APPLES_damage_top2006, year == 2006)



APPLES_damage_top_agg_hailfrostfreeze2006 <- aggregate(APPLES_damage_top2006$loss, by = list(APPLES_damage_top2006$county), FUN = "sum")
colnames(APPLES_damage_top_agg_hailfrostfreeze2006) <- c("NAME", "loss")

county_apples_hailfrostfreeze2006 <- merge(counties, APPLES_damage_top_agg_hailfrostfreeze2006, by = "NAME")


#how many claims of hail in walla walla in 2006?  2!

apples_hailfrostfreeze_count2006 <- subset(count_palouse_count, commodity == "APPLES")
apples_hailfrostfreeze_count2006 <- subset(apples_hailfrostfreeze_count2006, year == "2006")
apples_hailfrostfreeze_count2006 <- subset(apples_hailfrostfreeze_count2006, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")


apples_hailfrostfreeze_count2006_sum <- aggregate(apples_hailfrostfreeze_count2006$count, by=list(apples_hailfrostfreeze_count2006$county), FUN = "sum")
colnames(apples_hailfrostfreeze_count2006_sum) <- c("county", "count")



#2015

APPLES_damage_top2015 <- subset(APPLES_damage, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")
APPLES_damage_top2015 <- subset(APPLES_damage_top2015, year == 2015)



APPLES_damage_top_agg_hailfrostfreeze2015 <- aggregate(APPLES_damage_top2015$loss, by = list(APPLES_damage_top2015$county), FUN = "sum")
colnames(APPLES_damage_top_agg_hailfrostfreeze2015) <- c("NAME", "loss")

county_apples_hailfrostfreeze2015 <- merge(counties, APPLES_damage_top_agg_hailfrostfreeze2015, by = "NAME")


#2012

APPLES_damage_top2012 <- subset(APPLES_damage, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")
APPLES_damage_top2012 <- subset(APPLES_damage_top2012, year == 2012)



APPLES_damage_top_agg_hailfrostfreeze2012 <- aggregate(APPLES_damage_top2012$loss, by = list(APPLES_damage_top2012$county), FUN = "sum")
colnames(APPLES_damage_top_agg_hailfrostfreeze2012) <- c("NAME", "loss")

county_apples_hailfrostfreeze2012 <- merge(counties, APPLES_damage_top_agg_hailfrostfreeze2012, by = "NAME")



#ggplot(APPLES_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
#    geom_bar( stat="identity") + theme_bw() + ggtitle("IPNW apples loss vs. year - top damage causes") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(size=rel(1.5), angle = 90, hjust = 1, family = "Serif")) + theme(plot.title = element_text(hjust = 0.5, family = "Serif"))  +  scale_x_discrete(limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14)) + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=18)) + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))

par(mar=c(11,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

gg2 <- ggplot(APPLES_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
    geom_bar( stat="identity") + theme_bw() + theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) + ggtitle("IPNW apples loss vs. year - top damage causes") + theme(axis.title.y = element_text(family = "Serif", size=24), axis.title.x = element_text(family = "Serif", size = 24), axis.text.y = element_text(size=rel(2.5), hjust = 1, family = "Serif"), axis.text.x = element_text(size=rel(2.5), angle = 90, hjust = 1, family = "Serif")) + theme(plot.title = element_text(size =28, family = "Serif"))  +  scale_x_discrete(name = "Years", limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14)) + scale_fill_manual("legend", values = c("Hail" = "red", "Frost" = "blue", "Freeze" = "gray")) + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=24, family = "Serif", face = "bold")) + scale_y_continuous(name = "Insurance claim loss ($)", label = unit_format(unit = "M", scale = 1e-6, digits = 0)) + theme(legend.position="bottom")

print(gg2)

apples <- palouse_sumloss_aggregate_apples
#i <- interaction.plot(x.factor     = apples$year,
#                 trace.factor = apples$damagecause, 
#                 trace.label = "apples",
#                 response     = apples$loss, 
#                 fun = sum,
#                 las = 3,
#                 type="p",
#                 col=c("black","red","green"),  ### Colors for levels of trace var.
#                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
#                 fixed=TRUE,                    ### Order by factor order in data
#                 leg.bty = "n",
#                 ylab="",
#                 xlab="Year",
#                 main="Interaction Plot - APPLES Loss vs. year - top damage causes", las = 2)

#EDA for apples
#-boxplots of data by cube loss by each of the three factors
par(mar=c(8,8,4,2), family = 'serif', mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_apples, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_apples$log10loss)
pts2 <- pretty(palouse_sumloss_aggregate_apples$log10loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

graphics::title(main="Logrithmic transform: IPNW apples insurance loss by year", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Years", line=4, cex.lab = 1.4)
graphics::title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)

stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_apples, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

par(mar=c(11,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_apples, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_apples$log10loss)
pts2 <- pretty(palouse_sumloss_aggregate_apples$log10loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

graphics::title(main="Logrithmic transform: IPNW apples insurance loss\nby damage cause", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Damage Cause", line=7, cex.lab = 1.4)
graphics::title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)

stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_apples, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')


par(mar=c(11,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ county, palouse_sumloss_aggregate_apples, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_apples$log10loss)
pts2 <- pretty(palouse_sumloss_aggregate_apples$log10loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

graphics::title(main="Logrithmic transform: IPNW apples insurance loss\nby county", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Counties", line=7, cex.lab = 1.4)
graphics::title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)


stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_apples, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')



#--

counties_apples <- counties[counties$NAME != "Lewis",]
counties_apples <- counties_apples[counties_apples$NAME != "Lincoln",]
counties_apples <- counties_apples[counties_apples$NAME != "Kootenai",]
counties_apples <- counties_apples[counties_apples$NAME != "Garfield",]
counties_apples <- counties_apples[counties_apples$NAME != "Wallowa",]
counties_apples <- counties_apples[counties_apples$NAME != "Nez Perce",]
counties_apples <- counties_apples[counties_apples$NAME != "Latah",]
counties_apples <- counties_apples[counties_apples$NAME != "Sherman",]
counties_apples <- counties_apples[counties_apples$NAME != "Morrow",]
counties_apples <- counties_apples[counties_apples$NAME != "Union",]
counties_apples <- counties_apples[counties_apples$NAME != "Whitman",]
counties_apples <- counties_apples[counties_apples$NAME != "Asotin",]
counties_apples <- counties_apples[counties_apples$NAME != "Benewah",]
counties_apples <- counties_apples[counties_apples$NAME != "Spokane",]
counties_apples <- counties_apples[counties_apples$NAME != "Clearwater",]
counties_apples <- counties_apples[counties_apples$NAME != "Gilliam",]
counties_apples <- counties_apples[counties_apples$NAME != "Idaho",]
counties_apples <- counties_apples[counties_apples$NAME != "Wasco",]

counties_apples$NAME <- factor(counties_apples$NAME)

labs2 <- lapply(seq(nrow(counties_apples@data)), function(i) {
        paste0(as.character(counties_apples@data[i, "NAME"]))
      })



#-----2001 - 2015

county_apples_hailfrostfreeze2 <- county_apples_hailfrostfreeze
county_apples_hailfrostfreeze2$loss[is.na(county_apples_hailfrostfreeze2$loss)] <- 0


 pal <- colorNumeric(colorRampPalette(c("lightblue", "blue"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_apples_hailfrostfreeze$", "loss", sep=""))))

map <- leaflet(data = county_apples_hailfrostfreeze, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 100, height = 100,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_apples_hailfrostfreeze$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Apples hail frost<br>freeze 2001 to 2015", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_apples_hailfrostfreeze, lng = lat_long[,1], lat = lat_long[,2], label = lapply(paste(round((county_apples_hailfrostfreeze2$loss / 1000000), 2), "M", sep=""), HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "24px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())

par(mar=c(8.5, 6.1, 6, 2.1), family = 'serif', mgp=c(5, 1, 0), las=0)
  barplot(APPLES_damage_top_agg_hailfrostfreeze$loss, names.arg = APPLES_damage_top_agg_hailfrostfreeze$NAME, yaxt="n", las = 2, col = "lightblue", cex.lab = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1)
pts <- pretty(APPLES_damage_top_agg_hailfrostfreeze$loss / 1000000)
pts2 <- pretty(APPLES_damage_top_agg_hailfrostfreeze$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))
graphics::title(main="IPNW apples insurance loss due to hail, frost, and freeze\n2001 to 2015", line = 2, adj = 0, cex.main = 1.9)
graphics::title(xlab="Counties", line=7, cex.lab = 1.4)
graphics::title(ylab="Apples insurance claim loss ($)", line=4, cex.lab = 1.4)


#-2013


 pal <- colorNumeric(colorRampPalette(c("lightblue", "blue"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_apples_hailfrostfreeze2013$", "loss", sep=""))))

map <- leaflet(data = county_apples_hailfrostfreeze2013, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_apples_hailfrostfreeze2013$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Apples hail frost<br>freeze 2013", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_apples_hailfrostfreeze2013, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())

par(mar=c(8.5, 6.1, 6, 2.1), family = 'serif', mgp=c(5, 1, 0), las=0)
  barplot(APPLES_damage_top_agg_hailfrostfreeze2013$loss, names.arg = APPLES_damage_top_agg_hailfrostfreeze2013$NAME, yaxt="n", las = 2, col = "lightblue", cex.lab = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1)
pts <- pretty(APPLES_damage_top_agg_hailfrostfreeze2013$loss / 1000000)
pts2 <- pretty(APPLES_damage_top_agg_hailfrostfreeze2013$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))
graphics::title(main="IPNW apples insurance loss due to hail, frost, and freeze\n2013", line = 2, adj = 0, cex.main = 1.9)
graphics::title(xlab="Counties", line=7, cex.lab = 1.4)
graphics::title(ylab="Apples insurance claim loss ($)", line=4, cex.lab = 1.4)

#-2012


 pal <- colorNumeric(colorRampPalette(c("lightblue", "blue"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_apples_hailfrostfreeze2012$", "loss", sep=""))))

map <- leaflet(data = county_apples_hailfrostfreeze2012, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_apples_hailfrostfreeze2012$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Apples hail frost<br>freeze 2012", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_apples_hailfrostfreeze2012, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())

par(mar=c(8.5, 6.1, 6, 2.1), family = 'serif', mgp=c(5, 1, 0), las=0)
  barplot(APPLES_damage_top_agg_hailfrostfreeze2012$loss, names.arg = APPLES_damage_top_agg_hailfrostfreeze2012$NAME, yaxt="n", las = 2, col = "lightblue", cex.lab = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1)
pts <- pretty(APPLES_damage_top_agg_hailfrostfreeze2012$loss / 1000000)
pts2 <- pretty(APPLES_damage_top_agg_hailfrostfreeze2012$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))
graphics::title(main="IPNW apples insurance loss due to hail, frost, and freeze\n2012", line = 2, adj = 0, cex.main = 1.9)
graphics::title(xlab="Counties", line=7, cex.lab = 1.4)
graphics::title(ylab="Apples insurance claim loss ($)", line=4, cex.lab = 1.4)




#-2006


 pal <- colorNumeric(colorRampPalette(c("lightblue", "blue"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_apples_hailfrostfreeze2006$", "loss", sep=""))))

map <- leaflet(data = county_apples_hailfrostfreeze2006, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_apples_hailfrostfreeze2006$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Apples hail frost<br>freeze 2006", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_apples_hailfrostfreeze2006, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())

par(mar=c(8.5, 6.1, 6, 2.1), family = 'serif', mgp=c(5, 1, 0), las=0)
  barplot(APPLES_damage_top_agg_hailfrostfreeze2006$loss, names.arg = APPLES_damage_top_agg_hailfrostfreeze2006$NAME, yaxt="n", las = 2, col = "lightblue", cex.lab = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1)
pts <- pretty(APPLES_damage_top_agg_hailfrostfreeze2006$loss / 1000000)
pts2 <- pretty(APPLES_damage_top_agg_hailfrostfreeze2006$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))
graphics::title(main="IPNW apples insurance loss due to hail, frost, and freeze\n2006", line = 2, adj = 0, cex.main = 1.9)
graphics::title(xlab="Counties", line=7, cex.lab = 1.4)
graphics::title(ylab="Apples insurance claim loss ($)", line=4, cex.lab = 1.4)

gg3 <- ggplot(apples_hailfrostfreeze_count2006, aes(fill=damagecause, y=count, x=county)) + 
    geom_bar( stat="identity") + theme_bw() + theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) + ggtitle("2006 IPNW apples counts vs. county: Hail/Frost/Freeze") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(size=rel(2), angle = 90, hjust = 1, family = "Serif"), axis.text.y = element_text(size=rel(2), family = "Serif")) + theme(plot.title = element_text(size =28, family = "Serif"))  + theme(legend.text=element_text(family = "Serif", size=14)) + scale_fill_manual("legend", values = c("Hail" = "red", "Frost" = "blue", "Freeze" = "gray")) + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=24, family = "Serif", face = "bold")) +  theme(legend.position="bottom") + scale_y_discrete(limits=c(1:10))

print(gg3)

#-2015


 pal <- colorNumeric(colorRampPalette(c("lightblue", "blue"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_apples_hailfrostfreeze2015$", "loss", sep=""))))

map <- leaflet(data = county_apples_hailfrostfreeze2015, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_apples_hailfrostfreeze2015$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Apples hail frost<br>freeze 2015", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_apples_hailfrostfreeze2015, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())


par(mar=c(8.5, 6.1, 6, 2.1), family = 'serif', mgp=c(5, 1, 0), las=0)
  barplot(APPLES_damage_top_agg_hailfrostfreeze2015$loss, names.arg = APPLES_damage_top_agg_hailfrostfreeze2015$NAME, yaxt="n", las = 2, col = "lightblue", cex.lab = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1)
pts <- pretty(APPLES_damage_top_agg_hailfrostfreeze2015$loss / 1000000)
pts2 <- pretty(APPLES_damage_top_agg_hailfrostfreeze2015$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))
graphics::title(main="IPNW apples insurance loss due to hail, frost, and freeze\n2015", line = 2, adj = 0, cex.main = 1.9)
graphics::title(xlab="Counties", line=7, cex.lab = 1.4)
graphics::title(ylab="Apples insurance claim loss ($)", line=4, cex.lab = 1.4)


#markerOptions(riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")

library(plotly)
library(gridExtra)
library(knitr)
library(kableExtra)
library(htmlTable)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

#--counts wheat drought

palouse_sumloss_aggregate_wheat <- subset(palouse_counts, commodity == "APPLES")

palouse_sumloss_1989_2015_count <- aggregate(palouse_sumloss_aggregate_wheat$count, list( palouse_sumloss_aggregate_wheat$month, palouse_sumloss_aggregate_wheat$year, palouse_sumloss_aggregate_wheat$damagecause, palouse_sumloss_aggregate_wheat$county, palouse_sumloss_aggregate_wheat$state), FUN = "sum")

palouse_sumloss_1989_2015_count_year <- aggregate(palouse_sumloss_aggregate_wheat$count, list(palouse_sumloss_aggregate_wheat$year, palouse_sumloss_aggregate_wheat$damagecause, palouse_sumloss_aggregate_wheat$county, palouse_sumloss_aggregate_wheat$state), FUN = "sum")

palouse_sumloss_1989_2015_count_year_nocounty <- aggregate(palouse_sumloss_aggregate_wheat$count, list(palouse_sumloss_aggregate_wheat$year, palouse_sumloss_aggregate_wheat$damagecause, palouse_sumloss_aggregate_wheat$state), FUN = "sum")

colnames(palouse_sumloss_1989_2015_count) <- c("month", "year", "damagecause", "county", "state", "count")
colnames(palouse_sumloss_1989_2015_count_year) <- c("year", "damagecause", "county", "state", "count")
colnames(palouse_sumloss_1989_2015_count_year_nocounty) <- c("year", "damagecause", "state", "count")

#--loss

palouse_sumloss_aggregate_wheat_loss <- subset(palouse_sumloss, commodity == "APPLES")

palouse_sumloss_1989_2015_loss <- aggregate(palouse_sumloss_aggregate_wheat_loss$loss, list( palouse_sumloss_aggregate_wheat_loss$month, palouse_sumloss_aggregate_wheat_loss$year, palouse_sumloss_aggregate_wheat_loss$damagecause, palouse_sumloss_aggregate_wheat_loss$county, palouse_sumloss_aggregate_wheat_loss$state), FUN = "sum")

palouse_sumloss_1989_2015_loss_year <- aggregate(palouse_sumloss_aggregate_wheat_loss$loss, list(palouse_sumloss_aggregate_wheat_loss$year, palouse_sumloss_aggregate_wheat_loss$damagecause, palouse_sumloss_aggregate_wheat_loss$county, palouse_sumloss_aggregate_wheat_loss$state), FUN = "sum")

colnames(palouse_sumloss_1989_2015_loss) <- c("month", "year", "damagecause", "county", "state", "loss")
colnames(palouse_sumloss_1989_2015_loss_year) <- c("year", "damagecause", "county", "state", "loss")






#palouse_sumloss_1989_2015_count_county <- aggregate(palouse_sumloss_aggregate_wheat$loss, list( palouse_sumloss_aggregate_wheat$damagecause, palouse_sumloss_aggregate_wheat$year, palouse_sumloss_aggregate_wheat$county ), FUN = "length")

#colnames(palouse_sumloss_1989_2015_count) <- c("damagecause", "year", "loss")

#colnames(palouse_sumloss_1989_2015_count_county) <- c("damagecause", "year", "county", "loss")


#-boxplots of count data for all commodities and all damage causes- 1989-2015

#palouse_sumloss_1989_2015_count_commodity <- subset(palouse_sumloss_1989_2015_count, loss > 20)
#palouse_sumloss_1989_2015_count_commodity <- subset(palouse_sumloss_1989_2015_count_commodity, commodity != "ADJUSTED GROSS REVENUE")
#palouse_sumloss_1989_2015_count$damagecause <- factor(palouse_sumloss_1989_2015_count$damagecause)

#palouse_sumloss_1989_2015_count_commodity$commodity <- factor(palouse_sumloss_1989_2015_count_commodity$commodity)


#par(mar=c(8.8, 6.1, 2.1, 2.1), mgp=c(3, 1, 0), las=0)



psc_drought <- subset(palouse_sumloss_1989_2015_count_year, damagecause == "Hail" | damagecause == "Frost" | damagecause == "Freeze")

#--create missing county year data where no values are found
d1 <- data.frame(unique(palouse_counts$county))
colnames(d1) <- "county"

d2 <- data.frame(unique(palouse_counts$year))
colnames(d2) <- "year"
d2 <- d2[order(d2$year),]
d2 <- data.frame(d2)
colnames(d2) <- "year"

d2a <- c("WA", "WA", "WA", "WA", "WA", "WA", "OR", "OR", "WA", "ID", "ID", "ID", "ID", "ID", "ID", "WA", "OR", "OR", "OR", "OR", "OR", "OR", "WA", "WA", "ID", "WA")

d2a <- data.frame(d2a)
colnames(d2a) <- "state"

d1 <- data.frame(d1[rep(seq_len(nrow(d1)), each=27),])
d2 <- do.call("rbind", replicate(26, d2, simplify = FALSE))
d2a <- data.frame(d2a[rep(seq_len(nrow(d2a)), each=27),])

d3 <- cbind(d1, d2a, d2)
colnames(d3) <- c("county", "state", "year")

psc_drought2 <- merge(d3, psc_drought, by = c("year", "county"), all = TRUE)
psc_drought2$count[is.na(psc_drought2$count)] <- 0

psc_drought2 <- subset(psc_drought2, year >= 2001)

psc_drought2$countystate <- paste(psc_drought2$county, psc_drought2$state.x, sep=", ")

#figure out which counties have all zeros and eliminate
psc_drought2a <- aggregate(psc_drought2$count, by = list(psc_drought2$countystate), FUN = "sum")
colnames(psc_drought2a) <- c("countystate", "count")

psc <- subset(psc_drought2a, count != 0)


psc3 <- subset(psc_drought2, countystate %in% psc$countystate )



par(mar=c(5,6,4,2)+0.1, family = 'serif', mgp=c(5,1,0))
interaction.plot(x.factor     = psc3$year,
                 trace.factor = psc3$countystate, 
                 response     = psc3$count, 
                 fun = sum,
                 las = 2,
                 type="l",
                 col=c("black","red1","green1", "blue1", "yellow1", "red2","green2", "blue2", "yellow2","red3","green3", "blue3", "yellow3","red4","green4", "blue4", "yellow4"),  ### Colors for levels of trace var.
                 #pch=c(19, 17, 15),             ### Symbols for levels of trace var.
                 fixed=FALSE,                    ### Order by factor order in data
                 leg.bty = "n",
                 ylab="",
                 legend = FALSE,
                 xlab="")
                 #main="Annual Apples Insurance Claim Frequency \n by county for the IPNW Study Area, 1989-2015: HAIL/FROST/FREEZE", las = 2)

graphics::title(main="Annual IPNW Apples Insurance Claim Frequency by county\n2001-2015: HAIL/FROST/FREEZE", adj = 0, cex.main = 1.9)
graphics::title(xlab="Years", line=4, cex.lab = 1.4)
graphics::title(ylab="Apples Claim Frequency: Hail/Frost/Freeze", line=3.5, cex.lab = 1.4)


psc_drought <- palouse_sumloss_1989_2015_count_year

#--create missing county year data where no values are found
d1 <- data.frame(unique(palouse_counts$county))
colnames(d1) <- "county"

d2 <- data.frame(unique(palouse_counts$year))
colnames(d2) <- "year"
d2 <- d2[order(d2$year),]
d2 <- data.frame(d2)
colnames(d2) <- "year"

d2a <- c("WA", "WA", "WA", "WA", "WA", "WA", "OR", "OR", "WA", "ID", "ID", "ID", "ID", "ID", "ID", "WA", "OR", "OR", "OR", "OR", "OR", "OR", "WA", "WA", "ID", "WA")

d2a <- data.frame(d2a)
colnames(d2a) <- "state"

d1 <- data.frame(d1[rep(seq_len(nrow(d1)), each=27),])
d2 <- do.call("rbind", replicate(26, d2, simplify = FALSE))
d2a <- data.frame(d2a[rep(seq_len(nrow(d2a)), each=27),])

d3 <- cbind(d1, d2a, d2)
colnames(d3) <- c("county", "state", "year")

psc_drought2 <- merge(d3, psc_drought, by = c("year", "county"), all = TRUE)
psc_drought2$count[is.na(psc_drought2$count)] <- 0

psc_drought2 <- subset(psc_drought2, year >= 2001)

psc_drought2$countystate <- paste(psc_drought2$county, psc_drought2$state.x, sep=", ")

#figure out which counties have all zeros and eliminate
psc_drought2a <- aggregate(psc_drought2$count, by = list(psc_drought2$countystate), FUN = "sum")
colnames(psc_drought2a) <- c("countystate", "count")

psc <- subset(psc_drought2a, count != 0)


psc3 <- subset(psc_drought2, countystate %in% psc$countystate )


#par(mar=c(5,6,4,2)+0.1, family = 'serif', mgp=c(5,1,0))
interaction.plot(x.factor     = psc3$year,
                 trace.factor = psc3$countystate, 
                 response     = psc3$count, 
                 fun = sum,
                 las = 2,
                 type="l",
                 col=c("black","red1","green1", "blue1", "yellow1", "red2","green2", "blue2", "yellow2","red3","green3", "blue3", "yellow3","red4","green4", "blue4", "yellow4"),  ### Colors for levels of trace var.
                 #pch=c(19, 17, 15),             ### Symbols for levels of trace var.
                 fixed=FALSE,                    ### Order by factor order in data
                 leg.bty = "n",
                 ylab="",
                 legend = FALSE,
                 xlab="")
                 #main="Annual Apples Insurance Claim Frequency \n by county for the IPNW Study Area, 1989-2015: ALL DAMAGE CAUSES", las = 2)

graphics::title(main="Annual IPNW Apples Insurance Claim Frequency by county\n2001-2015: All Damage Causes", adj = 0, cex.main = 1.9)
graphics::title(xlab="Years", line=4, cex.lab = 1.4)
graphics::title(ylab="Apples Claim Frequency: All Damage Causes", line=3.5, cex.lab = 1.4)

#boxplot(palouse_sumloss_1989_2015_loss_year$loss ~ palouse_sumloss_1989_2015_loss_year$year, ylab = "Insurance Claim Frequency", xlab = "", names.arg = palouse_sumloss_1989_2015_loss_year$year, las = 3, main = "IPNW Wheat Insurance Loss Frequencies/Year 1989-2015")

#title(xlab="Year", line=7)


#boxplot(palouse_sumloss_1989_2015_count_year_nocounty$count ~ palouse_sumloss_1989_2015_count_year_nocounty$year, ylab = "Insurance Claim Frequency", xlab = "", names.arg = palouse_sumloss_1989_2015_count_year_nocounty$year, las = 3, main = "IPNW Wheat Insurance Loss Frequencies/Year 1989-2015")

#title(xlab="Damage Cause", line=7)


#plot(palouse_sumloss_1989_2015_count$loss ~ palouse_sumloss_1989_2015_count$damagecause, ylab = "Insurance Claim Frequency", xlab = "", names.arg = palouse_sumloss_1989_2015_count$damagecause, las = 3, main = "IPNW Wheat Insurance Loss Frequencies/Year 1989-2015")

#title(xlab="Damage Cause", line=7)


#psc_drought <- subset(palouse_sumloss_1989_2015_count_county, damagecause == "Drought")


#barplot(psc_drought$loss, ylab = "Insurance Claim Frequency", xlab = "", names.arg = psc_drought$year, las = 3, main = "IPNW Wheat Insurance Loss Frequencies/Year 1989-2015")

#title(xlab="Damage Cause", line=7)

#model_count <- glm(formula = log(loss) ~ damagecause + commodity, family = "poisson", data = palouse_sumloss_1989_2015_count)



```

![](https://dmine.io/waf/img/Step1.png)

<br></br>

##Step 11: BARLEY, 2001-2015 for the IPNW

```{r message=FALSE, warning=FALSE, error=TRUE, fig.width = 10, fig.height = 7}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

BARLEY <- subset(palouse_sumloss_aggregate, commodity == "BARLEY")

palouse_sumloss_1989_2015 <- aggregate(BARLEY$loss, list(BARLEY$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 390000) 
summary_dataset2 <- X %>% filter(loss > 390000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' million'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for BARLEY, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

           
#p

YYY2 <- YYY1
YYY2$loss <- round(YYY2$loss, digits = 0)
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)


#--year
palouse_sumloss_year <- aggregate(BARLEY$loss, list(BARLEY$year), FUN = "sum")
colnames(palouse_sumloss_year) <- c("year", "loss")

#--county

palouse_sumloss_county <- aggregate(BARLEY$loss, list(BARLEY$county), FUN = "sum")
colnames(palouse_sumloss_county) <- c("county", "loss")

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(palouse_sumloss_county$loss, names.arg = palouse_sumloss_county$county, cex.names = 1.4, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(palouse_sumloss_county$loss / 1000000)
pts2 <- pretty(palouse_sumloss_county$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 8)

graphics::title(main="IPNW Barley insurance loss by commodity: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Counties", line=8, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(palouse_sumloss_year$loss, names.arg = palouse_sumloss_year$year, cex.names = 1.4, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(palouse_sumloss_year$loss / 1000000)
pts2 <- pretty(palouse_sumloss_year$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

#mtext(text = "Years",
#      side = 1,#side 1 = bottom
#      line = 8)

graphics::title(main="IPNW Barley insurance loss by year: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Years", line=8, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)

par(mar=c(12, 6.1, 6, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

levels(YYY1$damagecause)[8] <- "Excessive Moisture"
barplot(YYY1$loss, names.arg = YYY1$damagecause, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

graphics::title(main="IPNW barley insurance loss by damage cause\n2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Years", line=8, cex.lab = 1.4)
graphics::title(ylab="Barley insurance claim loss ($)", line=4, cex.lab = 1.4)




#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 9.5)

htmlTable(YYY2,
          cgroup = c("2001-2015"),
          caption = "IPNW region BARLEY total insurance loss by damage cause, 2001-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

```



```{r message=FALSE, warning=FALSE, error=TRUE,  fig.width = 10, fig.height = 7}

library(RColorBrewer)

states <- readShapePoly('/dmine/data/states/states.shp', 
                                  proj4string=CRS
                                  ("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
        projection = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")


#--interaction plot loss vs year for all damage causes, all Palouse counties
BARLEY <- subset(palouse_sumloss_aggregate, commodity == "BARLEY")

levels(BARLEY$damagecause)[8] <- "Excessive Moisture"
BARLEY$damagecause <- factor(BARLEY$damagecause)

BARLEY_damage <- subset(BARLEY, damagecause == "Drought" | damagecause == "Heat" | damagecause == "Excessive Moisture" | damagecause == "Hail" | damagecause == "Frost" | damagecause == "Decline in Price" | damagecause == "Cold Wet Weather")

BARLEY_damage$damagecause <- factor(BARLEY_damage$damagecause)
#aggregate(WHEAT_damage$loss, list(WHEAT_damage$damagecause), FUN = "sum")

library(scales)

BARLEY_damage_top <- subset(BARLEY_damage, damagecause == "Heat" | damagecause == "Drought" | damagecause == "Excessive Moisture")
BARLEY_damage_top$damagecause <- factor(BARLEY_damage_top$damagecause, levels = c("Excessive Moisture", "Heat", "Drought"))

#2011 Excessive Moisture

BARLEY_damage_excessivemoisture2011 <- subset(BARLEY_damage, damagecause == "Excessive Moisture")
BARLEY_damage_excessivemoisture2011 <- subset(BARLEY_damage_excessivemoisture2011, year == 2011)


BARLEY_damage_top_agg_excessivemoisture2011 <- aggregate(BARLEY_damage_excessivemoisture2011$loss, by = list(BARLEY_damage_excessivemoisture2011$county), FUN = "sum")
colnames(BARLEY_damage_top_agg_excessivemoisture2011) <- c("NAME", "loss")

county_barley_excessivemoisture2011 <- merge(counties, BARLEY_damage_top_agg_excessivemoisture2011, by = "NAME")


#2015

BARLEY_damage_droughtheat2015 <- subset(BARLEY_damage, damagecause == "Heat" | damagecause == "Drought")
BARLEY_damage_droughtheat2015 <- subset(BARLEY_damage_droughtheat2015, year == 2015)


BARLEY_damage_top_agg_droughtheat2015 <- aggregate(BARLEY_damage_droughtheat2015$loss, by = list(BARLEY_damage_droughtheat2015$county), FUN = "sum")
colnames(BARLEY_damage_top_agg_droughtheat2015) <- c("NAME", "loss")

county_barley_droughtheat2015 <- merge(counties, BARLEY_damage_top_agg_droughtheat2015, by = "NAME")


#all years 2001 - 2015

BARLEY_damage_droughtheat <- subset(BARLEY_damage, damagecause == "Heat" | damagecause == "Drought")

BARLEY_damage_top_agg_droughtheat <- aggregate(BARLEY_damage_droughtheat$loss, by = list(BARLEY_damage_droughtheat$county), FUN = "sum")
colnames(BARLEY_damage_top_agg_droughtheat) <- c("NAME", "loss")

county_barley_droughtheat <- merge(counties, BARLEY_damage_top_agg_droughtheat, by = "NAME")

#ggplot(BARLEY_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
#    geom_bar( stat="identity") + theme_bw() + ggtitle("IPNW barley loss vs. year - top damage causes") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(family = "Serif", size=14, angle = 90, hjust = 1)) + theme(axis.text.y = element_text(family = "Serif", size=14, hjust = 1)) + theme(plot.title = element_text(family = "Serif", size=14, hjust = 0.5))  + scale_fill_manual("legend", values = c("Drought" = "red", "Heat" = "blue", "Excessive Moisture" = "gray")) + scale_x_discrete(limits=c(2001:2015)) + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))

#ggplot(BARLEY_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
#    geom_bar( stat="identity") + theme_bw() + ggtitle("IPNW barley loss vs. year - top damage causes") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(size=rel(1.5), angle = 90, hjust = 1, family = "Serif")) + theme(plot.title = element_text(hjust = 0.5, family = "Serif"))  +  scale_x_discrete(limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14)) + scale_fill_manual("legend", values = c("Drought" = "red", "Heat" = "blue", "Excessive Moisture" = "gray")) + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=18)) + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))

par(mar = c(5, 5, 4, 1), family = 'serif')

ggplot(BARLEY_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
    geom_bar( stat="identity") + theme_bw() + theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) + ggtitle("IPNW barley loss vs. year - top damage causes") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(size=rel(1.5), angle = 90, hjust = 1, family = "Serif")) + theme(plot.title = element_text(size =28, family = "Serif"))  +  scale_x_discrete(name = "Years", limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14)) + scale_fill_manual("legend", values = c("Drought" = "red", "Heat" = "blue", "Excessive Moisture" = "gray")) + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=24, family = "Serif", face = "bold")) + scale_y_continuous(name = "Insurance claim loss ($)", label = unit_format(unit = "M", scale = 1e-6, digits = 0)) + theme(legend.position="bottom")


barley <- palouse_sumloss_aggregate_barley
#i <- interaction.plot(x.factor     = barley$year,
#                 trace.factor = barley$damagecause, 
#                 trace.label = "barley",
#                 response     = barley$loss, 
#                 fun = sum,
#                 las = 3,
#                 type="p",
#                 col=c("black","red","green"),  ### Colors for levels of trace var.
#                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
#                 fixed=TRUE,                    ### Order by factor order in data
#                 leg.bty = "n",
#                 ylab="",
#                 xlab="Year",
#                 main="Interaction Plot - barley Loss vs. year - top damage causes", las = 2)

#EDA for barley
#-boxplots of data by cube loss by each of the three factors
par(mar=c(8,8,4,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ year, palouse_sumloss_aggregate_barley, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_barley$log10loss)
pts2 <- pretty(palouse_sumloss_aggregate_barley$log10loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

graphics::title(main="Logrithmic transform: IPNW barley insurance loss by year", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Years", line=4, cex.lab = 1.4)
graphics::title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)

stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_barley, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_barley, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_barley$log10loss)
pts2 <- pretty(palouse_sumloss_aggregate_barley$log10loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

graphics::title(main="Logrithmic transform: IPNW barley insurance loss\nby damage cause", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Damage cause", line=6, cex.lab = 1.4)
graphics::title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)

stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_barley, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

par(mar=c(10,8,4,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ county, palouse_sumloss_aggregate_barley, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_barley$log10loss)
pts2 <- pretty(palouse_sumloss_aggregate_barley$log10loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

graphics::title(main="Logrithmic transform: IPNW barley insurance loss by county", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Counties", line=6, cex.lab = 1.4)
graphics::title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)

stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_barley, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

#---2011

library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }

.legend {
    padding: 6px 10px 6px 6px;
    color: #000033;
    background: #fff;
    border-left:5px solid #666666;
    border-right:5px solid #666666;
    border-top:5px solid #666666;
    border-bottom:5px solid #666666
}



"))

title <- tags$div(
  tag.map.title, HTML("IPNW barley insurance Loss due to excessive moisture,\n2011")
)  



#-----
 pal <- colorNumeric(colorRampPalette(c("lightblue", "blue"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_barley_excessivemoisture2011$", "loss", sep=""))))

map <- leaflet(data = county_barley_excessivemoisture2011, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_barley_excessivemoisture2011$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Barley excessive<br>moisture 2011", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%

  
  

addLabelOnlyMarkers(data = county_barley_excessivemoisture2011, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())


par(mar=c(7.8, 6.1, 6, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
  barplot(BARLEY_damage_top_agg_excessivemoisture2011$loss, names.arg = BARLEY_damage_top_agg_excessivemoisture2011$NAME, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
  
pts <- pretty(BARLEY_damage_top_agg_excessivemoisture2011$loss / 1000000)
pts2 <- pretty(BARLEY_damage_top_agg_excessivemoisture2011$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))


graphics::title(main="IPNW barley insurance loss due to excessive moisture\n2011", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Years", line=6, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)


#---2015

library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("IPNW barley insurance Loss due to drought and heat,\n2015")
)  



#-----

 pal <- colorNumeric(colorRampPalette(c("yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_barley_droughtheat2015$", "loss", sep=""))))

map <- leaflet(data = county_barley_droughtheat2015, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_barley_droughtheat2015$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Barley drought<br>heat 2015", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%

  
  

addLabelOnlyMarkers(data = county_barley_droughtheat2015, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())



par(mar=c(7.8, 6.1, 6, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
  barplot(BARLEY_damage_top_agg_droughtheat2015$loss, names.arg = BARLEY_damage_top_agg_droughtheat2015$NAME, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
  
pts <- pretty(BARLEY_damage_top_agg_droughtheat2015$loss / 1000000)
pts2 <- pretty(BARLEY_damage_top_agg_droughtheat2015$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))


graphics::title(main="IPNW barley insurance loss due to drought and heat\n2015", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Years", line=6, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)



#---2001 - 2015

library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("Barley Insurance Loss due to drought and heat,\n 2001 to 2015")
)  



#-----

 pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_barley_droughtheat$", "loss", sep=""))))

map <- leaflet(data = county_barley_droughtheat, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_barley_droughtheat$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Barley drought<br>heat 2001 to 2015", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%

  
  

addLabelOnlyMarkers(data = county_barley_droughtheat, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())

#markerOptions(riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")

par(mar=c(7.8, 6.1, 6, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
  barplot(BARLEY_damage_top_agg_droughtheat$loss, names.arg = BARLEY_damage_top_agg_droughtheat$NAME, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
  
pts <- pretty(BARLEY_damage_top_agg_droughtheat$loss / 1000000)
pts2 <- pretty(BARLEY_damage_top_agg_droughtheat$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))


graphics::title(main="IPNW barley insurance loss due to drought and heat \n 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Years", line=6, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)


```

<br></br>

![](https://dmine.io/waf/img/Step1.png)

<br></br>

##Step 12: WHEAT, 2001-2015 for the IPNW

```{r message=FALSE, warning=FALSE, error=TRUE,  fig.width = 10, fig.height = 7}

library(plotly)
library(gridExtra)
library(scales)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

WHEAT <- subset(palouse_sumloss_aggregate, commodity == "WHEAT")

palouse_sumloss_1989_2015 <- aggregate(WHEAT$loss, list(WHEAT$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 2000000) 
summary_dataset2 <- X %>% filter(loss > 2000000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' billions'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for WHEAT, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

  
#p         

YYY2 <- YYY1
#levels(YYY2$damagecause)[7] <- "Excessive Moisture"

YYY2$loss <- round(YYY2$loss, digits = 0)
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)


levels(YYY1$damagecause)[levels(YYY1$damagecause)=="Other (Snow-Lightning-Etc.)"] <- "Snow/Lightning"
levels(YYY1$damagecause)[8] <- "Excessive Moisture"
YYY1$damagecause <- factor(YYY1$damagecause)

#--year
palouse_sumloss_year <- aggregate(WHEAT$loss, list(WHEAT$year), FUN = "sum")
colnames(palouse_sumloss_year) <- c("year", "loss")

#--county

palouse_sumloss_county <- aggregate(WHEAT$loss, list(WHEAT$county), FUN = "sum")
colnames(palouse_sumloss_county) <- c("county", "loss")

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(palouse_sumloss_county$loss, names.arg = palouse_sumloss_county$county, cex.names = 1.4, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(palouse_sumloss_county$loss / 1000000)
pts2 <- pretty(palouse_sumloss_county$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 8)

graphics::title(main="IPNW wheat insurance loss by commodity: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Counties", line=8, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(palouse_sumloss_year$loss, names.arg = palouse_sumloss_year$year, cex.names = 1.4, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(palouse_sumloss_year$loss / 1000000)
pts2 <- pretty(palouse_sumloss_year$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

#mtext(text = "Years",
#      side = 1,#side 1 = bottom
#      line = 8)

graphics::title(main="IPNW wheat insurance loss by year: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Years", line=8, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)

par(mar=c(13, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)

barplot(YYY1$loss, names.arg = YYY1$damagecause, las = 3, cex.names = 1.4, yaxt="n", col = "lightblue")
pts <- pretty(YYY1$loss / 1000000)
pts2 <- pretty(YYY1$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

graphics::title(main="IPNW wheat insurance loss by damage cause: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)
graphics::title(xlab="Damage Cause", line=11.5, cex.lab = 1.4)
graphics::title(ylab="Wheat insurance claim loss ($)", line=5, cex.lab = 1.4)

#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 10)

htmlTable(YYY2,
          cgroup = c("2001-2015"),
         caption = "IPNW region WHEAT total insurance loss by damage cause, 2001-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")


##Step 7: Nationwide Wheat Prices per metric ton: 2001-2015 

wheatprice <- read.csv("/dmine/data/USDAprices/wheatprices_1998_2017.csv", header=TRUE, strip.white =TRUE)
colnames(wheatprice) <- c("year", "month","price")
wheatprice_all <- subset(wheatprice, year >= 2001 & year <= 2015)

cpi <- data.frame(read.csv("/dmine/data/FRED/cpi/CPIAUCSL2001_2015.csv", header = TRUE, strip.white = TRUE))

wheatprice_all$price_adjusted <- wheatprice_all$price * cpi$ratio
colnames(wheatprice_all) <- c("year", "month","price", "price_adjusted")

par(mar=c(5.8, 7.1, 4, 2.1), family = 'serif', mgp=c(3, 1, 0), las=0)

plot(wheatprice_all$price_adjusted, las = 3, xaxt = 'n', yaxt = 'n', las = 2, cex.names = 1.4, col = "lightblue", xlab = "", ylab = "", ylim=c(100,500))
lines(wheatprice_all$price_adjusted, col = "blue")
points(wheatprice_all$price, las = 3, xaxt = 'n', cex.names = 1.4, col = "lightblue", xlab = "", ylab = "")
lines(wheatprice_all$price, col = "red")

pts <- pretty(max(wheatprice_all$price_adjusted):min(wheatprice_all$price))
pts2 <- pretty(max(wheatprice_all$price_adjusted):min(wheatprice_all$price))


i <- seq(1,nrow(wheatprice_all),12) # which labels to plot
for(ii in i)
  axis(1, at = ii, cex.axis = 1.4, labels = wheatprice_all[ii,1],  lwd = 0, las = 3)

axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

legend(1, 500, legend=c("Wheat price", "Wheat price adjusted \n for inflation"),
       col=c("red", "blue"), lty=1:1, cex=1.4)

graphics::title(main="U.S. wheat prices per metric ton ($): 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)
graphics::title(xlab="Years", line=4, cex.lab = 1.4)
graphics::title(ylab="Price per metric ton ($)", line=3.5, cex.lab = 1.4)

#--wheat production PNW 2001 - 2015

wheatproduction <- read.csv("/dmine/data/NASS/wheatproduction_WA_ID_OR_2001_2015.csv", header=TRUE, strip.white =TRUE)
colnames(wheatprice) <- c("year", "month","price")

ggplot(wheatproduction, aes(fill=State, y=Value, x=Year)) + 
    geom_bar( stat="identity") + theme_bw() + theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) + ggtitle("PNW Wheat production, 2001 to 2015 ") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(size=rel(1.9), angle = 90, hjust = 1, family = "Serif"), axis.text.y = element_text(size=rel(1.5), family = "Serif")) + theme(plot.title = element_text(size =28, family = "Serif"))  +  scale_x_discrete(name = "Years", limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14))  + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=24, family = "Serif", face = "bold")) + scale_y_continuous(name = "Wheat production ($)", label = unit_format(unit = "M", scale = 1e-6, digits = 0)) + theme(legend.position="bottom") + scale_fill_manual("legend", values = c("IDAHO" = "gray", "OREGON" = "blue", "WASHINGTON" = "red"))

#wheatprice_year <- aggregate(wheatprice_all$price, list(wheatprice$year), FUN="mean")
#colnames(wheatprice_year) <- c("year", "price")


#par(mar=c(5.8, 7.1, 4, 2.1), family = 'serif', mgp=c(3, 1, 0), las=0)
#barplot(wheatprice_year$price, names.arg = wheatprice_year$year, las = 3, yaxt = 'n', cex.names = 1.4, col = "lightblue", xlab = "", ylab = "")

#title(main="US Wheat prices per metric ton ($): 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)
#title(xlab="Years", line=4, cex.lab = 1.4)
#title(ylab="Price per metric ton ($)", line=3.5, cex.lab = 1.4)
#axis(2, las = 1, cex.axis = 1.4, at = c(0,50,100,150,200,250,300,350), labels = c(0,50,100,150,200,250,300,350))

```


```{r message=FALSE, warning=FALSE, error=TRUE,  fig.width = 10, fig.height = 7}

library(RColorBrewer)
library(scales)

simpleCap <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
      sep="", collapse=" ")
}

#--interaction plot loss vs year for all damage causes, all Palouse counties
levels(WHEAT$damagecause)[8] <- "Excessive Moisture"
WHEAT$damagecause <- factor(WHEAT$damagecause)

WHEAT_damage <- subset(WHEAT, damagecause == "Drought" | damagecause == "Heat" | damagecause == "Decline in Price" | damagecause == "Frost" | damagecause == "Hail" | damagecause == "Excessive Moisture" | damagecause == "Freeze" | damagecause == "Cold Winter" | damagecause == "Cold Wet Weather")
WHEAT_damage$damagecause <- factor(WHEAT_damage$damagecause)

#aggregate(WHEAT_damage$loss, list(WHEAT_damage$damagecause), FUN = "sum")

WHEAT_damage_top <- subset(WHEAT_damage, damagecause == "Heat" | damagecause == "Drought"  | damagecause == "Excessive Moisture")

WHEAT_damage_top_decline <- subset(WHEAT_damage, damagecause == "Heat" | damagecause == "Drought" | damagecause == "Decline in Price")


WHEAT_damage_top_decline_moisture <- subset(WHEAT_damage, damagecause == "Excessive Moisture" | damagecause == "Heat" | damagecause == "Drought" | damagecause == "Decline in Price")

WHEAT_damage_top$damagecause <- factor(WHEAT_damage_top$damagecause, levels = c("Excessive Moisture", "Heat", "Drought"))

WHEAT_damage_top_decline$damagecause <- factor(WHEAT_damage_top_decline$damagecause, levels = c("Decline in Price", "Heat", "Drought"))

WHEAT_damage_top_decline_moisture$damagecause <- factor(WHEAT_damage_top_decline_moisture$damagecause, levels = c("Excessive Moisture", "Decline in Price", "Heat", "Drought"))



WHEAT_damage_droughtheat <- subset(WHEAT_damage, damagecause == "Heat" | damagecause == "Drought")
WHEAT_damage_droughtheat2009 <- subset(WHEAT_damage, year == 2009)
WHEAT_damage_droughtheat2011 <- subset(WHEAT_damage, year == 2011)
WHEAT_damage_droughtheat2015 <- subset(WHEAT_damage, year == 2015)

WHEAT_damage_droughtheat_annual_ave <- aggregate(WHEAT_damage_droughtheat$loss, by=list(WHEAT_damage_droughtheat$county), FUN = "mean")

WHEAT_damage_droughtheat_annual_total <- aggregate(WHEAT_damage_droughtheat$loss, by=list(WHEAT_damage_droughtheat$county), FUN = "sum")


WHEAT_damage_top_agg_droughtheat <- aggregate(WHEAT_damage_droughtheat$loss, by = list(WHEAT_damage_droughtheat$county), FUN = "sum")
colnames(WHEAT_damage_top_agg_droughtheat) <- c("NAME", "loss")

county_wheat_droughtheat <- merge(counties, WHEAT_damage_top_agg_droughtheat, by = "NAME")

WHEAT_damage_top_agg_droughtheat2009 <- aggregate(WHEAT_damage_droughtheat2009$loss, by = list(WHEAT_damage_droughtheat2009$county), FUN = "sum")
colnames(WHEAT_damage_top_agg_droughtheat2009) <- c("NAME", "loss")

county_wheat_droughtheat2009 <- merge(counties, WHEAT_damage_top_agg_droughtheat2009, by = "NAME")

WHEAT_damage_top_agg_droughtheat2011 <- aggregate(WHEAT_damage_droughtheat2011$loss, by = list(WHEAT_damage_droughtheat2011$county), FUN = "sum")
colnames(WHEAT_damage_top_agg_droughtheat2011) <- c("NAME", "loss")

county_wheat_droughtheat2011 <- merge(counties, WHEAT_damage_top_agg_droughtheat2011, by = "NAME")

WHEAT_damage_top_agg_droughtheat2015 <- aggregate(WHEAT_damage_droughtheat2015$loss, by = list(WHEAT_damage_droughtheat2015$county), FUN = "sum")
colnames(WHEAT_damage_top_agg_droughtheat2015) <- c("NAME", "loss")

county_wheat_droughtheat2015 <- merge(counties, WHEAT_damage_top_agg_droughtheat2015, by = "NAME")

#yields

WA_wheat_yields <- read.csv("/dmine/data/NASS/Washington_yields_winterwheat.csv", header = TRUE)
WA_wheat_yields <- data.frame(WA_wheat_yields$Year, WA_wheat_yields$State, WA_wheat_yields$County,WA_wheat_yields$Value)
colnames(WA_wheat_yields) <- c("year", "state", "county", "value")
WA_wheat_yields$county <- tolower(WA_wheat_yields$county)
WA_wheat_yields$county <- sapply(WA_wheat_yields$county, simpleCap)
WA_wheat_yields$value <- as.numeric(gsub(",","",WA_wheat_yields$value))

ID_wheat_yields <- read.csv("/dmine/data/NASS/Idaho_yields_winterwheat.csv", header = TRUE)
ID_wheat_yields <- data.frame(ID_wheat_yields$Year, ID_wheat_yields$State, ID_wheat_yields$County,ID_wheat_yields$Value)
colnames(ID_wheat_yields) <- c("year", "state", "county", "value")
ID_wheat_yields$county <- tolower(ID_wheat_yields$county)
ID_wheat_yields$county <- sapply(ID_wheat_yields$county, simpleCap)
ID_wheat_yields$value <- as.numeric(gsub(",","",ID_wheat_yields$value))

OR_wheat_yields <- read.csv("/dmine/data/NASS/Oregon_yields_winterwheat.csv", header = TRUE)
OR_wheat_yields <- data.frame(OR_wheat_yields$Year, OR_wheat_yields$State, OR_wheat_yields$County,OR_wheat_yields$Value)
colnames(OR_wheat_yields) <- c("year", "state", "county", "value")
OR_wheat_yields$county <- tolower(OR_wheat_yields$county)
OR_wheat_yields$county <- sapply(OR_wheat_yields$county, simpleCap)
OR_wheat_yields$value <- as.numeric(gsub(",","",OR_wheat_yields$value))

iPNW_wheat_yields <- rbind(WA_wheat_yields, ID_wheat_yields, OR_wheat_yields)

iPNW_wheat_yields_annual_average <- aggregate(iPNW_wheat_yields$value, by=list(iPNW_wheat_yields$county), FUN = "sum")
colnames(iPNW_wheat_yields_annual_average) <- c("NAME", "ave_yield")


iPNW_wheat_yields_annual_average_barplot <- aggregate(iPNW_wheat_yields$value, by=list(iPNW_wheat_yields$year), FUN = "sum")
colnames(iPNW_wheat_yields_annual_average_barplot) <- c("Year", "ave_yield")

iPNW_yields_map <- merge(counties, iPNW_wheat_yields_annual_average, by=c("NAME"))

#yields end


#ggplot(WHEAT_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
#    geom_bar( stat="identity") + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 0)) + ggtitle("WHEAT Loss vs. year - top damage causes") + theme(plot.title = element_text(hjust = 0.5)) + scale_fill_manual("legend", values = c("Drought" = "red", "Heat" = "blue", "Excessive Moisture" = "gray")) + scale_x_discrete(limits=c(2001:2015)) + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))

#ggplot(WHEAT_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
#    geom_bar( stat="identity") + theme_bw() + ggtitle("IPNW wheat loss vs. year - top damage causes") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(size=rel(1.5), angle = 90, hjust = 1, family = "Serif")) + theme(plot.title = element_text(hjust = 0.5, family = "Serif"))  +  scale_x_discrete(limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14)) + scale_fill_manual("legend", values = c("Drought" = "red", "Heat" = "blue", "Excessive Moisture" = "gray")) + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=18)) + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))

par(mar = c(5, 5, 4, 1), family = 'serif')

ggplot(WHEAT_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
    geom_bar( stat="identity") + theme_bw() + theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) + ggtitle("IPNW wheat loss vs. year - top damage causes") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(size=rel(1.5), angle = 90, hjust = 1, family = "Serif")) + theme(plot.title = element_text(size =28, family = "Serif"))  +  scale_x_discrete(name = "Years", limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14)) + scale_fill_manual("legend", values = c("Drought" = "red", "Heat" = "blue", "Excessive Moisture" = "gray")) + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=24, family = "Serif", face = "bold")) + scale_y_continuous(name = "Insurance claim loss ($)", label = unit_format(unit = "M", scale = 1e-6, digits = 0)) + theme(legend.position="bottom")

#--decline in price replacing excess moisture

par(mar = c(5, 5, 4, 1), family = 'serif')

ggplot(WHEAT_damage_top_decline, aes(fill=damagecause, y=loss, x=year)) + 
    geom_bar( stat="identity") + theme_bw() + theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) + ggtitle("IPNW wheat loss vs. year - top damage causes + Decline in Price") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(size=rel(1.5), angle = 90, hjust = 1, family = "Serif")) + theme(plot.title = element_text(size =28, family = "Serif"))  +  scale_x_discrete(name = "Years", limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14)) + scale_fill_manual("legend", values = c("Drought" = "red", "Heat" = "blue", "Decline in Price" = "gray")) + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=24, family = "Serif", face = "bold")) + scale_y_continuous(name = "Insurance claim loss ($)", label = unit_format(unit = "M", scale = 1e-6, digits = 0)) + theme(legend.position="bottom")

#--decline in price as well as excess moisture, heat, and drought



WHEAT_damage_top_decline_moisture <- subset(WHEAT_damage_top_decline_moisture, year >= 2001)
par(mar = c(5, 5, 4, 1), family = 'serif')

ggplot(WHEAT_damage_top_decline_moisture) + 
    geom_bar( aes(fill=damagecause, y=loss, x=year), stat="identity") + theme_bw() + theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) + ggtitle("IPNW wheat loss top damage causes \nvs. wheat production") + theme(axis.title.y = element_text(family = "Serif", size=24), axis.title.x = element_text(family = "Serif", size = 24), axis.text.x = element_text(size=rel(2.5), angle = 90, hjust = 1, family = "Serif"), axis.text.y = element_text(size=rel(2.5), hjust = 1, family = "Serif")) + theme(plot.title = element_text(size =28, family = "Serif"))  +  scale_x_discrete(name = "Years", limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14)) + scale_fill_manual("legend", values = c("Drought" = "red", "Heat" = "darkred", "Excessive Moisture" = "blue", "Decline in Price" = "gray")) + theme(legend.title=element_text(family = "Serif", size=24, face = "bold")) + theme(plot.title = element_text(size=24, family = "Serif", face = "bold")) + scale_y_continuous(name = "Insurance claim loss ($)", label = unit_format(unit = "M", scale = 1e-6, digits = 0)) + theme(legend.position="bottom") 

#+ geom_line(data=iPNW_wheat_yields_annual_average_barplot, aes(x=Year, y=ave_yield), colour = "blue")




wheat <- palouse_sumloss_aggregate_wheat
#i <- interaction.plot(x.factor     = wheat$year,
#                 trace.factor = wheat$damagecause, 
#                 trace.label = "wheat",
#                 response     = wheat$loss, 
#                 fun = sum,
#                 las = 3,
#                 type="b",
#                 col=c("black","red","green"),  ### Colors for levels of trace var.
#                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
#                 fixed=TRUE,                    ### Order by factor order in data
#                 leg.bty = "n",
#                 ylab="",
#                 xlab="Year",
#                 main="Interaction Plot - WHEAT Loss vs. year - top damage causes", las = 2)

#EDA for wheat

palouse_sumloss_aggregate_wheat2 <- subset(palouse_sumloss_aggregate, commodity == "WHEAT")
palouse_sumloss_aggregate_wheat2 <- subset(palouse_sumloss_aggregate_wheat2, damagecause != "Hurricane/Tropical Depression")
palouse_sumloss_aggregate_wheat2 <- subset(palouse_sumloss_aggregate_wheat2, damagecause != "Inability to Prepare Land for Irr")

levels(palouse_sumloss_aggregate_wheat2$damagecause)[8] <- "Excessive Moisture"
levels(palouse_sumloss_aggregate_wheat2$damagecause)[24] <- "Snow/Lighning"

palouse_sumloss_aggregate_wheat2$damagecause <- factor(palouse_sumloss_aggregate_wheat2$damagecause)

#-boxplots of data by cube loss by each of the three factors
par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_wheat2, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_wheat2$log10_loss)
pts2 <- pretty(palouse_sumloss_aggregate_wheat2$log10_loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

graphics::title(main="Logrithmic transform: IPNW wheat insurance loss\nby year", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Years", line=5, cex.lab = 1.4)
graphics::title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)

stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_wheat2, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

par(mar=c(14,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_wheat2, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_wheat2$log10_loss)
pts2 <- pretty(palouse_sumloss_aggregate_wheat2$log10_loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

graphics::title(main="Logrithmic transform: IPNW wheat insurance loss\nby damage cause", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Damage cause", line=12, cex.lab = 1.4)
graphics::title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)

stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_wheat2, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ county, palouse_sumloss_aggregate_wheat2, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_wheat2$log10_loss)
pts2 <- pretty(palouse_sumloss_aggregate_wheat2$log10_loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

graphics::title(main="Logrithmic transform: IPNW wheat insurance loss\nby county", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Counties", line=7, cex.lab = 1.4)
graphics::title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)

stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_wheat2, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

#---

library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("IPNW wheat insurance loss due to drought and heat,\n 2001 to 2015")
) 


#--all years

 #pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
 #                      domain = eval(parse(text=paste("county_wheat_droughtheat$", "loss", sep=""))))
 
 pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_wheat_droughtheat$", "loss", sep=""))))

map <- leaflet(data = county_wheat_droughtheat, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 100, height = 100,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_wheat_droughtheat$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    
addLegend(pal = pal, data = county_wheat_droughtheat, values = na.omit(~loss), group = "circles", title = paste("Wheat loss: 2001 to 2015<br>due to drought/heat", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>% 
  

addLabelOnlyMarkers(data = county_wheat_droughtheat, lng = lat_long[,1], lat = lat_long[,2], label = lapply(paste(round((county_wheat_droughtheat$loss / 1000000), 0), "M", sep=""), HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "24px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())



#markerOptions(riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

barplot(WHEAT_damage_top_agg_droughtheat$loss, names.arg = WHEAT_damage_top_agg_droughtheat$NAME, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
  

pts <- pretty(WHEAT_damage_top_agg_droughtheat$loss/1000000)
pts2 <- pretty(WHEAT_damage_top_agg_droughtheat$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

graphics::title(main="2001 to 2015 IPNW wheat insurance loss \ndue to drought and heat by county", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Counties", line=7, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=5, cex.lab = 1.4)






  
  #---

library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("IPNW wheat insurance loss due to drought and heat\n 2011")
)  

#-2011

#set color range the same as 2015 for comparison

#pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
     #                 domain = eval(parse(text=paste("county_wheat_droughtheat2011$", "loss", sep=""))))


 pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_wheat_droughtheat2011$", "loss", sep=""))))

map <- leaflet(data = county_wheat_droughtheat2011, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
 # addMiniMap(
#    tiles = providers$Stamen.TonerLite,
#    position = 'topleft', 
#    width = 100, height = 100,
#    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_wheat_droughtheat2011$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, data = county_wheat_droughtheat2011, values = na.omit(~loss), group = "circles", title = paste("Wheat loss: 2011<br>due to drought/heat", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_wheat_droughtheat2011, lng = lat_long[,1], lat = lat_long[,2], label = lapply(paste(round((county_wheat_droughtheat2011$loss / 1000000), 2), "M", sep=""), HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())
  

#markerOptions(riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

barplot(WHEAT_damage_top_agg_droughtheat2011$loss, names.arg = WHEAT_damage_top_agg_droughtheat2011$NAME, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
  
    pts <- pretty(WHEAT_damage_top_agg_droughtheat2011$loss / 1000000)
pts2 <- pretty(WHEAT_damage_top_agg_droughtheat2011$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

graphics::title(main="2011 IPNW wheat insurance loss due to drought and heat\nby county", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Counties", line=7, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=5, cex.lab = 1.4)
  
  #---

library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("IPNW wheat insurance loss due to drought and heat\n 2009")
) 
  

#-2009

 pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_wheat_droughtheat2009$", "loss", sep=""))))

map <- leaflet(data = county_wheat_droughtheat2009, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_wheat_droughtheat2009$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Wheat loss: 2009<br>due to drought/heat", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_wheat_droughtheat2009, lng = lat_long[,1], lat = lat_long[,2], label = lapply(paste(round((county_wheat_droughtheat2009$loss / 1000000), 0), "M", sep=""), HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())


#markerOptions(riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

barplot(WHEAT_damage_top_agg_droughtheat2009$loss, names.arg = WHEAT_damage_top_agg_droughtheat2009$NAME, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
  
    pts <- pretty(WHEAT_damage_top_agg_droughtheat2009$loss / 1000000)
pts2 <- pretty(WHEAT_damage_top_agg_droughtheat2009$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))
 

graphics::title(main="2009 IPNW wheat insurance loss due to drought and heat\nby county", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Counties", line=7, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=5, cex.lab = 1.4)
  

  #---

library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("IPNW wheat insurance loss due to drought and heat\n 2015")
) 

#-2015
 

pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_wheat_droughtheat2015$", "loss", sep=""))))

map <- leaflet(data = county_wheat_droughtheat2015, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
 # addMiniMap(
#    tiles = providers$Stamen.TonerLite,
#    position = 'topleft', 
#    width = 100, height = 100,
#    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_wheat_droughtheat2015$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Wheat loss: 2015<br>due to drought/heat", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_wheat_droughtheat2015, lng = lat_long[,1], lat = lat_long[,2], label = lapply(paste(round((county_wheat_droughtheat2015$loss / 1000000), 0), "M", sep=""), HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())


#markerOptions(riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

barplot(WHEAT_damage_top_agg_droughtheat2015$loss, names.arg = WHEAT_damage_top_agg_droughtheat2015$NAME, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

  pts <- pretty(WHEAT_damage_top_agg_droughtheat2015$loss / 1000000)
pts2 <- pretty(WHEAT_damage_top_agg_droughtheat2015$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))


graphics::title(main="2015 IPNW wheat insurance loss due to drought and heat\nby county", line = 2, cex.main = 1.9, adj = 0)
graphics::title(xlab="Counties", line=7, cex.lab = 1.4)
graphics::title(ylab="Insurance claim loss ($)", line=5, cex.lab = 1.4)

#interaction plots for wheat

library(plotly)
library(gridExtra)
library(knitr)
library(kableExtra)
library(htmlTable)
library(plotrix)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

#--counts wheat drought

palouse_sumloss_aggregate_wheat <- subset(palouse_counts, commodity == "WHEAT")

palouse_sumloss_1989_2015_count <- aggregate(palouse_sumloss_aggregate_wheat$count, list( palouse_sumloss_aggregate_wheat$month, palouse_sumloss_aggregate_wheat$year, palouse_sumloss_aggregate_wheat$damagecause, palouse_sumloss_aggregate_wheat$county, palouse_sumloss_aggregate_wheat$state), FUN = "sum")

palouse_sumloss_1989_2015_count_year <- aggregate(palouse_sumloss_aggregate_wheat$count, list(palouse_sumloss_aggregate_wheat$year, palouse_sumloss_aggregate_wheat$damagecause, palouse_sumloss_aggregate_wheat$county, palouse_sumloss_aggregate_wheat$state), FUN = "sum")

palouse_sumloss_1989_2015_count_year_nocounty <- aggregate(palouse_sumloss_aggregate_wheat$count, list(palouse_sumloss_aggregate_wheat$year, palouse_sumloss_aggregate_wheat$damagecause, palouse_sumloss_aggregate_wheat$state), FUN = "sum")

colnames(palouse_sumloss_1989_2015_count) <- c("month", "year", "damagecause", "county", "state", "count")
colnames(palouse_sumloss_1989_2015_count_year) <- c("year", "damagecause", "county", "state", "count")
colnames(palouse_sumloss_1989_2015_count_year_nocounty) <- c("year", "damagecause", "state", "count")

#--loss

palouse_sumloss_aggregate_wheat_loss <- subset(palouse_sumloss, commodity == "WHEAT")

palouse_sumloss_1989_2015_loss <- aggregate(palouse_sumloss_aggregate_wheat_loss$loss, list( palouse_sumloss_aggregate_wheat_loss$month, palouse_sumloss_aggregate_wheat_loss$year, palouse_sumloss_aggregate_wheat_loss$damagecause, palouse_sumloss_aggregate_wheat_loss$county, palouse_sumloss_aggregate_wheat_loss$state), FUN = "sum")

palouse_sumloss_1989_2015_loss_year <- aggregate(palouse_sumloss_aggregate_wheat_loss$loss, list(palouse_sumloss_aggregate_wheat_loss$year, palouse_sumloss_aggregate_wheat_loss$damagecause, palouse_sumloss_aggregate_wheat_loss$county, palouse_sumloss_aggregate_wheat_loss$state), FUN = "sum")

colnames(palouse_sumloss_1989_2015_loss) <- c("month", "year", "damagecause", "county", "state", "loss")
colnames(palouse_sumloss_1989_2015_loss_year) <- c("year", "damagecause", "county", "state", "loss")






#palouse_sumloss_1989_2015_count_county <- aggregate(palouse_sumloss_aggregate_wheat$loss, list( palouse_sumloss_aggregate_wheat$damagecause, palouse_sumloss_aggregate_wheat$year, palouse_sumloss_aggregate_wheat$county ), FUN = "length")

#colnames(palouse_sumloss_1989_2015_count) <- c("damagecause", "year", "loss")

#colnames(palouse_sumloss_1989_2015_count_county) <- c("damagecause", "year", "county", "loss")


#-boxplots of count data for all commodities and all damage causes- 1989-2015

#palouse_sumloss_1989_2015_count_commodity <- subset(palouse_sumloss_1989_2015_count, loss > 20)
#palouse_sumloss_1989_2015_count_commodity <- subset(palouse_sumloss_1989_2015_count_commodity, commodity != "ADJUSTED GROSS REVENUE")
#palouse_sumloss_1989_2015_count$damagecause <- factor(palouse_sumloss_1989_2015_count$damagecause)

#palouse_sumloss_1989_2015_count_commodity$commodity <- factor(palouse_sumloss_1989_2015_count_commodity$commodity)


#par(mar=c(8.8, 6.1, 2.1, 2.1), mgp=c(3, 1, 0), las=0)



psc_drought <- subset(palouse_sumloss_1989_2015_count_year, damagecause == "Drought")

#--create missing county year data where no values are found
d1 <- data.frame(unique(palouse_counts$county))
colnames(d1) <- "county"

d2 <- data.frame(unique(palouse_counts$year))
colnames(d2) <- "year"
d2 <- d2[order(d2$year),]
d2 <- data.frame(d2)
colnames(d2) <- "year"

d2a <- c("WA", "WA", "WA", "WA", "WA", "WA", "OR", "OR", "WA", "ID", "ID", "ID", "ID", "ID", "ID", "WA", "OR", "OR", "OR", "OR", "OR", "OR", "WA", "WA", "ID", "WA")

d2a <- data.frame(d2a)
colnames(d2a) <- "state"

d1 <- data.frame(d1[rep(seq_len(nrow(d1)), each=27),])
d2 <- do.call("rbind", replicate(26, d2, simplify = FALSE))
d2a <- data.frame(d2a[rep(seq_len(nrow(d2a)), each=27),])

d3 <- cbind(d1, d2a, d2)
colnames(d3) <- c("county", "state", "year")

psc_drought2 <- merge(d3, psc_drought, by = c("year", "county"), all = TRUE)
psc_drought2$count[is.na(psc_drought2$count)] <- 0

psc_drought2 <- subset(psc_drought2, year >= 2001)

psc_drought2$countystate <- paste(psc_drought2$county, psc_drought2$state.x, sep=", ")

#figure out which counties have all zeros and eliminate
psc_drought2a <- aggregate(psc_drought2$count, by = list(psc_drought2$countystate), FUN = "sum")


par(mar=c(7,6,4,2)+0.1, family = 'serif', mgp=c(5,1,0))
interaction.plot(x.factor     = psc_drought2$year,
                 trace.factor = psc_drought2$countystate, 
                 response     = psc_drought2$count, 
                 fun = sum,
                 las = 2,
                 type="l",
                 col=c("black","red1","green1", "blue1", "yellow1", "red2","green2", "blue2", "yellow2","red3","green3", "blue3", "yellow3","red4","green4", "blue4", "yellow4"),  ### Colors for levels of trace var.
                 #pch=c(19, 17, 15),             ### Symbols for levels of trace var.
                 fixed=FALSE,                    ### Order by factor order in data
                 leg.bty = "n",
                 #yaxt = 'n',
                 #xaxt = 'n',
                 ylab="",
                 legend = FALSE,
                 xlab='')
                 #main="Annual Wheat Insurance Claim Frequency \n by county for the IPNW Study Area, 2001-2015: DROUGHT", las = 2)

graphics::title(main="Annual IPNW Wheat Insurance Claim Frequency by county\n2001-2015: Drought", adj = 0, cex.main = 1.9)
graphics::title(xlab="Years", line=4, cex.lab = 1.4)
graphics::title(ylab="Wheat Claim Frequency: Drought", line=3.5, cex.lab = 1.4)
pts <- pretty(psc_drought$count)
pts2 <- c(unique(psc_drought$year))
pts2 <- as.numeric(pts2)

#axis(2, las = 1, cex.axis = 1.4, at = pts, labels = paste(pts, sep = ""))
#axis(1, las = 2, cex.axis = 1.9, at = pts2, labels = pts2)

#psc_drought <- subset(palouse_sumloss_1989_2015_count_year, damagecause == "Drought")

psc_drought_all <- aggregate(palouse_sumloss_1989_2015_count_year$count, by = list(palouse_sumloss_1989_2015_count_year$state, palouse_sumloss_1989_2015_count_year$county, palouse_sumloss_1989_2015_count_year$year), FUN = "sum")

colnames(psc_drought_all) <- c("state", "county", "year", "count")

#--create missing county year data where no values are found
d1 <- data.frame(unique(palouse_counts$county))
colnames(d1) <- "county"

d2 <- data.frame(unique(palouse_counts$year))
colnames(d2) <- "year"
d2 <- d2[order(d2$year),]
d2 <- data.frame(d2)
colnames(d2) <- "year"


d2a <- c("WA", "WA", "WA", "WA", "WA", "WA", "OR", "OR", "WA", "ID", "ID", "ID", "ID", "ID", "ID", "WA", "OR", "OR", "OR", "OR", "OR", "OR", "WA", "WA", "ID", "WA")

d2a <- data.frame(d2a)
colnames(d2a) <- "state"

d1 <- data.frame(d1[rep(seq_len(nrow(d1)), each=27),])
d2 <- do.call("rbind", replicate(26, d2, simplify = FALSE))
d2a <- data.frame(d2a[rep(seq_len(nrow(d2a)), each=27),])



d3 <- cbind(d1, d2a, d2)
colnames(d3) <- c("county", "state", "year")

psc_drought3 <- merge(d3, psc_drought_all, by = c("year", "county"), all = TRUE)
psc_drought3$count[is.na(psc_drought3$count)] <- 0

psc_drought3 <- subset(psc_drought3, year >= 2001)

psc_drought3$countystate <- paste(psc_drought3$county, psc_drought3$state.x, sep=", ")


par(mar=c(7,6,4,2)+0.1, family = 'serif', mgp=c(5,1,0))


interaction.plot(x.factor     = psc_drought3$year,
                 trace.factor = psc_drought3$countystate, 
                 response     = psc_drought3$count, 
                 fun = sum,
                 las = 2,
                 type="l",
                 col=c("black","red1","green1", "blue1", "yellow1", "red2","green2", "blue2", "yellow2","red3","green3", "blue3", "yellow3","red4","green4", "blue4", "yellow4"),  ### Colors for levels of trace var.
                 #pch=c(19, 17, 15),             ### Symbols for levels of trace var.
                 fixed=FALSE,                    ### Order by factor order in data
                 leg.bty = "n",
                 ylab="",
                 legend = FALSE,
                 xlab="")
                 #main="Annual Wheat Insurance Claim Frequency \n by county for the IPNW Study Area, 2001-2015: ALL DAMAGE CAUSES", las = 2)

graphics::title(main="Annual IPNW Wheat Insurance Claim Frequency by county\n2001-2015: All Damage Causes", adj = 0, cex.main = 1.9)
graphics::title(xlab="Years", line=4, cex.lab = 1.4)
graphics::title(ylab="Wheat Claim Frequency: All Damage Causes", line=3.5, cex.lab = 1.4)



#boxplot(palouse_sumloss_1989_2015_loss_year$loss ~ palouse_sumloss_1989_2015_loss_year$year, ylab = "Insurance Claim Frequency", xlab = "", names.arg = palouse_sumloss_1989_2015_loss_year$year, las = 3, main = "IPNW Wheat Insurance Loss Frequencies/Year 1989-2015")

#title(xlab="Year", line=7)


#boxplot(palouse_sumloss_1989_2015_count_year_nocounty$count ~ palouse_sumloss_1989_2015_count_year_nocounty$year, ylab = "Insurance Claim Frequency", xlab = "", names.arg = palouse_sumloss_1989_2015_count_year_nocounty$year, las = 3, main = "IPNW Wheat Insurance Loss Frequencies/Year 1989-2015")

#title(xlab="Damage Cause", line=7)


#plot(palouse_sumloss_1989_2015_count$loss ~ palouse_sumloss_1989_2015_count$damagecause, ylab = "Insurance Claim Frequency", xlab = "", names.arg = palouse_sumloss_1989_2015_count$damagecause, las = 3, main = "IPNW Wheat Insurance Loss Frequencies/Year 1989-2015")

#title(xlab="Damage Cause", line=7)


#psc_drought <- subset(palouse_sumloss_1989_2015_count_county, damagecause == "Drought")


#barplot(psc_drought$loss, ylab = "Insurance Claim Frequency", xlab = "", names.arg = psc_drought$year, las = 3, main = "IPNW Wheat Insurance Loss Frequencies/Year 1989-2015")

#title(xlab="Damage Cause", line=7)

#model_count <- glm(formula = log(loss) ~ damagecause + commodity, family = "poisson", data = palouse_sumloss_1989_2015_count)

library(Hmisc)

simpleCap <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
      sep="", collapse=" ")
}

WA_wheat_yields <- read.csv("/dmine/data/NASS/Washington_yields_winterwheat.csv", header = TRUE)
WA_wheat_yields <- data.frame(WA_wheat_yields$Year, WA_wheat_yields$State, WA_wheat_yields$County,WA_wheat_yields$Value)
colnames(WA_wheat_yields) <- c("year", "state", "county", "value")
WA_wheat_yields$county <- tolower(WA_wheat_yields$county)
WA_wheat_yields$county <- sapply(WA_wheat_yields$county, simpleCap)
WA_wheat_yields$value <- as.numeric(gsub(",","",WA_wheat_yields$value))

ID_wheat_yields <- read.csv("/dmine/data/NASS/Idaho_yields_winterwheat.csv", header = TRUE)
ID_wheat_yields <- data.frame(ID_wheat_yields$Year, ID_wheat_yields$State, ID_wheat_yields$County,ID_wheat_yields$Value)
colnames(ID_wheat_yields) <- c("year", "state", "county", "value")
ID_wheat_yields$county <- tolower(ID_wheat_yields$county)
ID_wheat_yields$county <- sapply(ID_wheat_yields$county, simpleCap)
ID_wheat_yields$value <- as.numeric(gsub(",","",ID_wheat_yields$value))

OR_wheat_yields <- read.csv("/dmine/data/NASS/Oregon_yields_winterwheat.csv", header = TRUE)
OR_wheat_yields <- data.frame(OR_wheat_yields$Year, OR_wheat_yields$State, OR_wheat_yields$County,OR_wheat_yields$Value)
colnames(OR_wheat_yields) <- c("year", "state", "county", "value")
OR_wheat_yields$county <- tolower(OR_wheat_yields$county)
OR_wheat_yields$county <- sapply(OR_wheat_yields$county, simpleCap)
OR_wheat_yields$value <- as.numeric(gsub(",","",OR_wheat_yields$value))

iPNW_wheat_yields <- rbind(WA_wheat_yields, ID_wheat_yields, OR_wheat_yields)

iPNW_wheat_yields_annual_average <- aggregate(iPNW_wheat_yields$value, by=list(iPNW_wheat_yields$county), FUN = "sum")
colnames(iPNW_wheat_yields_annual_average) <- c("NAME", "ave_yield")


iPNW_wheat_yields_annual_average_barplot <- aggregate(iPNW_wheat_yields$value, by=list(iPNW_wheat_yields$year), FUN = "sum")
colnames(iPNW_wheat_yields_annual_average_barplot) <- c("Year", "ave_yield")

iPNW_yields_map <- merge(counties, iPNW_wheat_yields_annual_average, by=c("NAME"))

#--map of average annual yields for wheat, 2001-2015



pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("iPNW_yields_map$", "ave_yield", sep=""))))

map <- leaflet(data = iPNW_yields_map, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 175, height = 175,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(iPNW_yields_map$ave_yield),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~ave_yield), group = "circles", title = paste("Total wheat yields <br>2001-2015", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = iPNW_yields_map, lng = lat_long[,1], lat = lat_long[,2], label = lapply(paste(round((iPNW_yields_map$ave_yield / 1000000), 0), "M", sep=""), HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())


#average loss per county for wheat - drought and heat

colnames(WHEAT_damage_droughtheat_annual_ave) <- c("NAME", "loss")
colnames(WHEAT_damage_droughtheat_annual_total) <- c("NAME", "loss")

WHEAT_damage_droughtheat_annual_ave_map <- merge(counties, WHEAT_damage_droughtheat_annual_ave, by=c("NAME"))
WHEAT_damage_droughtheat_annual_total_map <- merge(counties, WHEAT_damage_droughtheat_annual_total, by=c("NAME"))


pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("WHEAT_damage_droughtheat_annual_ave_map$", "loss", sep=""))))

map <- leaflet(data = WHEAT_damage_droughtheat_annual_ave_map, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(WHEAT_damage_droughtheat_annual_ave_map$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Average Annual Wheat loss <br>due to drought/heat, 2001-2015", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = WHEAT_damage_droughtheat_annual_ave_map, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())

#totals

pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("iPNW_yields_map$", "ave_yield", sep=""))))

  pts <- pretty(WHEAT_damage_droughtheat_annual_total_map$loss / 1000000)
pts2 <- pretty(WHEAT_damage_droughtheat_annual_total_map$loss)

map <- leaflet(data = WHEAT_damage_droughtheat_annual_total_map, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 100, height = 100,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(WHEAT_damage_droughtheat_annual_total_map$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 


    addLegend(data = iPNW_yields_map, pal = pal, values = na.omit(~ave_yield), group = "circles", title = paste("Total wheat loss <br>due to drought/heat 2001-2015", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = WHEAT_damage_droughtheat_annual_total_map, lng = lat_long[,1], lat = lat_long[,2], label = lapply(paste(round((WHEAT_damage_droughtheat_annual_total_map$loss / 1000000), 0), "M", sep = ""), HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())


#twoord plot yields vs loss

par(mar=c(11.8, 4, 4, 4), family = 'serif', mgp=c(4, 1, 0), las=0)

wheat_aggregated_drought_heat <- aggregate(WHEAT_damage_droughtheat$loss, by=list(WHEAT_damage_droughtheat$year), FUN = "sum")
colnames(wheat_aggregated_drought_heat) <- c("Year", "loss")

#yrangemin <- min(eval(parse(text=paste("iPNW_loss_climate_tmmx$", unit, sep="")))) - (.05 * min(eval(parse(text=paste("iPNW_loss_climate_tmmx$", unit, sep="")))))
#yrangemax <- max(eval(parse(text=paste("iPNW_loss_climate_tmmx$", unit, sep="")))) + (.05 * max(eval(parse(text=paste("iPNW_loss_climate_tmmx$", unit, sep="")))))

y2rangemin <- min(iPNW_wheat_yields_annual_average_barplot$ave_yield) - (.05 * min(iPNW_wheat_yields_annual_average_barplot$ave_yield))
y2rangemax <- max(iPNW_wheat_yields_annual_average_barplot$ave_yield) + (.05 * max(iPNW_wheat_yields_annual_average_barplot$ave_yield))

wheat_aggregated_drought_heat <- subset(wheat_aggregated_drought_heat, Year >= 2001)


#par(mar = c(5, 5, 4, 1), family = 'serif')


#twoord.plot(c(1:nrow(iPNW_wheat_yields_annual_average_barplot)), wheat_aggregated_drought_heat$loss, c(1:nrow(iPNW_wheat_yields_annual_average_barplot)), rylim=c(0, 250000000), lylim=c(0, 250000000), iPNW_wheat_yields_annual_average_barplot$ave_yield, mar=c(8,4,4,4), xaxt = "n", yaxt = "n", ylab = "", yticklab = "", xticklab="", rylab = "", type=c("bar", "b"), lcol = "red", rcol = "blue")

#text(1:nrow(iPNW_wheat_yields_annual_average_barplot), -5000000, srt = 90, adj = 1,
 #    labels = iPNW_wheat_yields_annual_average_barplot$Year, xpd = TRUE, cex = 1.5)
#mtext(1, text = "Year", line = 8, cex = 1.5)
#mtext(2, text = "Wheat loss due to drought and heat", line = 3, cex = 1.5)
#mtext(4, text = "Wheat production ($)", line = 1, cex = 1.5)
#graphics::title(main = paste("iPNW Comparison of wheat production ($) \nvs. wheat insurance loss ($) due to drought and heat", sep=""), cex.main = 2, adj = 0)

pts <- pretty(wheat_aggregated_drought_heat$loss / 1000000)
pts2 <- pretty(wheat_aggregated_drought_heat$loss)


#axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""), col = "red")

```


<br></br>

![](https://dmine.io/waf/img/Step1.png)

<br></br>

##Step 13: CHERRIES, 2001-2015 for the IPNW

```{r message=FALSE, warning=FALSE, error=TRUE,  fig.width = 10, fig.height = 7}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

CHERRIES <- subset(palouse_sumloss_aggregate, commodity == "CHERRIES")
palouse_sumloss_1989_2015 <- aggregate(CHERRIES$loss, list(CHERRIES$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 1000000) 
summary_dataset2 <- X %>% filter(loss > 1000000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]


p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' billions'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for CHERRIES, Palouse Region: 1989-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))




#p

YYY2 <- YYY1
levels(YYY2$damagecause)[8] <- "Excessive Moisture"

YYY2$loss <- round(YYY2$loss, digits = 0)
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)


#--year
palouse_sumloss_year <- aggregate(CHERRIES$loss, list(CHERRIES$year), FUN = "sum")
colnames(palouse_sumloss_year) <- c("year", "loss")

#--county

palouse_sumloss_county <- aggregate(CHERRIES$loss, list(CHERRIES$county), FUN = "sum")
colnames(palouse_sumloss_county) <- c("county", "loss")

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(palouse_sumloss_county$loss, names.arg = palouse_sumloss_county$county, cex.names = 1.4, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(palouse_sumloss_county$loss / 1000000)
pts2 <- pretty(palouse_sumloss_county$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 8)

title(main="IPNW cherries insurance loss by commodity: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Counties", line=8, cex.lab = 1.4)
title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(palouse_sumloss_year$loss, names.arg = palouse_sumloss_year$year, cex.names = 1.4, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(palouse_sumloss_year$loss / 1000000)
pts2 <- pretty(palouse_sumloss_year$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

#mtext(text = "Years",
#      side = 1,#side 1 = bottom
#      line = 8)

title(main="IPNW cherries insurance loss by year: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Years", line=8, cex.lab = 1.4)
title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)



par(mar=c(12.8, 6.1, 4, 2.1), family = "serif", mgp=c(4, 1, 0), las=0)
levels(YYY1$damagecause)[8] <- "Excessive Moisture"
levels(YYY1$damagecause)[24] <- "Snow/Lightning"


barplot(YYY1$loss, names.arg = YYY1$damagecause, las = 3, cex.names = 1.4, yaxt="n", col = "lightblue")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))


title(main="IPNW cherries insurance loss by damage cause: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)
title(xlab="Damage Cause", line=11.5, cex.lab = 1.4)
title(ylab="Cherries insurance claim loss ($)", line=5, cex.lab = 1.4)


#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 10)

htmlTable(YYY2,
          cgroup = c("2001-2015"),
          caption = "IPNW region CHERRIES total insurance loss by damage cause, 2001-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")

```



```{r message=FALSE, warning=FALSE, error=TRUE,  fig.width = 10, fig.height = 7}

library(RColorBrewer)


CHERRIES <- subset(palouse_sumloss_aggregate, commodity == "CHERRIES")

levels(CHERRIES$damagecause)[8] <- "Excessive Moisture"
CHERRIES$damagecause <- factor(CHERRIES$damagecause)



CHERRIES_damage <- subset(CHERRIES, damagecause =="Excessive Moisture" | damagecause == "Freeze" | damagecause == "Frost" | damagecause == "Cold Wet Weather" | damagecause == "Hail" | damagecause == "Decline in Price" | damagecause == "Heat" | damagecause == "Wind/Excess Wind")

CHERRIES_damage$damagecause <- factor(CHERRIES_damage$damagecause) 


CHERRIES_damage_top <- subset(CHERRIES_damage, damagecause == "Excessive Moisture" | damagecause == "Freeze"  | damagecause == "Frost")

CHERRIES_damage_top$damagecause <- factor(CHERRIES_damage_top$damagecause, levels = c("Freeze", "Frost", "Excessive Moisture"))



CHERRIES_moisturefrostfreeze <- subset(CHERRIES_damage, damagecause == "Excessive Moisture" | damagecause == "Frost" | damagecause == "Freeze")
CHERRIES_moisturefrostfreeze2013 <- subset(CHERRIES_moisturefrostfreeze, year == 2013)
CHERRIES_moisturefrostfreeze2015 <- subset(CHERRIES_moisturefrostfreeze, year == 2015)





CHERRIES_damage_top_agg_moisturefrostfreeze <- aggregate(CHERRIES_moisturefrostfreeze$loss, by = list(CHERRIES_moisturefrostfreeze$county), FUN = "sum")

colnames(CHERRIES_damage_top_agg_moisturefrostfreeze) <- c("NAME", "loss")


CHERRIES_damage_top_agg_moisturefrostfreeze2013 <- aggregate(CHERRIES_moisturefrostfreeze2013$loss, by = list(CHERRIES_moisturefrostfreeze2013$county), FUN = "sum")

colnames(CHERRIES_damage_top_agg_moisturefrostfreeze2013) <- c("NAME", "loss")

CHERRIES_damage_top_agg_moisturefrostfreeze2015 <- aggregate(CHERRIES_moisturefrostfreeze2015$loss, by = list(CHERRIES_moisturefrostfreeze2015$county), FUN = "sum")

colnames(CHERRIES_damage_top_agg_moisturefrostfreeze2015) <- c("NAME", "loss")

#CHERRIES_damage_top_agg_moisturefrostfreeze[is.na(CHERRIES_damage_top_agg_moisturefrostfreeze)] <- 0


county_cherries_moisturefrostfreeze <- merge(counties, CHERRIES_damage_top_agg_moisturefrostfreeze, by = "NAME")

county_cherries_moisturefrostfreeze2013 <- merge(counties, CHERRIES_damage_top_agg_moisturefrostfreeze2013, by = "NAME")
county_cherries_moisturefrostfreeze2015 <- merge(counties, CHERRIES_damage_top_agg_moisturefrostfreeze2015, by = "NAME")


#ggplot(CHERRIES_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
#    geom_bar( stat="identity") + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + ggtitle("CHERRIES Loss vs. year - top damage causes") + theme(plot.title = element_text(hjust = 0.5))  +  scale_x_discrete(limits=c(2001:2015))  + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))

#ggplot(CHERRIES_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
#    geom_bar( stat="identity") + theme_bw() + ggtitle("IPNW cherries loss vs. year - top damage causes") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(size=rel(1.5), angle = 90, hjust = 1, family = "Serif")) + theme(plot.title = element_text(hjust = 0.5, family = "Serif"))  +  scale_x_discrete(limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14)) + scale_fill_manual("legend", values = c("Excessive Moisture" = "red", "Frost" = "blue", "Freeze" = "gray")) + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=18)) + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))

par(mar = c(5, 5, 4, 1), family = 'serif')

ggplot(CHERRIES_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
    geom_bar( stat="identity") + theme_bw() + theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) + ggtitle("IPNW cherries loss vs. year - top damage causes") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(size=rel(1.5), angle = 90, hjust = 1, family = "Serif")) + theme(plot.title = element_text(size =28, family = "Serif"))  +  scale_x_discrete(name = "Years", limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14)) + scale_fill_manual("legend", values = c("Excessive Moisture" = "red", "Frost" = "blue", "Freeze" = "gray")) + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=24, family = "Serif", face = "bold")) + scale_y_continuous(name = "Insurance claim loss ($)", label = unit_format(unit = "M", scale = 1e-6, digits = 0)) + theme(legend.position="bottom")


cherries <- palouse_sumloss_aggregate_cherries
#i <- interaction.plot(x.factor     = cherries$year,
#                 trace.factor = cherries$damagecause, 
#                 trace.label = "cherries",
#                 response     = cherries$loss, 
#                 fun = sum,
#                 las = 3,
#                 type="b",
#                 col=c("black","red","green"),  ### Colors for levels of trace var.
#                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
#                 fixed=TRUE,                    ### Order by factor order in data
#                 leg.bty = "n",
#                 ylab="",
#                 xlab="Year",
#                 main="Interaction Plot - CHERRIES Loss vs. year - top damage causes", las = 2)
           
#EDA for cherries
#-boxplots of data by cube loss by each of the three factors
par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 
boxplot(log10_loss ~ year, palouse_sumloss_aggregate_cherries, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_cherries$log10loss)
pts2 <- pretty(palouse_sumloss_aggregate_cherries$log10loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

title(main="Logrithmic transform: IPNW cherries insurance loss\nby year", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Years", line=5, cex.lab = 1.4)
title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)

stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_cherries, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

par(mar=c(12,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_cherries, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_cherries$log10loss)
pts2 <- pretty(palouse_sumloss_aggregate_cherries$log10loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

title(main="Logrithmic transform: IPNW cherries insurance loss\nby damage cause", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Damage cause", line=10, cex.lab = 1.4)
title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)


stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_cherries, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ county, palouse_sumloss_aggregate_cherries, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_cherries$log10loss)
pts2 <- pretty(palouse_sumloss_aggregate_cherries$log10loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

title(main="Logrithmic transform: IPNW cherries insurance loss\nby county", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Counties", line=5, cex.lab = 1.4)
title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)

stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_cherries, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

#---

library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("IPNW cherries insurance loss due to excessive moisture, frost, and freeze\n 2001 to 2015")
) 


#-All years

 pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_cherries_moisturefrostfreeze$", "loss", sep=""))))

map <- leaflet(data = county_cherries_moisturefrostfreeze, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_cherries_moisturefrostfreeze$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Cherries excessive moisture<br>frost freeze: 2001 to 2015", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_cherries_moisturefrostfreeze, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())


#markerOptions(riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

barplot(CHERRIES_damage_top_agg_moisturefrostfreeze$loss, names.arg = CHERRIES_damage_top_agg_moisturefrostfreeze$NAME, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
  
  pts <- pretty(CHERRIES_damage_top_agg_moisturefrostfreeze$loss / 1000000)
pts2 <- pretty(CHERRIES_damage_top_agg_moisturefrostfreeze$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))


title(main="IPNW cherries insurance loss due to \n excessive moisture, frost, and freeze: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Counties", line=7, cex.lab = 1.4)
title(ylab="Cherries insurance claim loss ($)", line=5, cex.lab = 1.4)

  
  #----
  
  library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("IPNW cherries insurance loss due to excessive moisture, frost, and freeze\n 2013")
) 

#--2013

 pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_cherries_moisturefrostfreeze2013$", "loss", sep=""))))

map <- leaflet(data = county_cherries_moisturefrostfreeze2013, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_cherries_moisturefrostfreeze2013$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Cherries excessive moisture<br>frost freeze: 2013", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_cherries_moisturefrostfreeze2013, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())



#markerOptions(riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

  barplot(CHERRIES_damage_top_agg_moisturefrostfreeze2013$loss, names.arg = CHERRIES_damage_top_agg_moisturefrostfreeze2013$NAME, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
  
pts <- pretty(CHERRIES_damage_top_agg_moisturefrostfreeze2013$loss / 1000000)
pts2 <- pretty(CHERRIES_damage_top_agg_moisturefrostfreeze2013$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))


title(main="IPNW cherries insurance loss due \nto excessive moisture, frost, and freeze 2013", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Counties", line=7, cex.lab = 1.4)
title(ylab="Cherries insurance claim loss ($)", line=5, cex.lab = 1.4)

  
  
  #---

library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("IPNW cherries insurance loss due to excessive moisture, frost, and freeze\n 2015")
) 
  
#--2015

pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_cherries_moisturefrostfreeze2015$", "loss", sep=""))))

map <- leaflet(data = county_cherries_moisturefrostfreeze2015, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_cherries_moisturefrostfreeze2015$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Cherries excessive moisture<br>frost freeze: 2015", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_cherries_moisturefrostfreeze2015, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())



#markerOptions(riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

barplot(CHERRIES_damage_top_agg_moisturefrostfreeze2015$loss, names.arg = CHERRIES_damage_top_agg_moisturefrostfreeze2015$NAME, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
  
pts <- pretty(CHERRIES_damage_top_agg_moisturefrostfreeze2015$loss / 1000000)
pts2 <- pretty(CHERRIES_damage_top_agg_moisturefrostfreeze2015$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))


title(main="IPNW cherries insurance loss due \nto excessive moisture, frost, and freeze 2015", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Counties", line=7, cex.lab = 1.4)
title(ylab="Cherries insurance claim loss ($)", line=5, cex.lab = 1.4)
```

<br></br>

![](https://dmine.io/waf/img/Step1.png)

<br></br>

##Step 14: DRY PEAS, 2001-2015 for the IPNW

```{r message=FALSE, warning=FALSE, error=TRUE,  fig.width = 10, fig.height = 7}

library(plotly)
library(gridExtra)

#pie chart for 2007-2015

options(scipen=999)

addNoAnswer <- function(x){
  if(is.factor(x)) return(factor(x, levels=c(levels(x), "No Answer")))
  return(x)
}

DRYPEAS <- subset(palouse_sumloss_aggregate, commodity == "DRY PEAS")

palouse_sumloss_1989_2015 <- aggregate(DRYPEAS$loss, list(DRYPEAS$damagecause), FUN = "sum")
colnames(palouse_sumloss_1989_2015) <- c("damagecause", "loss")

palouse_sumloss_2007_2015_aggregate <- palouse_sumloss_1989_2015[order(palouse_sumloss_1989_2015$loss),] 
X <- palouse_sumloss_2007_2015_aggregate[order(palouse_sumloss_2007_2015_aggregate$loss),] 
#colnames(X) <- c("damagecause", "loss")
summary_dataset <- X %>% filter(loss < 600000) 
summary_dataset2 <- X %>% filter(loss > 600000) 
colnames(summary_dataset) <- c("damagecause", "loss")
Y <- sum(summary_dataset$loss)
YY <- c("Other", Y)
YY <- data.frame(t(YY))
colnames(YY) <- c("damagecause", "loss")
YYY <- rbind(summary_dataset2, YY)
#factor(YYY)

YYY <- as.data.frame(lapply(YYY, addNoAnswer))
YYY$loss <- as.numeric(as.character(YYY$loss))
YYY1<- YYY[order(YYY$loss),] 
YYY1 <- YYY1[ nrow(YYY1):1, ]

p <- plot_ly(YYY, labels = ~damagecause, values = ~loss, type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste('$', loss, ' billions'),
             marker = list(colors = colors,
                           line = list(color = '#FFFFFF', width = 1)),
             #The 'pull' attribute can also be used to create space between the sectors
             showlegend = TRUE) %>%
  layout(title = 'Top Damage Causes for DRY PEAS, Palouse Region: 2001-2015',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))



#--interaction plot loss vs year for all damage causes, all Palouse counties


#p

YYY2 <- YYY1
levels(YYY2$damagecause)[8] <- "Excessive Moisture"
YYY2$loss <- round(YYY2$loss, digits = 0)
YYY2$loss <- format(YYY2$loss,big.mark=",",scientific=FALSE)
YYY2$loss <- paste("$", YYY2$loss, sep="")
YYY2$loss <- gsub(" ", "", YYY2$loss, fixed = TRUE)

#--year
palouse_sumloss_year <- aggregate(DRYPEAS$loss, list(DRYPEAS$year), FUN = "sum")
colnames(palouse_sumloss_year) <- c("year", "loss")

#--county

palouse_sumloss_county <- aggregate(DRYPEAS$loss, list(DRYPEAS$county), FUN = "sum")
colnames(palouse_sumloss_county) <- c("county", "loss")

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(palouse_sumloss_county$loss, names.arg = palouse_sumloss_county$county, cex.names = 1.4, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(palouse_sumloss_county$loss / 1000000)
pts2 <- pretty(palouse_sumloss_county$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 8)

title(main="IPNW dry peas insurance loss by commodity: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Counties", line=8, cex.lab = 1.4)
title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)

par(mar=c(12.5, 6.1, 4, 2.1), family = 'serif', mgp=c(4, 1, 0), las=0)
barplot(palouse_sumloss_year$loss, names.arg = palouse_sumloss_year$year, cex.names = 1.4, las = 3, yaxt="n",  col = "lightblue")
pts <- pretty(palouse_sumloss_year$loss / 1000000)
pts2 <- pretty(palouse_sumloss_year$loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, "M", sep = ""))

#mtext(text = "Years",
#      side = 1,#side 1 = bottom
#      line = 8)

title(main="IPNW dry peas insurance loss by year: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Years", line=8, cex.lab = 1.4)
title(ylab="Insurance claim loss ($)", line=4, cex.lab = 1.4)

par(mar=c(12.8, 6.1, 6, 2.1), family = "serif", mgp=c(4, 1, 0), las=0)
levels(YYY1$damagecause)[8] <- "Excessive Moisture"

barplot(YYY1$loss, names.arg = YYY1$damagecause, las = 3, cex.names = 1.4, yaxt="n", col = "lightblue")
pts <- pretty(YYY$loss / 1000000)
pts2 <- pretty(YYY$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))


title(main=" IPNW dry peas insurance loss by damage cause: 2001 to 2015", line = 2, adj = 0, cex.main = 1.9)
title(xlab="Damage Cause", line=11.5, cex.lab = 1.4)
title(ylab="Dry peas insurance claim loss ($)", line=5, cex.lab = 1.4)

#mtext(text = "Damage Cause",
#      side = 1,#side 1 = bottom
#      line = 10)

htmlTable(YYY2,
          cgroup = c("2001-2015"),
         caption = "IPNW region DRY PEAS total insurance loss by damage cause, 2001-2015",
          align = "c",
          rnames = FALSE,
          css.cell = "padding-left: .5em; padding-right: .5em;")
```



```{r message=FALSE, warning=FALSE, error=TRUE,  fig.width = 10, fig.height = 7}


DRYPEAS <- subset(sumloss_palouse_sum, commodity == "DRY PEAS")



levels(DRYPEAS$damagecause)[8] <- "Excessive Moisture"
DRYPEAS$damagecause <- factor(DRYPEAS$damagecause)

DRYPEAS_damage <- subset(DRYPEAS, damagecause == "Drought" | damagecause == "Heat" | damagecause == "Excessive Moisture" | damagecause == "Hail" | damagecause == "Cold Wet Weather" | damagecause == "Decline in Price" | damagecause == "Frost" | damagecause == "Wind/Excess Wind")
DRYPEAS_damage$damagecause <- factor(DRYPEAS_damage$damagecause)


DRYPEAS_damage_top <- subset(DRYPEAS_damage, damagecause == "Excessive Moisture" | damagecause == "Drought"  | damagecause == "Heat")


DRYPEAS_damage_droughtheat2001_2015 <- subset(DRYPEAS_damage, damagecause == "Drought"  | damagecause == "Heat")
DRYPEAS_damage_top_agg_droughtheat2001_2015 <- aggregate(DRYPEAS_damage_droughtheat2001_2015$loss, by = list(DRYPEAS_damage_droughtheat2001_2015$county), FUN = "sum")
colnames(DRYPEAS_damage_top_agg_droughtheat2001_2015) <- c("NAME", "loss")

county_drypeas_droughtheat2001_2015 <- merge(counties, DRYPEAS_damage_top_agg_droughtheat2001_2015, by = "NAME")


#ggplot(DRYPEAS_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
#    geom_bar( stat="identity") + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + ggtitle("DRY PEAS Loss vs. year - top damage causes") + theme(plot.title = element_text(hjust = 0.5)) +  scale_x_discrete(limits=c(2001:2015)) + scale_y_continuous(label = unit_format(unit = "M", scale = 1e-6, digits = 0))

DRYPEAS_damage_top$damagecause <- factor(DRYPEAS_damage_top$damagecause, levels = c("Excessive Moisture", "Heat", "Drought"))



DRYPEAS_damage_droughtheat2015 <- subset(DRYPEAS_damage, damagecause == "Drought"  | damagecause == "Heat")
DRYPEAS_damage_droughtheat2015 <- subset(DRYPEAS_damage_droughtheat2015, year == 2015)


DRYPEAS_damage_top_agg_droughtheat2015 <- aggregate(DRYPEAS_damage_droughtheat2015$loss, by = list(DRYPEAS_damage_droughtheat2015$county), FUN = "sum")
colnames(DRYPEAS_damage_top_agg_droughtheat2015) <- c("NAME", "loss")

county_drypeas_droughtheat2015 <- merge(counties, DRYPEAS_damage_top_agg_droughtheat2015, by = "NAME")



DRYPEAS_damage_excessivemoisture2011 <- subset(DRYPEAS_damage, damagecause == "Excessive Moisture")
DRYPEAS_damage_excessivemoisture2011 <- subset(DRYPEAS_damage_excessivemoisture2011, year == 2011)

DRYPEAS_damage_top_agg_excessivemoisture2011 <- aggregate(DRYPEAS_damage_excessivemoisture2011$loss, by = list(DRYPEAS_damage_excessivemoisture2011$county), FUN = "sum")
colnames(DRYPEAS_damage_top_agg_excessivemoisture2011) <- c("NAME", "loss")

county_drypeas_excessivemoisture2011 <- merge(counties, DRYPEAS_damage_top_agg_excessivemoisture2011, by = "NAME")



par(mar = c(5, 5, 4, 1), family = 'serif')

ggplot(DRYPEAS_damage_top, aes(fill=damagecause, y=loss, x=year)) + 
    geom_bar( stat="identity") + theme_bw() + theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) + ggtitle("IPNW dry peas loss vs. year - top damage causes") + theme(axis.title.y = element_text(family = "Serif", size=16), axis.title.x = element_text(family = "Serif", size = 16), axis.text.x = element_text(size=rel(1.5), angle = 90, hjust = 1, family = "Serif")) + theme(plot.title = element_text(size =28, family = "Serif"))  +  scale_x_discrete(name = "Years", limits=c(2001:2015)) + theme(legend.text=element_text(family = "Serif", size=14)) + scale_fill_manual("legend", values = c("Excessive Moisture" = "gray", "Heat" = "blue", "Drought" = "red")) + theme(legend.title=element_text(family = "Serif", size=16, face = "bold")) + theme(plot.title = element_text(size=24, family = "Serif", face = "bold")) + scale_y_continuous(name = "Insurance claim loss ($)", label = unit_format(unit = "M", scale = 1e-6, digits = 0)) + theme(legend.position="bottom")

drypeas <- palouse_sumloss_aggregate_drypeas
#i <- interaction.plot(x.factor     = drypeas$year,
#                 trace.factor = drypeas$damagecause, 
#                 trace.label = "dry peas",
#                 response     = drypeas$loss, 
#                 fun = sum,
#                 las = 3,
#                 type="b",
#                 col=c("black","red","green"),  ### Colors for levels of trace var.
#                 pch=c(19, 17, 15, 14, 13),             ### Symbols for levels of trace var.
#                 fixed=TRUE,                    ### Order by factor order in data
#                 leg.bty = "n",
#                 ylab="",
#                 xlab="Year",
#                 main="Interaction Plot - DRY PEAS Loss vs. year - top damage causes", las = 2)

#EDA for dry peas
#-boxplots of data by cube loss by each of the three factors
par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ year, palouse_sumloss_aggregate_drypeas, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_drypeas$log10_loss)
pts2 <- pretty(palouse_sumloss_aggregate_drypeas$log10_loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

title(main="Logrithmic transform: IPNW dry peas insurance loss\nby year", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Years", line=5, cex.lab = 1.4)
title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)

stripchart(log10_loss ~ year, data = palouse_sumloss_aggregate_drypeas, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

par(mar=c(12,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ damagecause, palouse_sumloss_aggregate_drypeas, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_drypeas$log10_loss)
pts2 <- pretty(palouse_sumloss_aggregate_drypeas$log10_loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

title(main="Logrithmic transform: IPNW dry peas insurance loss\nby damage cause", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Damage cause", line=9, cex.lab = 1.4)
title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)

stripchart(log10_loss ~ damagecause, data = palouse_sumloss_aggregate_drypeas, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

par(mar=c(12,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

boxplot(log10_loss ~ county, palouse_sumloss_aggregate_drypeas,yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)

pts <- pretty(palouse_sumloss_aggregate_drypeas$log10_loss)
pts2 <- pretty(palouse_sumloss_aggregate_drypeas$log10_loss)
axis(2, las = 1, at = pts2, cex.axis = 1.4, labels = paste(pts, sep = ""))

title(main="Logrithmic transform: IPNW dry peas insurance loss\nby damage cause", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Counties", line=7, cex.lab = 1.4)
title(ylab="Log10 insurance claim loss ($)", line=4, cex.lab = 1.4)


stripchart(log10_loss ~ county, data = palouse_sumloss_aggregate_drypeas, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

#---

library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("IPNW dry peas insurance loss due to drought and heat\n 2001 to 2015")
) 


#-All years

 pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_drypeas_droughtheat2001_2015$", "loss", sep=""))))

map <- leaflet(data = county_drypeas_droughtheat2001_2015, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_drypeas_droughtheat2001_2015$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Dry peas drought<br>heat: 2001 to 2015", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_drypeas_droughtheat2001_2015, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())


#markerOptions(riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

barplot(DRYPEAS_damage_top_agg_droughtheat2001_2015$loss, names.arg = DRYPEAS_damage_top_agg_droughtheat2001_2015$NAME, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
  
  pts <- pretty(DRYPEAS_damage_top_agg_droughtheat2001_2015$loss / 1000000)
pts2 <- pretty(DRYPEAS_damage_top_agg_droughtheat2001_2015$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))


title(main="IPNW dry peas insurance loss due to \n drought and heat: 2001 to 2015", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Counties", line=7, cex.lab = 1.4)
title(ylab="Dry peas insurance claim loss ($)", line=5, cex.lab = 1.4)

  
  #----
  
  library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("IPNW cherries insurance loss due to excessive moisture, frost, and freeze\n 2013")
) 

#--2011

 pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_drypeas_excessivemoisture2011$", "loss", sep=""))))

map <- leaflet(data = county_drypeas_excessivemoisture2011, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_drypeas_excessivemoisture2011$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Dry peas excessive<br>moisture 2011", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_drypeas_excessivemoisture2011, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())



#markerOptions(riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

  barplot(DRYPEAS_damage_excessivemoisture2011$loss, names.arg = DRYPEAS_damage_excessivemoisture2011$county, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
  
pts <- pretty(DRYPEAS_damage_excessivemoisture2011$loss / 1000000)
pts2 <- pretty(DRYPEAS_damage_excessivemoisture2011$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))


title(main="IPNW dry peas insurance loss due \nto excessive moisture: 2011", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Counties", line=7, cex.lab = 1.4)
title(ylab="Dry peas insurance claim loss ($)", line=5, cex.lab = 1.4)

  
  
  #---

library(htmltools)
  
  tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 16px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("IPNW dry peas insurance loss due to drought and heat\n 2015")
) 
  
#--2015

pal <- colorNumeric(colorRampPalette(c("lightyellow", "yellow", "orange", "red"))(11), na.color = "#ffffff",
                      domain = eval(parse(text=paste("county_drypeas_droughtheat2015$", "loss", sep=""))))

map <- leaflet(data = county_drypeas_droughtheat2015, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.1)) %>%  
  addProviderTiles(providers$Hydda.Base) %>%
   addProviderTiles(providers$Stamen.TonerLines) %>%
  
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    position = 'topleft', 
    width = 200, height = 200,
    toggleDisplay = FALSE) %>%
  
  
   #addControl(title, position = "topleft", className="map-title") %>%
  
  
  fitBounds(exte[1], exte[3], exte[2], exte[4]) %>% addPolygons(fillColor = ~pal(county_drypeas_droughtheat2015$loss),  fillOpacity = .8, weight = 1, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% addPolygons(data = states, fillOpacity = 0, weight = 4, stroke = TRUE, smoothFactor = 0.5, color = "black") %>% 
  
    addLegend(pal = pal, values = na.omit(~loss), group = "circles", title = paste("Dry peas drought<br>heat: 2015", sep = ""), na.label = "", position = "topright", labFormat = labelFormat(prefix = "$")) %>%


addLabelOnlyMarkers(data = county_drypeas_droughtheat2015, lng = lat_long[,1], lat = lat_long[,2], label = lapply(labs, HTML), labelOptions = labelOptions(style = list("font-family" = "serif"), noHide = TRUE, direction = 'middle', textOnly = TRUE, textsize = "18px", col = "white",  offset = c(20, 0), markerOptions(riseOnHover = TRUE)
)) 
        
addScaleBar(map, position = c("topright"), options = scaleBarOptions())



#markerOptions(riseOnHover = TRUE)
 # addLegend(colors = ~NAME, labels = ~NAME, values = ~NAME, opacity = 0.5, title = NULL,
  #          position = "bottomright")

par(mar=c(10,8,6,2), family = 'serif', mgp = c(5, 1, 0)) 

barplot(DRYPEAS_damage_top_agg_droughtheat2015$loss, names.arg = DRYPEAS_damage_top_agg_droughtheat2015$NAME, yaxt = 'n', col = "lightblue", las = 3, cex.main = 1.5, cex.lab = 1.4, cex.axis = 1.4, cex.names = 1.4, font.lab = 1, font.axis = 1, outline = FALSE)
  
pts <- pretty(DRYPEAS_damage_top_agg_droughtheat2015$loss / 1000000)
pts2 <- pretty(DRYPEAS_damage_top_agg_droughtheat2015$loss)
axis(2, las = 1, at = pts2, labels = paste(pts, "M", sep = ""))


title(main="IPNW dry peas insurance loss due \nto drought and heat 2015", line = 2, cex.main = 1.9, adj = 0)
title(xlab="Counties", line=7, cex.lab = 1.4)
title(ylab="Dry peas insurance claim loss ($)", line=5, cex.lab = 1.4)


           
```

